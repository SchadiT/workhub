<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Turbo Projects Work Hub v15.2.3</title>
    <!-- JSZip Library for WhatsApp export ZIP files -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <!-- SheetJS Library for Excel generation (Bar Staffing) -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <!-- MSAL Auth Library - Multiple fallbacks -->
    <script>
        window.msalLoaded = false;
        function msalLoadSuccess() { window.msalLoaded = true; console.log(' MSAL loaded'); }
        function tryNextCDN(cdnList, index) {
            if (index >= cdnList.length) {
                console.error(' All CDNs failed');
                document.getElementById('auth-status-text').textContent = ' Auth Library fehlt';
                return;
            }
            var s = document.createElement('script');
            s.src = cdnList[index];
            s.onload = msalLoadSuccess;
            s.onerror = function() { 
                console.log('CDN ' + (index+1) + ' failed: ' + cdnList[index]);
                tryNextCDN(cdnList, index + 1);
            };
            document.head.appendChild(s);
        }
    </script>
    <script src="https://unpkg.com/@azure/msal-browser@2.38.3/lib/msal-browser.min.js" onload="msalLoadSuccess()" onerror="tryNextCDN([
        'https://cdn.jsdelivr.net/npm/@azure/msal-browser@2.38.3/lib/msal-browser.min.js',
        'https://alcdn.msauth.net/browser/2.38.3/js/msal-browser.min.js',
        'https://cdnjs.cloudflare.com/ajax/libs/msal-browser/2.38.3/msal-browser.min.js'
    ], 0)"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            padding: 20px;
            color: #fff;
        }
        /* Header Container - Clean Modern Style */
        .header-container {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 15px;
        }
        .header-box {
            background: #000000;
            border: 2px solid #ffffff;
            border-radius: 8px;
            padding: 12px 24px;
        }
        .header-text {
            font-size: 20px;
            font-weight: 600;
            color: #ffffff;
        }
        
        /* Auth Status Bar - Clean Minimal Style */
        .auth-bar {
            display: flex; justify-content: center; align-items: center; gap: 12px;
            margin-bottom: 15px;
        }
        .auth-status { display: flex; align-items: center; gap: 6px; font-size: 12px; color: #6b7280; }
        .auth-status .dot { width: 6px; height: 6px; border-radius: 50%; background: #ef4444; }
        .auth-status .dot.connected { background: #22c55e; }
        .auth-buttons { display: flex; gap: 8px; }
        .auth-btn {
            background: #ffffff;
            border: none;
            border-radius: 6px;
            padding: 6px 16px;
            color: #1f1f2e; font-size: 11px; font-weight: 600; cursor: pointer;
            transition: all 0.2s;
            display: flex; align-items: center; justify-content: center; gap: 5px;
            white-space: nowrap;
        }
        .auth-btn:hover { background: #e5e5e5; }
        .auth-btn.logout { background: #e2e8f0; }
        .auth-btn.reset { 
            background: #e2e8f0;
            padding: 6px 12px;
        }
        .auth-btn.reset:hover { background: #d1d5db; }
        .auth-user { font-size: 11px; color: #6b7280; }
        
        /* Quick Actions */
        .quick-actions { display: grid; grid-template-columns: repeat(5, 1fr); gap: 6px; margin-bottom: 6px; }
        .quick-actions-row2 { display: grid; grid-template-columns: repeat(2, 1fr); gap: 6px; margin-bottom: 6px; }
        
        /* Tools Expander */
        .tools-expander {
            margin-bottom: 12px;
        }
        .tools-toggle {
            width: 100%;
            background: #2d2d3d;
            border: 1px solid #3d3d4d;
            border-radius: 8px; padding: 10px 16px;
            color: white; font-weight: 500; font-size: 13px; cursor: pointer;
            display: flex; justify-content: center; align-items: center; gap: 10px;
            transition: all 0.2s;
        }
        .tools-toggle:hover {
            background: #3d3d4d;
            border-color: #8b5cf6;
        }
        .tools-toggle .arrow {
            transition: transform 0.3s ease;
            font-size: 12px;
        }
        .tools-toggle.open .arrow {
            transform: rotate(180deg);
        }
        .tools-content {
            display: none;
            background: #1f1f2e;
            border-radius: 8px;
            padding: 10px;
            margin-top: 6px;
            border: 1px solid #3d3d4d;
        }
        .tools-content.show {
            display: block;
            animation: slideDown 0.3s ease;
        }
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .tools-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(110px, 1fr));
            gap: 8px;
        }
        .tool-btn {
            background: #2d2d3d;
            border: 1px solid #3d3d4d;
            border-radius: 8px;
            padding: 10px 8px;
            color: white;
            text-align: center;
            font-weight: 500;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .tool-btn:hover {
            background: #3d3d4d;
        }
        /* Colored Border Classes */
        .tool-btn.border-blue { border: 2px solid #3b82f6; }
        .tool-btn.border-blue:hover { border-color: #60a5fa; background: #3d3d4d; }
        .tool-btn.border-white { border: 2px solid #ffffff; }
        .tool-btn.border-white:hover { border-color: #e5e5e5; background: #3d3d4d; }
        .tool-btn.border-green { border: 2px solid #22c55e; }
        .tool-btn.border-green:hover { border-color: #4ade80; background: #3d3d4d; }
        .tool-btn.border-red { border: 2px solid #ef4444; }
        .tool-btn.border-red:hover { border-color: #f87171; background: #3d3d4d; }
        .tool-btn .tool-icon {
            display: block;
            font-size: 18px;
            margin-bottom: 2px;
        }
        
        .quick-btn {
            background: #2d2d3d;
            border: 1px solid #3d3d4d;
            border-radius: 8px; padding: 10px 8px;
            color: white; text-decoration: none; text-align: center;
            font-weight: 500; font-size: 12px; cursor: pointer;
            transition: all 0.2s; display: block;
        }
        .quick-btn:hover { 
            background: #3d3d4d; 
            border-color: #8b5cf6;
        }
        
        .dropdown-container { position: relative; }
        .dropdown-btn { background: #2d2d3d; border: 1px solid #3d3d4d; width: 100%; }
        .dropdown-btn.sales { background: #2d2d3d; border: 1px solid #3d3d4d; }
        .dropdown-content {
            display: none; position: absolute; top: 100%; left: 0; right: 0;
            background: #252542; border-radius: 8px; margin-top: 5px; z-index: 100;
            overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        .dropdown-content.show { display: block; }
        .dropdown-item {
            display: block; padding: 12px 15px; color: white; text-decoration: none;
            font-size: 13px; border-bottom: 1px solid #3d3d54; transition: background 0.2s;
        }
        .dropdown-item:last-child { border-bottom: none; }
        .dropdown-item:hover { background: #3d3d54; }
        .dropdown-item .icon { margin-right: 8px; }
        
        /* Modal Styles */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.8); z-index: 1000; justify-content: center; align-items: flex-start;
            overflow-y: auto; padding: 20px;
        }
        .modal-overlay.show { display: flex; }
        .modal {
            background: #252542; border-radius: 15px; width: 100%; max-width: 800px;
            margin: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }
        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 15px 20px; display: flex; justify-content: space-between; align-items: center;
            border-radius: 15px 15px 0 0;
        }
        .modal-header.orange { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }
        .modal-header.purple { background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); }
        .modal-header.green { background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); }
        .modal-header.blue { background: linear-gradient(135deg, #0078d4 0%, #106ebe 100%); }
        .modal-header h3 { font-size: 18px; font-weight: 700; }
        .modal-close { background: none; border: none; color: white; font-size: 18px; cursor: pointer; line-height: 1; opacity: 0.7; transition: opacity 0.2s; }
        .modal-close:hover { opacity: 1; }
        .modal-body { padding: 20px; max-height: 70vh; overflow-y: auto; }
        .modal-footer { padding: 15px 20px; border-top: 1px solid #3d3d54; display: flex; justify-content: flex-end; gap: 10px; }
        
        /* Form Styles */
        .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 15px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; font-size: 13px; color: #888; margin-bottom: 5px; font-weight: 600; }
        .form-group input, .form-group textarea, .form-group select {
            width: 100%; padding: 10px 12px; border-radius: 8px;
            border: 1px solid #3d3d54; background: #1a1a2e; color: #fff;
            font-size: 14px; font-family: inherit;
        }
        .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
            outline: none; border-color: #667eea;
        }
        .form-group input[type="number"] { text-align: right; }
        .form-group .time-input { width: 80px; text-align: center; font-weight: 600; }
        .form-group textarea { min-height: 100px; resize: vertical; }
        .form-group-inline { display: flex; align-items: center; gap: 10px; }
        .form-hint { font-size: 11px; color: #666; margin-top: 4px; }
        
        .modal-btn {
            padding: 10px 20px; border-radius: 8px; font-size: 14px; font-weight: 600;
            cursor: pointer; border: none; transition: all 0.2s;
        }
        .modal-btn.cancel { background: #3d3d54; color: #fff; }
        .modal-btn.primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #fff; }
        .modal-btn.success { background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); color: #fff; }
        .modal-btn:hover { opacity: 0.9; transform: translateY(-1px); }
        
        /* Result Cards */
        .result-card {
            background: #1a1a2e; border-radius: 10px; padding: 15px; margin-bottom: 15px;
            border: 1px solid #3d3d54;
        }
        .result-card h4 { font-size: 14px; color: #888; margin-bottom: 10px; text-transform: uppercase; }
        .result-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; }
        .result-item { text-align: center; padding: 10px; background: #252542; border-radius: 8px; }
        .result-item .label { font-size: 11px; color: #888; margin-bottom: 4px; }
        .result-item .value { font-size: 18px; font-weight: 700; color: #22c55e; }
        .result-item .value.blue { color: #3b82f6; }
        .result-item .value.orange { color: #f59e0b; }
        .result-item .value.red { color: #ef4444; }
        
        /* Phase Table */
        .phase-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .phase-table th, .phase-table td {
            padding: 10px; text-align: left; border-bottom: 1px solid #3d3d54;
        }
        .phase-table th { color: #888; font-size: 12px; font-weight: 600; text-transform: uppercase; }
        .phase-table td { font-size: 14px; }
        .phase-table input {
            width: 80px; padding: 6px 8px; border-radius: 6px; border: 1px solid #3d3d54;
            background: #1a1a2e; color: #fff; font-size: 13px; text-align: right;
        }
        .phase-table .phase-name { color: #667eea; font-weight: 600; }
        .phase-table .phase-revenue { color: #22c55e; font-weight: 600; }
        
        /* Factsheet Preview */
        .factsheet-preview {
            background: white; color: #333; padding: 30px; border-radius: 8px;
            font-family: Arial, sans-serif; font-size: 14px;
        }
        .factsheet-preview h2 { color: #333; margin-bottom: 5px; }
        .factsheet-preview .event-name { color: #ef4444; font-weight: bold; }
        .factsheet-preview table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .factsheet-preview th, .factsheet-preview td {
            border: 1px solid #333; padding: 8px; text-align: left;
        }
        .factsheet-preview th { background: #f0f0f0; }
        
        /* Upcoming Events */
        .upcoming-events-section { margin-bottom: 20px; }
        .upcoming-section-header {
            background: linear-gradient(135deg, #1e3a5f 0%, #1a1a2e 100%);
            border: 2px solid #ef4444;
            border-radius: 15px 15px 0 0;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            user-select: none;
        }
        .upcoming-section-header:hover { background: linear-gradient(135deg, #234b73 0%, #1f1f2e 100%); }
        .upcoming-section-header.collapsed { border-radius: 15px; }
        .upcoming-title-row { display: flex; align-items: center; gap: 10px; }
        .upcoming-title { font-size: 18px; font-weight: 700; color: #fff; }
        .upcoming-toggle { font-size: 12px; color: #888; transition: transform 0.3s; }
        .upcoming-toggle.open { transform: rotate(180deg); }
        #upcoming-events-container {
            background: linear-gradient(135deg, #1e3a5f 0%, #1a1a2e 100%);
            border: 2px solid #ef4444;
            border-top: none;
            border-radius: 0 0 15px 15px;
            padding: 15px;
        }
        .upcoming-collapsed { display: none; }
        .upcoming-expanded { display: block; }
        .upcoming-placeholder { text-align: center; padding: 30px; color: #888; background: rgba(255,255,255,0.02); border-radius: 8px; }
        .upcoming-placeholder p { margin: 0 0 8px 0; font-size: 14px; }
        .upcoming-placeholder small { font-size: 12px; color: #666; }
        .upcoming-count { background: #ef4444; color: white; padding: 2px 8px; border-radius: 10px; font-size: 12px; }
        
        /* Individual Event Card - Collapsible */
        .upcoming-event-card {
            background: linear-gradient(135deg, #252542 0%, #1a1a2e 100%);
            border-radius: 10px;
            margin-bottom: 10px;
            overflow: hidden;
            border: 1px solid #3d3d54;
        }
        .upcoming-event-card:last-child { margin-bottom: 0; }
        .upcoming-event-card.eigen { border-left: 3px solid #22c55e; }
        .upcoming-event-card.fremd { border-left: 3px solid #f59e0b; }
        .upcoming-event-card.konzert { border-left: 3px solid #8b5cf6; }
        .upcoming-event-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            cursor: pointer;
            user-select: none;
        }
        .upcoming-event-header:hover { background: rgba(255,255,255,0.03); }
        .upcoming-event-left { display: flex; align-items: center; gap: 12px; }
        .upcoming-event-date-badge {
            background: #3d3d54;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            color: #888;
            min-width: 65px;
            text-align: center;
        }
        .upcoming-event-name { font-weight: 700; font-size: 15px; color: white; }
        .upcoming-event-name.eigen { color: #22c55e; }
        .upcoming-event-name.fremd { color: #f59e0b; }
        .upcoming-event-name.konzert { color: #8b5cf6; }
        .upcoming-event-right { display: flex; align-items: center; gap: 10px; }
        .upcoming-event-days { font-size: 11px; font-weight: 600; }
        .upcoming-event-type { font-size: 10px; padding: 3px 8px; border-radius: 4px; font-weight: 600; }
        .upcoming-event-type.eigen { background: #22c55e; color: white; }
        .upcoming-event-type.fremd { background: #f59e0b; color: white; }
        .upcoming-event-type.konzert { background: #8b5cf6; color: white; }
        .upcoming-event-toggle { color: #888; font-size: 10px; transition: transform 0.3s; }
        .upcoming-event-card.open .upcoming-event-toggle { transform: rotate(180deg); }
        .upcoming-event-content {
            display: none;
            padding: 0 15px 15px 15px;
            border-top: 1px solid #3d3d54;
        }
        .upcoming-event-card.open .upcoming-event-content { display: block; }
        
        .upcoming-event { background: rgba(255,255,255,0.03); border-radius: 10px; padding: 12px 15px; margin-bottom: 10px; border-left: 3px solid #3b82f6; cursor: pointer; transition: all 0.2s; }
        .upcoming-event:hover { background: rgba(255,255,255,0.05); }
        .upcoming-week-label { font-size: 14px; font-weight: 600; color: #888; margin-bottom: 10px; padding-left: 5px; }
        .upcoming-week-label.current { color: #ef4444; }
        
        .event-card {
            background: linear-gradient(135deg, #252542 0%, #1a1a2e 100%);
            border-radius: 12px; margin-bottom: 12px; overflow: hidden; border: 1px solid #3d3d54;
        }
        .event-card-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px 15px; cursor: pointer; user-select: none;
        }
        .event-card-header:hover { background: rgba(255,255,255,0.03); }
        .event-main-info { display: flex; align-items: center; gap: 12px; }
        .event-date {
            background: #3d3d54; padding: 6px 10px; border-radius: 6px;
            font-weight: 700; font-size: 13px; min-width: 70px; text-align: center;
        }
        .event-name { font-weight: 600; font-size: 16px; }
        .event-tech { background: #757575; color: white; padding: 3px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; }
        .event-quick-stats { display: flex; align-items: center; gap: 15px; font-size: 13px; color: #888; }
        .event-toggle { color: #888; font-size: 12px; transition: transform 0.3s; }
        .event-card.open .event-toggle { transform: rotate(180deg); }
        .event-details { display: none; padding: 0 15px 15px 15px; border-top: 1px solid #3d3d54; }
        .event-card.open .event-details { display: block; }
        
        /* Calendar Section */
        .calendar-section { margin-bottom: 20px; }
        .calendar-section-header {
            background: linear-gradient(135deg, #1e3a5f 0%, #1a1a2e 100%);
            border: 2px solid #3b82f6;
            border-radius: 15px 15px 0 0;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            user-select: none;
        }
        .calendar-section-header:hover { background: linear-gradient(135deg, #234b73 0%, #1f1f2e 100%); }
        .calendar-section-header.collapsed { border-radius: 15px; }
        .calendar-title-row { display: flex; align-items: center; gap: 10px; }
        .calendar-title { font-size: 18px; font-weight: 700; color: #fff; }
        .calendar-toggle { font-size: 12px; color: #888; transition: transform 0.3s; }
        .calendar-toggle.open { transform: rotate(180deg); }
        #calendar-container {
            background: linear-gradient(135deg, #1e3a5f 0%, #1a1a2e 100%);
            border: 2px solid #3b82f6;
            border-top: none;
            border-radius: 0 0 15px 15px;
            padding: 15px;
        }
        .calendar-collapsed { display: none; }
        .calendar-expanded { display: block; }
        .calendar-filters {
            display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 15px;
            padding-bottom: 12px; border-bottom: 1px solid #3d3d54;
        }
        .calendar-filter-item {
            display: flex; align-items: center; gap: 6px;
            font-size: 12px; color: #ccc; cursor: pointer;
        }
        .calendar-filter-item input[type="checkbox"] {
            width: 14px; height: 14px; cursor: pointer;
        }
        .calendar-filter-item .filter-dot {
            width: 10px; height: 10px; border-radius: 50%;
        }
        .filter-dot.eigen { background: #22c55e; }
        .filter-dot.fremd { background: #3b82f6; }
        .filter-dot.konzert { background: #8b5cf6; }
        .filter-dot.bmt { background: #f59e0b; }
        .filter-dot.technik { background: #a16207; }
        .filter-dot.outlook { background: #6b7280; }
        .filter-dot.feiertag { background: #ef4444; }
        .calendar-nav {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 12px;
        }
        .calendar-nav-btn {
            background: #3d3d54; border: none; color: white;
            padding: 6px 12px; border-radius: 6px; cursor: pointer;
            font-size: 12px; font-weight: 600;
        }
        .calendar-nav-btn:hover { background: #4d4d64; }
        .calendar-month-title { font-size: 16px; font-weight: 700; color: #fff; }
        .calendar-grid {
            display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px;
        }
        .calendar-day-header {
            text-align: center; font-size: 11px; font-weight: 600;
            color: #888; padding: 8px 0;
        }
        .calendar-day {
            min-height: 70px; background: #252542; border-radius: 4px;
            padding: 4px; font-size: 11px; position: relative;
        }
        .calendar-day.other-month { opacity: 0.4; }
        .calendar-day.today { border: 2px solid #3b82f6; }
        .calendar-day-number {
            font-weight: 600; color: #aaa; font-size: 11px;
            position: absolute; top: 2px; right: 4px;
        }
        .calendar-day.today .calendar-day-number { color: #3b82f6; }
        .calendar-entry {
            font-size: 10px; padding: 2px 4px; border-radius: 2px;
            margin-top: 1px; overflow: hidden; text-overflow: ellipsis;
            white-space: nowrap; cursor: pointer; line-height: 1.3;
        }
        .calendar-entry.eigen { background: #22c55e; color: #fff; }
        .calendar-entry.fremd { background: #3b82f6; color: #fff; }
        .calendar-entry.konzert { background: #8b5cf6; color: #fff; }
        .calendar-entry.bmt { background: #f59e0b; color: #000; }
        .calendar-entry.technik { background: #a16207; color: #fff; }
        .calendar-entry.outlook { background: #6b7280; color: #fff; }
        .calendar-entry.feiertag { background: #ef4444; color: #fff; }
        .calendar-entry:hover { opacity: 0.8; }
        
        /* Native Shiftplan Table */
        .shiftplan-table-container {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            background: #1a1a2e;
            padding: 8px;
            border-radius: 8px;
        }
        .shiftplan-table {
            width: 100%;
            min-width: 500px;
            border-collapse: collapse;
            font-size: 12px;
            color: #fff;
        }
        .shiftplan-table th {
            background: #43A047;
            color: white;
            padding: 8px 6px;
            text-align: left;
            font-weight: 600;
            font-size: 11px;
            white-space: nowrap;
        }
        .shiftplan-table td {
            padding: 6px;
            border-bottom: 1px solid #3d3d54;
            white-space: nowrap;
        }
        .shiftplan-table tr:hover { background: rgba(255,255,255,0.05); }
        .shiftplan-table .date-col { font-weight: 600; color: #43A047; }
        .shiftplan-table .event-col { color: #888; max-width: 120px; overflow: hidden; text-overflow: ellipsis; }
        .shiftplan-table .cvd-col { color: #f59e0b; font-weight: 600; }
        .shiftplan-table .runner-col { color: #fff; }
        .shiftplan-table .technik-col { color: #a78bfa; font-weight: 600; }
        @media (max-width: 600px) {
            .shiftplan-table { font-size: 10px; }
            .shiftplan-table th, .shiftplan-table td { padding: 4px 3px; }
            .shiftplan-table .date-col { min-width: 55px; }
            .shiftplan-table .event-col { max-width: 80px; }
        }
        
        /* VVK Tracker */
        .vvk-tracker {
            background: linear-gradient(135deg, #1e3a5f 0%, #1a1a2e 100%);
            border: 1px solid #f59e0b; border-radius: 10px; padding: 12px 15px; margin-bottom: 12px;
        }
        .vvk-input-row { display: flex; align-items: center; gap: 6px; margin-bottom: 10px; flex-wrap: wrap; }
        .vvk-input-row label { font-size: 12px; font-weight: 600; color: #f59e0b; }
        .vvk-input-row input {
            width: 60px; padding: 6px 8px; border-radius: 6px; border: 1px solid #3d3d54;
            background: #1a1a2e; color: #fff; font-size: 14px; font-weight: 700; text-align: center;
        }
        .vvk-input-row input:focus { outline: none; border-color: #f59e0b; }
        .vvk-days { background: #3d3d54; padding: 6px 12px; border-radius: 6px; font-size: 12px; font-weight: 600; color: #888; }
        .vvk-progress-bar { height: 8px; background: #3d3d54; border-radius: 4px; overflow: hidden; margin-bottom: 8px; }
        .vvk-progress { height: 100%; background: linear-gradient(90deg, #ef4444 0%, #f59e0b 50%, #22c55e 100%); border-radius: 4px; transition: width 0.3s ease; }
        .vvk-benchmark { font-size: 11px; color: #888; text-align: center; }
        
        .auto-projection {
            background: linear-gradient(135deg, #1e3a5f 0%, #1a1a2e 100%);
            border: 1px solid #3b82f6; border-radius: 10px; padding: 12px 15px; margin: 12px 0;
        }
        .projection-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 10px; }
        .proj-box { background: #1a1a2e; padding: 10px; border-radius: 8px; text-align: center; }
        .proj-box-label { font-size: 10px; color: #888; margin-bottom: 3px; text-transform: uppercase; }
        .proj-box-value { font-size: 16px; font-weight: 700; color: #22c55e; }
        .proj-box-value.tickets { color: #3b82f6; }
        .proj-box-value.bar { color: #f59e0b; }
        .projection-basis { font-size: 11px; color: #888; text-align: center; padding-top: 8px; border-top: 1px solid #3d3d54; }
        
        .cvd-badge { display: inline-flex; align-items: center; gap: 5px; background: #43A047; color: white; padding: 5px 10px; border-radius: 6px; font-size: 12px; font-weight: 600; margin: 10px 0; }
        
        .event-actions { display: flex; gap: 8px; margin-top: 12px; flex-wrap: wrap; }
        .event-action-btn {
            flex: 1; min-width: 100px; background: #3d3d54; border: none; border-radius: 8px;
            padding: 10px; color: white; font-size: 12px; font-weight: 600;
            cursor: pointer; transition: all 0.2s;
        }
        .event-action-btn:hover { background: #4d4d64; }
        .event-action-btn.primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        
        /* Toast */
        .toast {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: #22c55e; color: white; padding: 12px 24px; border-radius: 8px;
            font-weight: 600; z-index: 1001; display: none;
        }
        .toast.show { display: block; animation: fadeInOut 3s ease; }
        .toast.error { background: #ef4444; }
        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateX(-50%) translateY(20px); }
            15% { opacity: 1; transform: translateX(-50%) translateY(0); }
            85% { opacity: 1; transform: translateX(-50%) translateY(0); }
            100% { opacity: 0; transform: translateX(-50%) translateY(-20px); }
        }
        
        /* Departments */
        .departments { display: grid; gap: 15px; }
        .dept { border-radius: 15px; overflow: hidden; }
        .dept-header {
            padding: 15px 20px; color: white; font-weight: bold; font-size: 18px;
            display: flex; align-items: center; justify-content: space-between;
        }
        .dept-header-left { display: flex; align-items: center; gap: 10px; }
        .task-count { background: rgba(255,255,255,0.2); padding: 3px 10px; border-radius: 12px; font-size: 12px; }
        .office .dept-header { background: #1E88E5; }
        .office .dept-content { background: #E3F2FD; }
        .bar .dept-header { background: #F4511E; }
        .bar .dept-content { background: #FBE9E7; }
        .runner .dept-header { background: #43A047; }
        .runner .dept-content { background: #E8F5E9; }
        .technik .dept-header { background: #757575; }
        .technik .dept-content { background: #F5F5F5; }
        .sputnik .dept-header { background: #8E24AA; }
        .sputnik .dept-content { background: #F3E5F5; }
        .dept-content { padding: 15px; }
        
        .collapsible-section { margin-bottom: 10px; }
        .section-label {
            color: white; padding: 12px 15px; font-size: 14px; font-weight: bold;
            border-radius: 8px; cursor: pointer; display: flex;
            justify-content: space-between; align-items: center;
        }
        .section-label .toggle-icon { font-size: 12px; transition: transform 0.3s; }
        .section-label.open .toggle-icon { transform: rotate(180deg); }
        .section-label.open { border-radius: 8px 8px 0 0; }
        .office .section-label { background: #1E88E5; }
        .bar .section-label { background: #F4511E; }
        .runner .section-label { background: #43A047; }
        .sputnik .section-label { background: #8E24AA; }
        .technik .section-label { background: #757575; }
        .section-content { display: none; background: white; border-radius: 0 0 8px 8px; }
        .section-content.open { display: block; }
        .iframe-wrapper { 
            overflow: hidden; 
            position: relative;
        }
        .iframe-wrapper iframe { 
            width: 100%; 
            height: 350px; 
            border: none; 
            display: block; 
        }
        
        /* Tasks - Collapsible with black border */
        .tasks-inline { background: white; border-radius: 8px; margin-top: 10px; overflow: hidden; border: 2px solid #000; }
        .tasks-header { 
            padding: 12px 15px; font-size: 14px; font-weight: bold; color: #333; 
            display: flex; justify-content: space-between; align-items: center;
            cursor: pointer; user-select: none; background: #f5f5f5;
        }
        .tasks-header:hover { background: #eee; }
        .tasks-header .toggle-icon { font-size: 12px; transition: transform 0.3s; margin-left: 8px; }
        .tasks-header.open .toggle-icon { transform: rotate(180deg); }
        .tasks-header .refresh-btn { background: none; border: none; cursor: pointer; font-size: 14px; color: #888; }
        .tasks-header .refresh-btn.spinning { animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        .tasks-list { max-height: 300px; overflow-y: auto; display: none; }
        .tasks-list.open { display: block; }
        .task-item { display: flex; align-items: center; gap: 10px; padding: 10px 15px; border-bottom: 1px solid #f0f0f0; }
        .task-checkbox { width: 20px; height: 20px; border: 2px solid #ccc; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .task-checkbox:hover { border-color: #22c55e; }
        .task-checkbox.checked { background: #22c55e; border-color: #22c55e; }
        .task-checkbox.checked::after { content: ''; color: white; font-size: 12px; }
        .task-info { flex: 1; }
        .task-title { font-size: 14px; color: #333; }
        .task-due { font-size: 11px; color: #888; }
        .task-due.overdue { color: #ef4444; }
        .task-importance { width: 6px; height: 6px; border-radius: 50%; background: #ccc; }
        .task-importance.high { background: #ef4444; }
        .tasks-empty { padding: 20px; text-align: center; color: #888; font-size: 13px; }
        .tasks-login-prompt { padding: 20px; text-align: center; color: #666; font-size: 13px; }
        .tasks-login-prompt button { margin-top: 10px; background: #0078d4; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; }
        
        .tasks-btn { color: white; padding: 12px; border-radius: 8px; font-size: 14px; text-align: center; display: block; width: 100%; font-weight: bold; margin-top: 10px; border: none; cursor: pointer; }
        .office .tasks-btn { background: #1E88E5; }
        .bar .tasks-btn { background: #F4511E; }
        .runner .tasks-btn { background: #43A047; }
        .sputnik .tasks-btn { background: #8E24AA; }
        .technik .tasks-btn { background: #757575; }
        
        .reinigung-list { padding: 8px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; }
        .reinigung-item { display: flex; padding: 6px 8px; background: #f5f5f5; border-radius: 6px; align-items: center; gap: 6px; justify-content: center; }
        .reinigung-date { font-weight: bold; font-size: 13px; color: #1E88E5; }
        .reinigung-type { padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: bold; color: white; }
        .reinigung-type.gross { background: #ef4444; }
        
        .calendar-list { padding: 8px; }
        .calendar-item { 
            display: flex; 
            padding: 10px 12px; 
            margin-bottom: 8px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 8px; 
            align-items: center; 
            gap: 12px;
            border-left: 4px solid #757575;
        }
        .calendar-item:last-child { margin-bottom: 0; }
        .calendar-date { 
            font-weight: 700; 
            min-width: 65px; 
            font-size: 14px; 
            color: #333;
        }
        .calendar-day { 
            background: #757575;
            color: white;
            font-size: 11px; 
            font-weight: 700;
            padding: 3px 6px;
            border-radius: 4px;
            min-width: 28px;
            text-align: center;
        }
        .calendar-event { flex: 1; font-size: 15px; font-weight: 600; color: #333; }
        .calendar-tech { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            color: white; 
            padding: 5px 12px; 
            border-radius: 6px; 
            font-size: 13px; 
            font-weight: 700;
        }
        .tag-club { background: #ef4444; color: white; padding: 2px 8px; border-radius: 4px; font-size: 10px; margin-left: 8px; font-weight: 600; }
        .calendar-time { color: #666; font-size: 12px; min-width: 50px; }
        .calendar-pax { background: #8E24AA; color: white; padding: 2px 6px; border-radius: 4px; font-size: 11px; }
        
        /* BMT Events Section */
        .bmt-section {
            background: linear-gradient(135deg, #1e3a5f 0%, #1a1a2e 100%);
            border: 2px solid #ef4444;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .bmt-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .bmt-title {
            font-size: 18px;
            font-weight: 700;
            color: #fff;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .bmt-badge {
            background: #ef4444;
            color: white;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }
        .bmt-actions {
            display: flex;
            gap: 10px;
        }
        .bmt-btn {
            background: #3b82f6;
            border: none;
            border-radius: 8px;
            padding: 8px 15px;
            color: white;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .bmt-btn:hover { opacity: 0.9; }
        .bmt-btn.secondary { background: #4b5563; }
        .bmt-upload-input { display: none; }
        
        .bmt-events-grid {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            padding-bottom: 8px;
        }
        .bmt-events-grid::-webkit-scrollbar {
            height: 6px;
        }
        .bmt-events-grid::-webkit-scrollbar-track {
            background: #1a1a2e;
            border-radius: 3px;
        }
        .bmt-events-grid::-webkit-scrollbar-thumb {
            background: #3d3d54;
            border-radius: 3px;
        }
        .bmt-event-card {
            background: linear-gradient(135deg, #252542 0%, #1a1a2e 100%);
            border-radius: 8px;
            padding: 10px;
            border-left: 3px solid #3b82f6;
            min-width: 160px;
            max-width: 160px;
            flex-shrink: 0;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .bmt-event-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        .bmt-event-card.eigen { border-left-color: #22c55e; }
        .bmt-event-card.fremd { border-left-color: #f59e0b; }
        .bmt-event-card.konzert { border-left-color: #8b5cf6; }
        .bmt-event-card.special { border-left-color: #ec4899; }
        .bmt-event-card.holiday { border-left-color: #6b7280; opacity: 0.7; }
        
        .bmt-event-date {
            font-size: 10px;
            color: #888;
            margin-bottom: 2px;
        }
        .bmt-event-name {
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .bmt-event-category {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 9px;
            font-weight: 600;
        }
        .bmt-event-category.eigen { background: #22c55e; color: white; }
        .bmt-event-category.fremd { background: #f59e0b; color: white; }
        .bmt-event-category.konzert { background: #8b5cf6; color: white; }
        .bmt-event-category.special { background: #ec4899; color: white; }
        .bmt-event-category.holiday { background: #6b7280; color: white; }
        
        .bmt-event-time {
            font-size: 10px;
            color: #666;
            margin-top: 4px;
        }
        
        /* Cleaning Schedule Section */
        .cleaning-section {
            background: linear-gradient(135deg, #1e3a5f 0%, #1a1a2e 100%);
            border: 1px solid #22c55e;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .cleaning-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .cleaning-title {
            font-size: 18px;
            font-weight: 700;
            color: #fff;
        }
        .cleaning-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
        }
        .cleaning-item {
            background: #252542;
            border-radius: 10px;
            padding: 12px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .cleaning-date {
            font-weight: 600;
            font-size: 14px;
        }
        .cleaning-day {
            font-size: 11px;
            color: #888;
        }
        .cleaning-type {
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 700;
        }
        .cleaning-type.gross { background: #ef4444; color: white; }
        .cleaning-type.mittel { background: #f59e0b; color: white; }
        .cleaning-type.standard { background: #22c55e; color: white; }
        .cleaning-event {
            font-size: 11px;
            color: #888;
            margin-top: 4px;
        }
        
        .bmt-status {
            font-size: 12px;
            color: #888;
            text-align: center;
            padding: 20px;
        }
        .bmt-status.success { color: #22c55e; }
        .bmt-status.error { color: #ef4444; }
        
        .bmt-collapsed { display: none; }
        .bmt-expanded { display: block; }
        .bmt-toggle { 
            font-size: 12px; 
            margin-left: 10px; 
            transition: transform 0.3s; 
        }
        .bmt-toggle.open { transform: rotate(180deg); }
        
        .cleaning-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        .cleaning-table th, .cleaning-table td {
            padding: 10px 12px;
            text-align: left;
            border-bottom: 1px solid #3d3d54;
        }
        .cleaning-table th {
            color: #888;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }
        .cleaning-table tr:hover {
            background: rgba(255,255,255,0.05);
        }
        
        .footer { margin-top: 25px; text-align: center; }
        .footer a { background: #2d2d44; color: white; padding: 15px 30px; border-radius: 10px; text-decoration: none; display: inline-block; }
        .version { color: #555; font-size: 11px; text-align: center; margin-top: 15px; }
        
        .loading-spinner { text-align: center; padding: 40px; color: #888; }

        /* Month Filter Dropdown */
        .bmt-month-filter { position: relative; margin-left: 15px; }
        .bmt-month-btn {
            background: #3d3d54; border: 1px solid #4d4d64; border-radius: 6px;
            padding: 6px 12px; color: #fff; font-size: 12px; cursor: pointer;
        }
        .bmt-month-btn:hover { background: #4d4d64; }
        .month-dropdown {
            display: none; position: absolute; top: 100%; left: 0; margin-top: 5px;
            background: #252542; border: 1px solid #3d3d54; border-radius: 8px;
            padding: 10px; z-index: 100; min-width: 280px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        .month-dropdown.show { display: block; }
        .month-dropdown-header { display: flex; gap: 5px; margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid #3d3d54; }
        .month-select-btn {
            flex: 1; background: #3d3d54; border: none; border-radius: 4px;
            padding: 5px 8px; color: #fff; font-size: 11px; cursor: pointer;
        }
        .month-select-btn:hover { background: #4d4d64; }
        .month-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; }
        .month-grid label {
            display: flex; align-items: center; gap: 4px; font-size: 12px;
            padding: 4px 6px; border-radius: 4px; cursor: pointer;
        }
        .month-grid label:hover { background: #3d3d54; }
        .month-grid input[type="checkbox"] { width: 14px; height: 14px; cursor: pointer; }
        
        /* Cleaning Checkboxes */
        .cleaning-checkbox { width: 18px; height: 18px; cursor: pointer; accent-color: #22c55e; }
        .cleaning-row-disabled { opacity: 0.4; text-decoration: line-through; }
        
        /* Kassa Checkboxes */
        #kassa-row input[type="checkbox"] { 
            width: 18px; height: 18px; cursor: pointer; 
            accent-color: #8b5cf6;
        }
        #kassa-row label span {
            font-size: 14px;
            font-weight: 500;
        }
        
        /* Notes Dropdown */
        .note-item-container { margin-bottom: 2px; }
        .note-toggle-icon { 
            display: inline-block; 
            width: 14px; 
            font-size: 10px; 
            color: #8b5cf6;
            margin-right: 4px;
        }
        .note-checklist {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .checklist-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: #d1d5db;
            padding: 4px 0;
        }
        .checklist-item.checked {
            color: #6b7280;
            text-decoration: line-through;
        }
        .checklist-bullet {
            color: #8b5cf6;
            font-size: 14px;
        }
        
        /* Quick Notes Add Button */
        .quick-notes-add {
            background: #22c55e; border: none; border-radius: 6px;
            padding: 6px 12px; color: white; font-size: 12px; font-weight: 600;
            cursor: pointer; margin-left: 10px;
        }
        .quick-notes-add:hover { background: #16a34a; }
        
        .loading-spinner::after { content: ''; display: inline-block; width: 20px; height: 20px; border: 2px solid #3d3d54; border-top-color: #0078d4; border-radius: 50%; animation: spin 1s linear infinite; margin-left: 10px; }

        /* Quick Notes */
        .quick-notes {
            background: #252542; border-radius: 8px; padding: 10px 12px; margin-bottom: 10px;
            border: 1px solid #3d3d54;
        }
        .quick-notes-header {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;
        }
        .quick-notes-header span { font-size: 12px; font-weight: 600; color: #f59e0b; }
        .quick-notes-header .save-indicator { font-size: 10px; color: #22c55e; opacity: 0; transition: opacity 0.3s; }
        .quick-notes-header .save-indicator.show { opacity: 1; }
        .quick-notes textarea {
            width: 100%; min-height: 45px; padding: 8px; border-radius: 6px;
            border: 1px solid #3d3d54; background: #1a1a2e; color: #fff;
            font-size: 12px; font-family: inherit; resize: vertical;
        }
        .quick-notes textarea:focus { outline: none; border-color: #f59e0b; }
        .quick-notes textarea::placeholder { color: #666; }
        
        /* Deep Analysis Button */
        .btn-analysis { background: linear-gradient(135deg, #ec4899 0%, #be185d 100%); }

        /* =========================================================================== */
        /* RESPONSIVE DESIGN */
        /* =========================================================================== */
        
        /* Tablet (max 768px) */
        @media screen and (max-width: 768px) {
            body { padding: 12px; }
            .header h1 { font-size: 24px; }
            
            .auth-bar { 
                flex-direction: column; 
                gap: 8px;
                padding: 12px;
            }
            .auth-btn { width: 100%; justify-content: center; }
            
            .quick-actions { 
                grid-template-columns: repeat(3, 1fr); 
                gap: 6px;
            }
            .quick-actions-row2 { 
                grid-template-columns: repeat(2, 1fr); 
                gap: 6px;
            }
            
            .tools-toggle {
                padding: 12px 15px;
                font-size: 14px;
            }
            .tools-grid {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .quick-btn { 
                padding: 12px 8px; 
                font-size: 12px; 
            }
            
            .quick-notes textarea { min-height: 50px; }
            
            .modal { margin: 10px; max-width: calc(100% - 20px); }
            .modal-body { padding: 15px; max-height: 60vh; }
            .form-row { grid-template-columns: 1fr; }
            
            .event-card-header { flex-direction: column; align-items: flex-start; gap: 10px; }
            .event-quick-stats { width: 100%; justify-content: space-between; }
            
            .projection-grid { grid-template-columns: repeat(2, 1fr); }
            
            .vvk-input-row { 
                flex-wrap: wrap;
                gap: 8px;
            }
            .vvk-input-row label { font-size: 11px; }
            .vvk-input-row input { width: 55px; }
            
            .dept-header { font-size: 16px; padding: 12px 15px; }
            .iframe-wrapper iframe { height: 280px; }
            
            .result-grid { grid-template-columns: repeat(2, 1fr); }
            
            .reinigung-list { grid-template-columns: repeat(2, 1fr); }
            
            .calendar-item { flex-wrap: wrap; gap: 8px; }
            .calendar-event { width: 100%; order: -1; }
        }
        
        /* Mobile (max 480px) */
        @media screen and (max-width: 480px) {
            body { padding: 8px; }
            .header h1 { font-size: 20px; }
            .header p { font-size: 12px; }
            
            .quick-actions { 
                grid-template-columns: repeat(2, 1fr); 
                gap: 5px;
            }
            .quick-actions-row2 { 
                grid-template-columns: 1fr; 
                gap: 5px;
            }
            
            .tools-toggle {
                padding: 10px 12px;
                font-size: 13px;
            }
            .tools-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
            }
            .tool-btn {
                padding: 10px 8px;
                font-size: 11px;
            }
            .tool-btn .tool-icon {
                font-size: 18px;
            }
            
            .quick-btn { 
                padding: 10px 6px; 
                font-size: 11px;
                border-radius: 8px;
            }
            
            .quick-notes { padding: 10px; }
            .quick-notes-header span { font-size: 12px; }
            
            .event-card { margin-bottom: 10px; }
            .event-date { min-width: 60px; font-size: 12px; padding: 4px 8px; }
            .event-name { font-size: 14px; }
            .event-tech { font-size: 10px; padding: 2px 6px; }
            
            .projection-grid { grid-template-columns: repeat(2, 1fr); gap: 6px; }
            .proj-box { padding: 8px; }
            .proj-box-label { font-size: 9px; }
            .proj-box-value { font-size: 14px; }
            
            .vvk-tracker { padding: 10px; }
            .vvk-input-row input { width: 50px; font-size: 12px; padding: 4px 6px; }
            
            .modal-header { padding: 12px 15px; }
            .modal-header h3 { font-size: 16px; }
            .modal-body { padding: 12px; }
            .modal-footer { padding: 12px; flex-wrap: wrap; }
            .modal-btn { flex: 1; min-width: 80px; padding: 8px 12px; font-size: 12px; }
            
            .phase-table input { width: 60px; font-size: 12px; }
            
            .result-grid { grid-template-columns: 1fr 1fr; gap: 8px; }
            .result-item { padding: 8px; }
            .result-item .label { font-size: 10px; }
            .result-item .value { font-size: 16px; }
            
            .dept-header { font-size: 14px; padding: 10px 12px; }
            .section-label { padding: 10px 12px; font-size: 13px; }
            .iframe-wrapper iframe { height: 250px; }
            
            .tasks-header { padding: 10px 12px; font-size: 13px; }
            .task-item { padding: 8px 12px; }
            .task-title { font-size: 13px; }
            
            .reinigung-list { grid-template-columns: 1fr 1fr; gap: 4px; }
            .reinigung-item { padding: 4px 6px; }
            .reinigung-date { font-size: 11px; }
            
            .calendar-item { padding: 8px 10px; }
            .calendar-date { font-size: 12px; min-width: 55px; }
            .calendar-event { font-size: 13px; }
            .calendar-tech { font-size: 11px; padding: 3px 8px; }
            
            .footer a { padding: 12px 20px; font-size: 13px; }
            .version { font-size: 10px; }
            
            .factsheet-preview { padding: 15px; font-size: 12px; }
            .factsheet-preview table { font-size: 11px; }
            .factsheet-preview th, 
            .factsheet-preview td { padding: 5px; }
        }
        
        /* Large Desktop (min 1200px) */
        @media screen and (min-width: 1200px) {
            .departments { 
                display: grid; 
                grid-template-columns: repeat(2, 1fr); 
                gap: 20px; 
            }
        }
        
        /* BAR STAFFING Styles */
        .bar-staffing-tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 20px;
            border-bottom: 2px solid #3d3d4d;
            padding-bottom: 10px;
        }
        .bar-tab {
            background: #2d2d3d;
            border: 1px solid #3d3d4d;
            border-radius: 8px 8px 0 0;
            padding: 10px 20px;
            color: #9ca3af;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
        }
        .bar-tab:hover { background: #3d3d4d; color: white; }
        .bar-tab.active { background: #8b5cf6; color: white; border-color: #8b5cf6; }
        .bar-tab-content { display: none; }
        .bar-tab-content.active { display: block; }
        .bar-month-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }
        .bar-month-cb {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px;
            background: #2d2d3d;
            border: 1px solid #3d3d4d;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .bar-month-cb:hover { border-color: #8b5cf6; }
        .bar-month-cb:has(input:checked) { background: #8b5cf6; border-color: #8b5cf6; }
        .bar-year-select {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        .bar-year-select select {
            background: #2d2d3d;
            border: 1px solid #3d3d4d;
            border-radius: 6px;
            padding: 8px 12px;
            color: white;
            font-size: 14px;
        }
        .bar-preview {
            background: #1a1a2e;
            border: 1px solid #3d3d4d;
            border-radius: 8px;
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
        }
        .bar-preview-event {
            display: flex;
            justify-content: space-between;
            padding: 8px;
            border-bottom: 1px solid #3d3d4d;
            gap: 10px;
        }
        .bar-preview-event:last-child { border-bottom: none; }
        .bar-preview-event .date { color: #8b5cf6; font-weight: 600; min-width: 90px; }
        .bar-preview-event .day { color: #6b7280; min-width: 80px; }
        .bar-preview-event .name { flex: 1; color: white; }
        .bar-preview-event .type {
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }
        .bar-preview-event .type.club { background: #22c55e; color: white; }
        .bar-preview-event .type.konzert { background: #8b5cf6; color: white; }
        .bar-preview-event .type.eigen { background: #ef4444; color: white; }
        .bar-upload-zone {
            border: 2px dashed #3d3d4d;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        .bar-upload-zone:hover { border-color: #8b5cf6; background: rgba(139, 92, 246, 0.1); }
        .bar-upload-zone.dragover { border-color: #8b5cf6; background: rgba(139, 92, 246, 0.2); }
        .bar-upload-icon { font-size: 48px; margin-bottom: 10px; }
        .bar-status { padding: 15px; border-radius: 8px; margin-top: 15px; }
        .bar-status.success { background: rgba(34, 197, 94, 0.2); border: 1px solid #22c55e; }
        .bar-status.error { background: rgba(239, 68, 68, 0.2); border: 1px solid #ef4444; }
        .bar-roster-table { overflow-x: auto; }
        .bar-roster-table table { width: 100%; border-collapse: collapse; }
        .bar-roster-table th, .bar-roster-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #3d3d4d;
        }
        .bar-roster-table th { background: #2d2d3d; color: #9ca3af; font-weight: 600; font-size: 12px; }
        .bar-roster-table td input[type="text"],
        .bar-roster-table td input[type="number"],
        .bar-roster-table td select {
            background: #1a1a2e;
            border: 1px solid #3d3d4d;
            border-radius: 4px;
            padding: 6px 10px;
            color: white;
            width: 100%;
        }
        .bar-roster-table td input[type="checkbox"] { width: 18px; height: 18px; }
        .bar-roster-delete {
            background: #ef4444;
            border: none;
            border-radius: 4px;
            padding: 5px 10px;
            color: white;
            cursor: pointer;
        }
        .bar-roster-delete:hover { background: #dc2626; }
    </style>
</head>
<body>


    <!-- Header - Clean Modern Style -->
    <div class="header-container">
        <div class="header-box">
            <div class="header-text">Turbo Projects Work Hub &lt;&gt;&lt;</div>
        </div>
    </div>
    
    <!-- Auth Bar - Compact -->
    <div class="auth-bar">
        <div class="auth-status">
            <span class="dot" id="auth-dot"></span>
            <span id="auth-status-text">Not connected</span>
        </div>
        <span class="auth-user" id="auth-user"></span>
        <div class="auth-buttons">
            <button class="auth-btn" id="auth-btn" onclick="handleAuth()"> Sign in</button>
            <button class="auth-btn reset" onclick="forceResetAuth()"> Refresh</button>
        </div>
    </div>
    
    <div class="toast" id="toast"></div>
    
    <!-- Quick Notes -->
    <div class="quick-notes">
        <div class="quick-notes-header">
            <span> Quick Notes</span>
            <div style="display: flex; align-items: center; gap: 8px;">
                <span class="save-indicator" id="notes-saved"> Gespeichert</span>
                <button class="quick-notes-add" onclick="toggleSpeechToText()" title="Spracheingabe" id="speech-btn">Mic</button>
                <button class="quick-notes-add" onclick="createNewTask()" title="Als neue Task speichern"> Task</button>
                <button class="quick-notes-add" onclick="clearQuickNotes()" title="Notizen lschen" style="background: #6b7280;"></button>
            </div>
        </div>
        <textarea id="quick-notes-text" placeholder="Schnelle Notizen hier eingeben..." oninput="saveQuickNotes()"></textarea>
    </div>
    

    <!--  -->
    <!-- BMT EVENTS SECTION (Collapsible) -->
    <!--  -->
    
    <div class="bmt-section">
        <div class="bmt-header" style="cursor: pointer;">
            <div class="bmt-title" onclick="toggleBMTSection()">
                 BMT Events
                <span class="bmt-badge" id="bmt-event-count">0</span>
                <span class="bmt-toggle" id="bmt-toggle"></span>
            </div>
            <div class="bmt-month-filter" onclick="event.stopPropagation();">
                <button class="bmt-month-btn" onclick="toggleMonthFilter()" id="month-filter-btn"> Monate </button>
                <div class="month-dropdown" id="month-dropdown">
                    <div class="month-dropdown-header">
                        <button onclick="selectAllMonths()" class="month-select-btn">Alle</button>
                        <button onclick="selectCurrentMonth()" class="month-select-btn">Aktuell</button>
                        <button onclick="clearMonths()" class="month-select-btn">Keine</button>
                    </div>
                    <div class="month-grid">
                        <label><input type="checkbox" class="month-cb" value="1" onchange="filterBMTByMonth()"> Jan</label>
                        <label><input type="checkbox" class="month-cb" value="2" onchange="filterBMTByMonth()"> Feb</label>
                        <label><input type="checkbox" class="month-cb" value="3" onchange="filterBMTByMonth()"> Mr</label>
                        <label><input type="checkbox" class="month-cb" value="4" onchange="filterBMTByMonth()"> Apr</label>
                        <label><input type="checkbox" class="month-cb" value="5" onchange="filterBMTByMonth()"> Mai</label>
                        <label><input type="checkbox" class="month-cb" value="6" onchange="filterBMTByMonth()"> Jun</label>
                        <label><input type="checkbox" class="month-cb" value="7" onchange="filterBMTByMonth()"> Jul</label>
                        <label><input type="checkbox" class="month-cb" value="8" onchange="filterBMTByMonth()"> Aug</label>
                        <label><input type="checkbox" class="month-cb" value="9" onchange="filterBMTByMonth()"> Sep</label>
                        <label><input type="checkbox" class="month-cb" value="10" onchange="filterBMTByMonth()"> Okt</label>
                        <label><input type="checkbox" class="month-cb" value="11" onchange="filterBMTByMonth()"> Nov</label>
                        <label><input type="checkbox" class="month-cb" value="12" onchange="filterBMTByMonth()"> Dez</label>
                    </div>
                </div>
            </div>
            <div class="bmt-actions" onclick="event.stopPropagation();">
                <input type="file" id="bmt-upload" class="bmt-upload-input" accept=".ics" onchange="handleBMTUpload(event)">
                <button class="bmt-btn" onclick="autoLoadBMT()" title="Automatisch von BMT laden">
                     Auto
                </button>
                <button class="bmt-btn secondary" onclick="document.getElementById('bmt-upload').click()">
                     .ics
                </button>
            </div>
        </div>
        <div id="bmt-events-container" class="bmt-collapsed">
            <div class="bmt-status" id="bmt-status">
                 Keine Events geladen
                <br><small>Klicke  Auto oder  .ics zum Laden</small>
                <br><small style="color: #22c55e;"> Events bleiben nach Reload gespeichert</small>
            </div>
        </div>
    </div>
    
    <!-- Cleaning Schedule Modal -->
    <div class="modal-overlay" id="cleaning-modal">
        <div class="modal" style="max-width: 900px;">
            <div class="modal-header green">
                <h3> Reinigungsplan</h3>
                <button class="modal-close" onclick="closeModal('cleaning-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-row" style="margin-bottom: 15px;">
                    <div class="form-group">
                        <label>Monat</label>
                        <select id="cleaning-month" onchange="generateCleaningSchedule()">
                        </select>
                    </div>
                    <div class="form-group" style="display: flex; align-items: flex-end; gap: 10px;">
                        <button class="modal-btn success" onclick="copyCleaningSchedule()"> Kopieren</button>
                        <button class="modal-btn" style="background: #6b7280;" onclick="quickSaveCleaningDraft()"> Als Entwurf</button>
                        <button class="modal-btn primary" onclick="showCleaningEmail()"> Per E-Mail</button>
                    </div>
                </div>
                <div id="cleaning-container">
                    <div class="bmt-status">Warte auf BMT Events...</div>
                </div>
                <div id="cleaning-summary" style="margin-top: 15px; padding: 15px; background: #1a1a2e; border-radius: 10px;">
                </div>
                
                <!-- Email Section (hidden by default) -->
                <div id="cleaning-email-section" style="display: none; margin-top: 20px; padding: 15px; background: #1a1a2e; border-radius: 10px; border: 1px solid #3b82f6;">
                    <h4 style="color: #3b82f6; margin-bottom: 15px;"> Reinigungsplan versenden</h4>
                    <div class="form-group">
                        <label>Empfnger</label>
                        <select id="cleaning-email-to" onchange="updateCleaningEmailTo()">
                            <option value="custom">Andere E-Mail eingeben...</option>
                        </select>
                    </div>
                    <div class="form-group" id="cleaning-email-custom-group" style="display: none;">
                        <label>E-Mail Adresse</label>
                        <input type="email" id="cleaning-email-custom" placeholder="email@beispiel.com">
                    </div>
                    <div class="form-group">
                        <label>Betreff</label>
                        <input type="text" id="cleaning-email-subject" value="">
                    </div>
                    <div class="form-group">
                        <label>Nachricht (kann bearbeitet werden)</label>
                        <textarea id="cleaning-email-body" style="min-height: 200px; font-family: monospace; font-size: 12px;"></textarea>
                    </div>
                    <div style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button class="modal-btn cancel" onclick="hideCleaningEmail()">Abbrechen</button>
                        <button class="modal-btn" onclick="saveDraftCleaningEmail()" style="background: #6b7280;"> Als Entwurf</button>
                        <button class="modal-btn success" onclick="sendCleaningEmail()"> Senden</button>
                    </div>
                    <div id="cleaning-email-status" style="margin-top: 10px; font-size: 13px;"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn cancel" onclick="closeModal('cleaning-modal')">Schlieen</button>
            </div>
        </div>
    </div>
    <!--  -->
    <!-- MODALS -->
    <!--  -->
    
    <!-- NYE Projector Modal -->
    <div class="modal-overlay" id="nye-projector-modal">
        <div class="modal" style="max-width: 900px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                <h3> NYE Projector (3-Jahre Benchmark)</h3>
                <button class="modal-close" onclick="closeModal('nye-projector-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-row" style="margin-bottom: 20px;">
                    <div class="form-group">
                        <label>Aktueller VVK Stand</label>
                        <input type="number" id="nye-current-vvk" value="0" onchange="calculateNYE()">
                    </div>
                    <div class="form-group">
                        <label>Szenario</label>
                        <select id="nye-scenario" onchange="calculateNYE()">
                            <option value="base">Base (~960 PAX)</option>
                            <option value="expected" selected>Expected (~1,096 PAX)</option>
                            <option value="strong">Strong (~1,200 PAX)</option>
                        </select>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px;">
                    <div style="background: linear-gradient(135deg, #1a1a2e 0%, #252542 100%); padding: 20px; border-radius: 12px; text-align: center; border: 2px solid #f59e0b;">
                        <div style="font-size: 12px; color: #888; margin-bottom: 5px;">PRESALE</div>
                        <div id="nye-presale" style="font-size: 28px; font-weight: 700; color: #f59e0b;">560</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #1a1a2e 0%, #252542 100%); padding: 20px; border-radius: 12px; text-align: center; border: 2px solid #3b82f6;">
                        <div style="font-size: 12px; color: #888; margin-bottom: 5px;">FOH</div>
                        <div id="nye-foh" style="font-size: 28px; font-weight: 700; color: #3b82f6;">536</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #1a1a2e 0%, #252542 100%); padding: 20px; border-radius: 12px; text-align: center; border: 2px solid #22c55e;">
                        <div style="font-size: 12px; color: #888; margin-bottom: 5px;">TOTAL PAX</div>
                        <div id="nye-total" style="font-size: 28px; font-weight: 700; color: #22c55e;">1,096</div>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px;">
                    <div style="background: #1a1a2e; padding: 15px; border-radius: 10px; text-align: center;">
                        <div style="font-size: 11px; color: #888;">FOH Revenue</div>
                        <div id="nye-foh-revenue" style="font-size: 20px; font-weight: 600; color: #3b82f6;">13,392</div>
                    </div>
                    <div style="background: #1a1a2e; padding: 15px; border-radius: 10px; text-align: center;">
                        <div style="font-size: 11px; color: #888;">Bar Revenue</div>
                        <div id="nye-bar-revenue" style="font-size: 20px; font-weight: 600; color: #22c55e;">24,000</div>
                    </div>
                    <div style="background: #1a1a2e; padding: 15px; border-radius: 10px; text-align: center;">
                        <div style="font-size: 11px; color: #888;">TOTAL Revenue</div>
                        <div id="nye-total-revenue" style="font-size: 20px; font-weight: 600; color: #f59e0b;">37,392</div>
                    </div>
                </div>
                
                <h4 style="color: #f59e0b; margin: 20px 0 10px 0;"> Guest Arrival Stream</h4>
                <table class="cleaning-table" id="nye-arrival-table">
                    <thead>
                        <tr>
                            <th>Zeit</th>
                            <th>Presale</th>
                            <th>FOH</th>
                            <th>Total</th>
                            <th>Im Club</th>
                        </tr>
                    </thead>
                    <tbody id="nye-arrival-body">
                    </tbody>
                </table>
                
                <h4 style="color: #22c55e; margin: 20px 0 10px 0;"> Bar Revenue by Hour</h4>
                <table class="cleaning-table">
                    <thead>
                        <tr>
                            <th>Zeit</th>
                            <th>Revenue</th>
                            <th>Anteil</th>
                            <th>Visual</th>
                        </tr>
                    </thead>
                    <tbody id="nye-bar-body">
                    </tbody>
                </table>
                
                <div style="margin-top: 20px; padding: 15px; background: linear-gradient(135deg, #7f1d1d 0%, #991b1b 100%); border-radius: 10px;">
                    <div style="font-weight: 700; margin-bottom: 10px;"> CRITICAL PEAK: 01:00 - 03:00</div>
                    <div style="font-size: 13px; line-height: 1.6;">
                        "The night is not decided by how many tickets you sell, but by how many people you can move, store, and serve between 01:00 and 03:00."
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn cancel" onclick="closeModal('nye-projector-modal')">Schlieen</button>
            </div>
        </div>
    </div>
    
    <!-- Peak Grid Dashboard Modal -->
    <div class="modal-overlay" id="peak-grid-modal">
        <div class="modal" style="max-width: 1000px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);">
                <h3> NYE Peak Grid Dashboard</h3>
                <button class="modal-close" onclick="closeModal('peak-grid-modal')">&times;</button>
            </div>
            <div class="modal-body" style="padding: 15px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <div>
                        <span style="font-size: 12px; color: #888;">Live Monitoring fr</span>
                        <span style="font-weight: 700; color: #ef4444;"> Silvester 31.12.</span>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <span class="cleaning-type gross" style="font-size: 11px;">MAX</span>
                        <span class="cleaning-type mittel" style="font-size: 11px;">HIGH</span>
                        <span class="cleaning-type standard" style="font-size: 11px;">MED</span>
                        <span style="background: #3d3d54; padding: 2px 8px; border-radius: 4px; font-size: 11px;">LOW</span>
                    </div>
                </div>
                
                <div style="overflow-x: auto;">
                    <table class="cleaning-table" style="font-size: 12px;">
                        <thead>
                            <tr>
                                <th style="min-width: 90px;">Zeit</th>
                                <th style="min-width: 70px;">Door</th>
                                <th style="min-width: 70px;">Garderobe</th>
                                <th style="min-width: 70px;">Bar</th>
                                <th style="min-width: 200px;">Action / Notes</th>
                                <th style="min-width: 50px;"></th>
                            </tr>
                        </thead>
                        <tbody id="peak-grid-body">
                        </tbody>
                    </table>
                </div>
                
                <div style="margin-top: 20px; display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                    <div style="background: linear-gradient(135deg, #1e3a5f 0%, #1a1a2e 100%); padding: 15px; border-radius: 10px; border-left: 4px solid #3b82f6;">
                        <div style="font-weight: 700; color: #3b82f6; margin-bottom: 10px;"> Tub Strategy</div>
                        <div style="font-size: 12px; line-height: 1.8;">
                            <div><span style="color: #f59e0b;">23:45-00:00</span> Initial Fill (BEFORE midnight!)</div>
                            <div><span style="color: #ef4444; font-weight: 700;">01:15-01:30</span> <strong>MANDATORY REFILL</strong></div>
                            <div><span style="color: #888;">02:45-03:00</span> Final Refill (if needed)</div>
                            <div><span style="color: #888;">After 03:30</span> STOP - normal restock</div>
                        </div>
                    </div>
                    <div style="background: linear-gradient(135deg, #3d1a1a 0%, #1a1a2e 100%); padding: 15px; border-radius: 10px; border-left: 4px solid #ef4444;">
                        <div style="font-weight: 700; color: #ef4444; margin-bottom: 10px;"> Peak Rules</div>
                        <div style="font-size: 12px; line-height: 1.8;">
                            <div> <strong>00:30-02:30:</strong> Both lanes do EVERYTHING</div>
                            <div> <strong>00:30-03:00:</strong> Bar staff NEVER stop selling</div>
                            <div> <strong>Speed Menu:</strong> Stop slow drinks during peak</div>
                            <div> <strong>Bottleneck Priority:</strong> DoorGarderobeBarCorridors</div>
                        </div>
                    </div>
                </div>
                
                <div style="margin-top: 15px; display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; text-align: center;">
                    <div style="background: #1a1a2e; padding: 12px; border-radius: 8px;">
                        <div style="font-size: 10px; color: #888;">Max Occupancy</div>
                        <div style="font-size: 20px; font-weight: 700; color: #ef4444;">~1,450</div>
                        <div style="font-size: 10px; color: #666;">@ 02:00</div>
                    </div>
                    <div style="background: #1a1a2e; padding: 12px; border-radius: 8px;">
                        <div style="font-size: 10px; color: #888;">Peak Arrivals</div>
                        <div style="font-size: 20px; font-weight: 700; color: #f59e0b;">328</div>
                        <div style="font-size: 10px; color: #666;">@ 01:00-02:00</div>
                    </div>
                    <div style="background: #1a1a2e; padding: 12px; border-radius: 8px;">
                        <div style="font-size: 10px; color: #888;">Peak Bar </div>
                        <div style="font-size: 20px; font-weight: 700; color: #22c55e;">4,000</div>
                        <div style="font-size: 10px; color: #666;">@ 02:00-03:00</div>
                    </div>
                    <div style="background: #1a1a2e; padding: 12px; border-radius: 8px;">
                        <div style="font-size: 10px; color: #888;">FOH Pricing</div>
                        <div style="font-size: 20px; font-weight: 700; color: #3b82f6;">22/26</div>
                        <div style="font-size: 10px; color: #666;">pre/post 00:00</div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn primary" onclick="printPeakGrid()"> Drucken</button>
                <button class="modal-btn cancel" onclick="closeModal('peak-grid-modal')">Schlieen</button>
            </div>
        </div>
    </div>
    
    <!-- Guest List Parser Modal -->
    <div class="modal-overlay" id="guestlist-modal">
        <div class="modal" style="max-width: 900px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);">
                <h3> Guest List Parser</h3>
                <button class="modal-close" onclick="closeModal('guestlist-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                    <div class="form-group">
                        <label> Event Datum (z.B. 27.12.25)</label>
                        <input type="text" id="gl-date" placeholder="27.12.25" style="font-size: 16px; font-weight: 600;">
                    </div>
                    <div class="form-group">
                        <label> Event Name (optional)</label>
                        <input type="text" id="gl-event-name" placeholder="TURBO">
                    </div>
                </div>
                
                <div class="form-group">
                    <label> WhatsApp Chat Export (.zip oder .txt)</label>
                    <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                        <input type="file" id="gl-file-upload" accept=".txt,.zip" onchange="handleGuestListFile(event)" style="display: none;">
                        <button class="modal-btn primary" onclick="document.getElementById('gl-file-upload').click()"> Datei hochladen</button>
                        <button class="modal-btn" style="background: #3d3d54;" onclick="clearGuestListInput()"> Leeren</button>
                    </div>
                    <textarea id="gl-chat-input" rows="8" placeholder="WhatsApp Chat Export hier einfgen oder .zip/.txt Datei hochladen..." style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #3d3d54; background: #1a1a2e; color: #fff; font-family: monospace; font-size: 12px; resize: vertical;"></textarea>
                </div>
                
                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                    <button class="modal-btn success" onclick="parseGuestList()" style="flex: 1; background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);"> Guest List extrahieren</button>
                </div>
                
                <div id="gl-results" style="display: none;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h4 style="color: #22c55e; margin: 0;"> Ergebnis</h4>
                        <div style="display: flex; gap: 8px;">
                            <button class="modal-btn" style="background: #3b82f6; padding: 6px 12px; font-size: 12px;" onclick="copyGuestList()"> Kopieren</button>
                            <button class="modal-btn" style="background: #8b5cf6; padding: 6px 12px; font-size: 12px;" onclick="downloadGuestListCSV()"> CSV</button>
                        </div>
                    </div>
                    <div id="gl-summary" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 15px;"></div>
                    <div id="gl-output" style="background: #1a1a2e; border-radius: 10px; padding: 15px; max-height: 400px; overflow-y: auto;"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn cancel" onclick="closeModal('guestlist-modal')">Schlieen</button>
            </div>
        </div>
    </div>
    
    <!-- BAR STAFFING Modal -->
    <div class="modal-overlay" id="bar-staffing-modal">
        <div class="modal" style="max-width: 850px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%);">
                <h3> Bar Staffing Tool</h3>
                <button class="modal-close" onclick="closeModal('bar-staffing-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Tab Navigation -->
                <div class="bar-staffing-tabs">
                    <button class="bar-tab active" onclick="switchBarTab('availability')" id="tab-availability">
                         Availability Sheet
                    </button>
                    <button class="bar-tab" onclick="switchBarTab('shiftplan')" id="tab-shiftplan">
                         Generate Shiftplan
                    </button>
                    <button class="bar-tab" onclick="switchBarTab('roster')" id="tab-roster">
                         Roster
                    </button>
                </div>

                <!-- TAB 1: Availability Sheet Generator -->
                <div class="bar-tab-content active" id="content-availability">
                    <h4 style="margin-bottom: 15px;">Select Month(s) to Generate Availability Sheet</h4>
                    
                    <div class="bar-month-grid">
                        <label class="bar-month-cb"><input type="checkbox" value="1" class="bar-month-check" onchange="updateBarEventsPreview()"> Jan</label>
                        <label class="bar-month-cb"><input type="checkbox" value="2" class="bar-month-check" onchange="updateBarEventsPreview()"> Feb</label>
                        <label class="bar-month-cb"><input type="checkbox" value="3" class="bar-month-check" onchange="updateBarEventsPreview()"> Mr</label>
                        <label class="bar-month-cb"><input type="checkbox" value="4" class="bar-month-check" onchange="updateBarEventsPreview()"> Apr</label>
                        <label class="bar-month-cb"><input type="checkbox" value="5" class="bar-month-check" onchange="updateBarEventsPreview()"> Mai</label>
                        <label class="bar-month-cb"><input type="checkbox" value="6" class="bar-month-check" onchange="updateBarEventsPreview()"> Jun</label>
                        <label class="bar-month-cb"><input type="checkbox" value="7" class="bar-month-check" onchange="updateBarEventsPreview()"> Jul</label>
                        <label class="bar-month-cb"><input type="checkbox" value="8" class="bar-month-check" onchange="updateBarEventsPreview()"> Aug</label>
                        <label class="bar-month-cb"><input type="checkbox" value="9" class="bar-month-check" onchange="updateBarEventsPreview()"> Sep</label>
                        <label class="bar-month-cb"><input type="checkbox" value="10" class="bar-month-check" onchange="updateBarEventsPreview()"> Okt</label>
                        <label class="bar-month-cb"><input type="checkbox" value="11" class="bar-month-check" onchange="updateBarEventsPreview()"> Nov</label>
                        <label class="bar-month-cb"><input type="checkbox" value="12" class="bar-month-check" onchange="updateBarEventsPreview()"> Dez</label>
                    </div>
                    
                    <div class="bar-year-select">
                        <label>Jahr:</label>
                        <select id="bar-year" onchange="updateBarEventsPreview()">
                            <option value="2025">2025</option>
                            <option value="2026" selected>2026</option>
                            <option value="2027">2027</option>
                        </select>
                    </div>

                    <div id="bar-events-preview" class="bar-preview">
                        <p style="color: #6b7280;">Whle Monat(e) um Events zu sehen...</p>
                    </div>

                    <button class="modal-btn primary" onclick="generateAvailabilitySheet()" style="width: 100%; margin-top: 15px;">
                         Download Availability Sheet (.xlsx)
                    </button>
                </div>

                <!-- TAB 2: Shiftplan Generator -->
                <div class="bar-tab-content" id="content-shiftplan">
                    <h4 style="margin-bottom: 15px;">Upload Filled Availability Sheet</h4>
                    
                    <div class="bar-upload-zone" id="bar-upload-zone" onclick="document.getElementById('bar-availability-upload').click()">
                        <input type="file" id="bar-availability-upload" accept=".xlsx,.xls" style="display: none;" onchange="handleAvailabilityUpload(event)">
                        <div class="bar-upload-icon"></div>
                        <p>Click or drag filled Availability Sheet here</p>
                        <small>Supports .xlsx files</small>
                    </div>

                    <div id="bar-availability-status" class="bar-status" style="display: none;"></div>
                    <div id="bar-shiftplan-preview" class="bar-preview" style="display: none;"></div>

                    <button class="modal-btn primary" onclick="generateShiftplan()" id="btn-generate-shiftplan" style="width: 100%; margin-top: 15px; display: none;">
                         Generate & Download Shiftplan (.xlsx)
                    </button>
                </div>

                <!-- TAB 3: Roster Management -->
                <div class="bar-tab-content" id="content-roster">
                    <h4 style="margin-bottom: 15px;">Bar Team Roster</h4>
                    
                    <div class="bar-roster-table">
                        <table>
                            <thead>
                                <tr>
                                    <th>PRIO</th>
                                    <th>Name</th>
                                    <th>Due Shifts</th>
                                    <th>Weekdays X</th>
                                    <th>No DS</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="bar-roster-body"></tbody>
                        </table>
                    </div>
                    
                    <div style="margin-top: 15px; display: flex; gap: 10px;">
                        <button class="modal-btn" onclick="addRosterMember()"> Add Member</button>
                        <button class="modal-btn primary" onclick="saveBarRoster()"> Save Roster</button>
                        <button class="modal-btn" style="background: #6b7280;" onclick="resetBarRoster()"> Reset Default</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- PreSale Calculator Modal -->
    <div class="modal-overlay" id="presale-modal">
        <div class="modal">
            <div class="modal-header orange">
                <h3> PreSale Calculator</h3>
                <button class="modal-close" onclick="closeModal('presale-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-row">
                    <div class="form-group">
                        <label>Event Name</label>
                        <input type="text" id="ps-event-name" placeholder="z.B. TURBO">
                    </div>
                    <div class="form-group">
                        <label>FOH Tickets (geschtzt)</label>
                        <input type="number" id="ps-foh-tickets" value="350" oninput="calculatePreSale()">
                    </div>
                    <div class="form-group">
                        <label>FOH Preis ()</label>
                        <input type="number" id="ps-door-price" value="22" oninput="calculatePreSale()">
                    </div>
                </div>
                
                <h4 style="color: #f59e0b; margin: 20px 0 10px;">Phasen-Struktur</h4>
                <table class="phase-table">
                    <thead>
                        <tr>
                            <th>Phase</th>
                            <th>Tickets</th>
                            <th>Preis ()</th>
                            <th>Revenue</th>
                        </tr>
                    </thead>
                    <tbody id="ps-phases-body">
                        <tr>
                            <td class="phase-name">Early Bird</td>
                            <td><input type="number" class="ps-tickets" value="100" oninput="calculatePreSale()"></td>
                            <td><input type="number" class="ps-price" value="18" oninput="calculatePreSale()"></td>
                            <td class="phase-revenue">1.800</td>
                        </tr>
                        <tr>
                            <td class="phase-name">Phase 1</td>
                            <td><input type="number" class="ps-tickets" value="150" oninput="calculatePreSale()"></td>
                            <td><input type="number" class="ps-price" value="20" oninput="calculatePreSale()"></td>
                            <td class="phase-revenue">3.000</td>
                        </tr>
                        <tr>
                            <td class="phase-name">Phase 2</td>
                            <td><input type="number" class="ps-tickets" value="150" oninput="calculatePreSale()"></td>
                            <td><input type="number" class="ps-price" value="22" oninput="calculatePreSale()"></td>
                            <td class="phase-revenue">3.300</td>
                        </tr>
                        <tr>
                            <td class="phase-name">Phase 3</td>
                            <td><input type="number" class="ps-tickets" value="80" oninput="calculatePreSale()"></td>
                            <td><input type="number" class="ps-price" value="24" oninput="calculatePreSale()"></td>
                            <td class="phase-revenue">1.920</td>
                        </tr>
                        <tr>
                            <td class="phase-name">Phase 4</td>
                            <td><input type="number" class="ps-tickets" value="0" oninput="calculatePreSale()"></td>
                            <td><input type="number" class="ps-price" value="26" oninput="calculatePreSale()"></td>
                            <td class="phase-revenue">0</td>
                        </tr>
                        <tr>
                            <td class="phase-name">Phase 5</td>
                            <td><input type="number" class="ps-tickets" value="0" oninput="calculatePreSale()"></td>
                            <td><input type="number" class="ps-price" value="28" oninput="calculatePreSale()"></td>
                            <td class="phase-revenue">0</td>
                        </tr>
                    </tbody>
                </table>
                
                <div class="result-card" style="margin-top: 20px;">
                    <h4> Ergebnis</h4>
                    <div class="result-grid">
                        <div class="result-item">
                            <div class="label">VVK Tickets</div>
                            <div class="value blue" id="ps-result-vvk">480</div>
                        </div>
                        <div class="result-item">
                            <div class="label">VVK Revenue</div>
                            <div class="value" id="ps-result-vvk-rev">10.020</div>
                        </div>
                        <div class="result-item">
                            <div class="label"> VVK Preis</div>
                            <div class="value orange" id="ps-result-avg">20.88</div>
                        </div>
                        <div class="result-item">
                            <div class="label">FOH Tickets</div>
                            <div class="value blue" id="ps-result-foh">320</div>
                        </div>
                        <div class="result-item">
                            <div class="label">FOH Revenue</div>
                            <div class="value" id="ps-result-foh-rev">8.000</div>
                        </div>
                        <div class="result-item">
                            <div class="label">Total Revenue</div>
                            <div class="value" id="ps-result-total">18.020</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn cancel" onclick="closeModal('presale-modal')">Schlieen</button>
            </div>
        </div>
    </div>
    
    <!-- Cost Calculator Modal -->
    <div class="modal-overlay" id="cost-modal">
        <div class="modal">
            <div class="modal-header purple">
                <h3> Cost Calculator</h3>
                <button class="modal-close" onclick="closeModal('cost-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-row">
                    <div class="form-group">
                        <label>Event Name</label>
                        <input type="text" id="cc-event-name" placeholder="z.B. TURBO">
                    </div>
                    <div class="form-group">
                        <label>Erwartete Gste</label>
                        <input type="number" id="cc-guests" value="800" oninput="calculateCosts()">
                    </div>
                </div>
                
                <h4 style="color: #8b5cf6; margin: 20px 0 10px;"> Einnahmen (Projektion)</h4>
                <div class="form-row">
                    <div class="form-group">
                        <label>Ticket Revenue ()</label>
                        <input type="number" id="cc-ticket-rev" value="18000" oninput="calculateCosts()">
                    </div>
                    <div class="form-group">
                        <label>Bar Revenue ()</label>
                        <input type="number" id="cc-bar-rev" value="12000" oninput="calculateCosts()">
                    </div>
                </div>
                
                <h4 style="color: #8b5cf6; margin: 20px 0 10px;"> Personal</h4>
                <div class="form-row">
                    <div class="form-group">
                        <label>Bar Team (Personen)</label>
                        <input type="number" id="cc-bar-staff" value="4" oninput="calculateCosts()">
                    </div>
                    <div class="form-group">
                        <label>Runner Team (Personen)</label>
                        <input type="number" id="cc-runner-staff" value="5" oninput="calculateCosts()">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Garderobe (Personen)</label>
                        <input type="number" id="cc-garderobe-staff" value="3" oninput="calculateCosts()">
                    </div>
                    <div class="form-group">
                        <label>Security (Personen)</label>
                        <input type="number" id="cc-security-staff" value="7" oninput="calculateCosts()">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Techniker (Personen)</label>
                        <input type="number" id="cc-tech-staff" value="1" oninput="calculateCosts()">
                    </div>
                    <div class="form-group">
                        <label>CVD (Personen)</label>
                        <input type="number" id="cc-cvd-staff" value="1" oninput="calculateCosts()">
                    </div>
                </div>
                
                <h4 style="color: #8b5cf6; margin: 20px 0 10px;"> Fixkosten</h4>
                <div class="form-row">
                    <div class="form-group">
                        <label>Artist Fee ()</label>
                        <input type="number" id="cc-artist" value="2000" oninput="calculateCosts()">
                    </div>
                    <div class="form-group">
                        <label>GEMA/AKM ()</label>
                        <input type="number" id="cc-gema" value="500" oninput="calculateCosts()">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Marketing ()</label>
                        <input type="number" id="cc-marketing" value="300" oninput="calculateCosts()">
                    </div>
                    <div class="form-group">
                        <label>Sonstiges ()</label>
                        <input type="number" id="cc-other" value="200" oninput="calculateCosts()">
                    </div>
                </div>
                
                <div class="result-card" style="margin-top: 20px;">
                    <h4> Kalkulation</h4>
                    <div class="result-grid">
                        <div class="result-item">
                            <div class="label">Total Einnahmen</div>
                            <div class="value" id="cc-result-revenue">30.000</div>
                        </div>
                        <div class="result-item">
                            <div class="label">Personalkosten</div>
                            <div class="value red" id="cc-result-staff">3.150</div>
                        </div>
                        <div class="result-item">
                            <div class="label">Fixkosten</div>
                            <div class="value red" id="cc-result-fixed">3.000</div>
                        </div>
                        <div class="result-item">
                            <div class="label">Total Kosten</div>
                            <div class="value red" id="cc-result-costs">6.150</div>
                        </div>
                        <div class="result-item">
                            <div class="label">Deckungsbeitrag</div>
                            <div class="value" id="cc-result-profit">23.850</div>
                        </div>
                        <div class="result-item">
                            <div class="label">Marge</div>
                            <div class="value" id="cc-result-margin">79.5%</div>
                        </div>
                    </div>
                </div>
                <p class="form-hint" style="margin-top: 10px;"> Personalkosten-Logik wird noch angepasst. Aktuelle Pauschalen: Bar 150, Runner 120, Garderobe 100, Security 180, Technik 200, CVD 150</p>
            </div>
            <div class="modal-footer">
                <button class="modal-btn cancel" onclick="closeModal('cost-modal')">Schlieen</button>
            </div>
        </div>
    </div>
    
    <!-- Event Projector Modal -->
    <div class="modal-overlay" id="projector-modal">
        <div class="modal">
            <div class="modal-header green">
                <h3> Event Projector</h3>
                <button class="modal-close" onclick="closeModal('projector-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-row">
                    <div class="form-group">
                        <label>Event Serie</label>
                        <select id="ep-serie" onchange="updateProjectorData()">
                            <option value="turbo">TURBO</option>
                            <option value="selected">Selected</option>
                            <option value="halloween">Halloween</option>
                            <option value="birthday">Birthday</option>
                            <option value="nye">NYE / Silvester</option>
                            <option value="special">Special Events</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Kalenderwoche</label>
                        <select id="ep-kw" onchange="updateProjectorData()">
                            <option value="49">KW 49</option>
                            <option value="50">KW 50</option>
                            <option value="51">KW 51</option>
                            <option value="52" selected>KW 52</option>
                            <option value="1">KW 1</option>
                            <option value="2">KW 2</option>
                        </select>
                    </div>
                </div>
                
                <div class="result-card">
                    <h4> Serie Durchschnitt</h4>
                    <div class="result-grid">
                        <div class="result-item">
                            <div class="label"> VVK</div>
                            <div class="value blue" id="ep-avg-vvk">436</div>
                        </div>
                        <div class="result-item">
                            <div class="label"> FOH</div>
                            <div class="value blue" id="ep-avg-foh">336</div>
                        </div>
                        <div class="result-item">
                            <div class="label"> Total</div>
                            <div class="value blue" id="ep-avg-total">772</div>
                        </div>
                        <div class="result-item">
                            <div class="label">Events</div>
                            <div class="value orange" id="ep-events">25</div>
                        </div>
                    </div>
                </div>
                
                <div class="result-card">
                    <h4> KW Bar-Statistik</h4>
                    <div class="result-grid">
                        <div class="result-item">
                            <div class="label">/Person</div>
                            <div class="value orange" id="ep-bar-pp">16.3</div>
                        </div>
                        <div class="result-item">
                            <div class="label"> Bar Revenue</div>
                            <div class="value" id="ep-bar-rev">12.584</div>
                        </div>
                        <div class="result-item">
                            <div class="label"> Total Gste</div>
                            <div class="value blue" id="ep-bar-guests">772</div>
                        </div>
                    </div>
                </div>
                
                <h4 style="color: #22c55e; margin: 20px 0 10px;"> Projektion mit aktuellem VVK</h4>
                <div class="form-row">
                    <div class="form-group">
                        <label>Aktueller VVK Stand</label>
                        <input type="number" id="ep-current-vvk" value="0" oninput="updateProjectorProjection()">
                    </div>
                    <div class="form-group">
                        <label>Tage bis Event</label>
                        <input type="number" id="ep-days" value="7" oninput="updateProjectorProjection()">
                    </div>
                </div>
                
                <div class="result-card">
                    <h4> Projektion</h4>
                    <div class="result-grid">
                        <div class="result-item">
                            <div class="label">VVK Projektion</div>
                            <div class="value blue" id="ep-proj-vvk">~436</div>
                        </div>
                        <div class="result-item">
                            <div class="label">FOH Projektion</div>
                            <div class="value blue" id="ep-proj-foh">~336</div>
                        </div>
                        <div class="result-item">
                            <div class="label">Bar Projektion</div>
                            <div class="value orange" id="ep-proj-bar">~12.6k</div>
                        </div>
                        <div class="result-item">
                            <div class="label">Total Revenue</div>
                            <div class="value" id="ep-proj-total">~28k</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn cancel" onclick="closeModal('projector-modal')">Schlieen</button>
            </div>
        </div>
    </div>
    
    <!-- Factsheet Generator Modal -->
    <div class="modal-overlay" id="factsheet-modal">
        <div class="modal" style="max-width: 900px;">
            <div class="modal-header">
                <h3> Factsheet Generator</h3>
                <button class="modal-close" onclick="closeModal('factsheet-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-row">
                    <div class="form-group">
                        <label>Event auswhlen</label>
                        <select id="fs-event-select" onchange="loadEventData()">
                            <option value="">-- Event waehlen --</option>
                            <!-- Dynamic via populateFactsheetDropdown() -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Event Typ</label>
                        <select id="fs-template" onchange="updateFactsheetPreview()">
                            <option value="CLUB">Club Night</option>
                            <option value="CONCERT">Concert (Early Doors)</option>
                        </select>
                    </div>
                </div>
                <div class="form-row" id="main-floor-row">
                    <div class="form-group">
                        <label>Main Floor ffnung</label>
                        <div style="display: flex; gap: 15px; margin-top: 8px;">
                            <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; color: #fff;">
                                <input type="radio" name="main-floor-time" value="00:00" checked onchange="updateFactsheetPreview()"> 
                                <span>00:00</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; color: #fff;">
                                <input type="radio" name="main-floor-time" value="00:30" onchange="updateFactsheetPreview()"> 
                                <span>00:30</span>
                            </label>
                        </div>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Event Name</label>
                        <input type="text" id="fs-event-name" value="" oninput="updateFactsheetPreview()">
                    </div>
                    <div class="form-group">
                        <label>Datum</label>
                        <input type="text" id="fs-datum" value="" oninput="updateFactsheetPreview()">
                    </div>
                </div>
                
                <h4 style="color: #667eea; margin: 20px 0 10px;"> Personal + Zeiten <span style="font-size: 11px; color: #888; font-weight: normal;">(Zeiten anpassbar)</span></h4>
                
                <!-- CVD & Technik -->
                <div class="form-row" style="grid-template-columns: 1fr 80px 1fr 80px;">
                    <div class="form-group" style="margin-bottom: 8px;">
                        <label>CVD</label>
                        <input type="text" id="fs-cvd" value="Alain" oninput="updateFactsheetPreview()">
                    </div>
                    <div class="form-group" style="margin-bottom: 8px;">
                        <label>Zeit</label>
                        <input type="text" id="fs-cvd-time" value="20:30" class="time-input" oninput="updateFactsheetPreview()">
                    </div>
                    <div class="form-group" style="margin-bottom: 8px;">
                        <label>Technik</label>
                        <input type="text" id="fs-technik" value="Simon" oninput="updateFactsheetPreview()">
                    </div>
                    <div class="form-group" style="margin-bottom: 8px;">
                        <label>Zeit</label>
                        <input type="text" id="fs-technik-time" value="21:00" class="time-input" oninput="updateFactsheetPreview()">
                    </div>
                </div>
                
                <!-- KASSA (Eigenveranstaltung) -->
                <div class="form-row" id="kassa-row">
                    <div class="form-group" style="grid-column: span 4;">
                        <label> KASSA (Eigenveranstaltung)</label>
                        <div style="display: flex; gap: 20px; margin-top: 8px;">
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; color: #fff;">
                                <input type="checkbox" id="kassa-matthaeus" checked onchange="updateFactsheetPreview()"> 
                                <span>Matthus</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; color: #fff;">
                                <input type="checkbox" id="kassa-schadi" checked onchange="updateFactsheetPreview()"> 
                                <span>Schadi</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; color: #fff;">
                                <input type="checkbox" id="kassa-isa" checked onchange="updateFactsheetPreview()"> 
                                <span>Isa</span>
                            </label>
                        </div>
                        <small style="color: #888; margin-top: 5px; display: block;">Bei Fremdveranstaltungen wird automatisch "FREMD" eingetragen</small>
                    </div>
                </div>
                
                <!-- TERRASSE & KITCHEN -->
                <div class="form-row" style="grid-template-columns: 1fr 80px 1fr 80px;">
                    <div class="form-group" style="margin-bottom: 8px;">
                        <label>TERRASSE</label>
                        <input type="text" id="fs-terrasse" value="-" oninput="updateFactsheetPreview()">
                    </div>
                    <div class="form-group" style="margin-bottom: 8px;">
                        <label>Zeit</label>
                        <input type="text" id="fs-terrasse-time" value="22:00" class="time-input" oninput="updateFactsheetPreview()">
                    </div>
                    <div class="form-group" style="margin-bottom: 8px;">
                        <label>KITCHEN</label>
                        <input type="text" id="fs-kitchen" value="" oninput="updateFactsheetPreview()">
                    </div>
                    <div class="form-group" style="margin-bottom: 8px;">
                        <label>Zeit</label>
                        <input type="text" id="fs-kitchen-time" value="22:00" class="time-input" oninput="updateFactsheetPreview()">
                    </div>
                </div>
                
                <!-- MAIN 1-4 -->
                <div class="form-row" style="grid-template-columns: 1fr 80px 1fr 80px;">
                    <div class="form-group" style="margin-bottom: 8px;">
                        <label>MAIN 1</label>
                        <input type="text" id="fs-main1" value="" oninput="updateFactsheetPreview()">
                    </div>
                    <div class="form-group" style="margin-bottom: 8px;">
                        <label>Zeit</label>
                        <input type="text" id="fs-main1-time" value="22:30" class="time-input" oninput="updateFactsheetPreview()">
                    </div>
                    <div class="form-group" style="margin-bottom: 8px;">
                        <label>MAIN 2</label>
                        <input type="text" id="fs-main2" value="" oninput="updateFactsheetPreview()">
                    </div>
                    <div class="form-group" style="margin-bottom: 8px;">
                        <label>Zeit</label>
                        <input type="text" id="fs-main2-time" value="22:30" class="time-input" oninput="updateFactsheetPreview()">
                    </div>
                </div>
                <div class="form-row" style="grid-template-columns: 1fr 80px 1fr 80px;">
                    <div class="form-group" style="margin-bottom: 8px;">
                        <label>MAIN 3</label>
                        <input type="text" id="fs-main3" value="" oninput="updateFactsheetPreview()">
                    </div>
                    <div class="form-group" style="margin-bottom: 8px;">
                        <label>Zeit</label>
                        <input type="text" id="fs-main3-time" value="23:00" class="time-input" oninput="updateFactsheetPreview()">
                    </div>
                    <div class="form-group" style="margin-bottom: 8px;">
                        <label>MAIN 4</label>
                        <input type="text" id="fs-main4" value="" oninput="updateFactsheetPreview()">
                    </div>
                    <div class="form-group" style="margin-bottom: 8px;">
                        <label>Zeit</label>
                        <input type="text" id="fs-main4-time" value="23:45" class="time-input" oninput="updateFactsheetPreview()">
                    </div>
                </div>
                
                <!-- RUNNER 1-6 -->
                <div class="form-row" style="grid-template-columns: 1fr 80px 1fr 80px 1fr 80px;">
                    <div class="form-group" style="margin-bottom: 8px;">
                        <label>RUNNER 1</label>
                        <input type="text" id="fs-runner1" value="" oninput="updateFactsheetPreview()">
                    </div>
                    <div class="form-group" style="margin-bottom: 8px;">
                        <label>Zeit</label>
                        <input type="text" id="fs-runner1-time" value="21:00" class="time-input" oninput="updateFactsheetPreview()">
                    </div>
                    <div class="form-group" style="margin-bottom: 8px;">
                        <label>RUNNER 2</label>
                        <input type="text" id="fs-runner2" value="" oninput="updateFactsheetPreview()">
                    </div>
                    <div class="form-group" style="margin-bottom: 8px;">
                        <label>Zeit</label>
                        <input type="text" id="fs-runner2-time" value="21:00" class="time-input" oninput="updateFactsheetPreview()">
                    </div>
                    <div class="form-group" style="margin-bottom: 8px;">
                        <label>RUNNER 3</label>
                        <input type="text" id="fs-runner3" value="" oninput="updateFactsheetPreview()">
                    </div>
                    <div class="form-group" style="margin-bottom: 8px;">
                        <label>Zeit</label>
                        <input type="text" id="fs-runner3-time" value="21:00" class="time-input" oninput="updateFactsheetPreview()">
                    </div>
                </div>
                <div class="form-row" style="grid-template-columns: 1fr 80px 1fr 80px 1fr 80px;">
                    <div class="form-group" style="margin-bottom: 8px;">
                        <label>RUNNER 4</label>
                        <input type="text" id="fs-runner4" value="" oninput="updateFactsheetPreview()">
                    </div>
                    <div class="form-group" style="margin-bottom: 8px;">
                        <label>Zeit</label>
                        <input type="text" id="fs-runner4-time" value="22:00" class="time-input" oninput="updateFactsheetPreview()">
                    </div>
                    <div class="form-group" style="margin-bottom: 8px;">
                        <label>RUNNER 5</label>
                        <input type="text" id="fs-runner5" value="" oninput="updateFactsheetPreview()">
                    </div>
                    <div class="form-group" style="margin-bottom: 8px;">
                        <label>Zeit</label>
                        <input type="text" id="fs-runner5-time" value="00:00" class="time-input" oninput="updateFactsheetPreview()">
                    </div>
                    <div class="form-group" style="margin-bottom: 8px;">
                        <label>RUNNER 6</label>
                        <input type="text" id="fs-runner6" value="" oninput="updateFactsheetPreview()">
                    </div>
                    <div class="form-group" style="margin-bottom: 8px;">
                        <label>Zeit</label>
                        <input type="text" id="fs-runner6-time" value="00:00" class="time-input" oninput="updateFactsheetPreview()">
                    </div>
                </div>
                
                <!-- GARDEROBE 1-3 -->
                <div class="form-row" style="grid-template-columns: 1fr 80px 1fr 80px 1fr 80px;">
                    <div class="form-group" style="margin-bottom: 8px;">
                        <label>GARDEROBE 1</label>
                        <input type="text" id="fs-gard1" value="" oninput="updateFactsheetPreview()">
                    </div>
                    <div class="form-group" style="margin-bottom: 8px;">
                        <label>Zeit</label>
                        <input type="text" id="fs-gard1-time" value="22:45" class="time-input" oninput="updateFactsheetPreview()">
                    </div>
                    <div class="form-group" style="margin-bottom: 8px;">
                        <label>GARDEROBE 2</label>
                        <input type="text" id="fs-gard2" value="" oninput="updateFactsheetPreview()">
                    </div>
                    <div class="form-group" style="margin-bottom: 8px;">
                        <label>Zeit</label>
                        <input type="text" id="fs-gard2-time" value="23:00" class="time-input" oninput="updateFactsheetPreview()">
                    </div>
                    <div class="form-group" style="margin-bottom: 8px;">
                        <label>GARDEROBE 3</label>
                        <input type="text" id="fs-gard3" value="" oninput="updateFactsheetPreview()">
                    </div>
                    <div class="form-group" style="margin-bottom: 8px;">
                        <label>Zeit</label>
                        <input type="text" id="fs-gard3-time" value="00:15" class="time-input" oninput="updateFactsheetPreview()">
                    </div>
                </div>
                
                <h4 style="color: #667eea; margin: 20px 0 10px;"> Preview</h4>
                <div class="factsheet-preview" id="fs-preview">
                    <!-- Generated by JS -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn cancel" onclick="closeModal('factsheet-modal')">Schlieen</button>
                <button class="modal-btn primary" onclick="copyFactsheet()"> Kopieren</button>
                <button class="modal-btn success" onclick="printFactsheet()"> Drucken</button>
            </div>
        </div>
    </div>

    <!-- Email Composer Modal -->
    <div class="modal-overlay" id="email-modal">
        <div class="modal">
            <div class="modal-header" style="background: linear-gradient(135deg, #0078d4 0%, #106ebe 100%);">
                <h3> E-Mail senden</h3>
                <button class="modal-close" onclick="closeModal('email-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group" style="margin-bottom: 15px;">
                    <label>An (E-Mail)</label>
                    <input type="email" id="email-to" placeholder="empfaenger@example.com">
                </div>
                <div class="form-group" style="margin-bottom: 15px;">
                    <label>Betreff</label>
                    <input type="text" id="email-subject" placeholder="Betreff eingeben...">
                </div>
                <div class="form-group" style="margin-bottom: 15px;">
                    <label>Nachricht</label>
                    <textarea id="email-body" rows="8" placeholder="Nachricht eingeben..." style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #3d3d54; background: #1a1a2e; color: #fff; font-family: inherit; resize: vertical;"></textarea>
                </div>
                <p class="form-hint" id="email-status" style="color: #888; font-size: 12px;"></p>
            </div>
            <div class="modal-footer">
                <button class="modal-btn cancel" onclick="closeModal('email-modal')">Abbrechen</button>
                <button class="modal-btn" onclick="saveEmailDraft()" style="background: #6b7280;"> Als Entwurf</button>
                <button class="modal-btn primary" onclick="sendEmail()"> Senden</button>
            </div>
        </div>
    </div>

    
    
    <!--  -->
    <!-- APPLICATIONS EXPANDER -->
    <!--  -->
    
    <div class="tools-expander">
        <button class="tools-toggle" id="apps-toggle" onclick="toggleApps()" style="background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);">
             Applications <span class="arrow"></span>
        </button>
        <div class="tools-content" id="apps-content">
            <div class="tools-grid">
                <button class="tool-btn border-blue" onclick="openModal('factsheet-modal')">
                    <span class="tool-icon"></span>
                    Factsheet
                </button>
                <button class="tool-btn border-blue" onclick="openModal('email-modal')">
                    <span class="tool-icon"></span>
                    E-Mail
                </button>
                <div class="tool-btn border-blue dropdown-container" style="position: relative;">
                    <button class="tool-btn border-blue" onclick="toggleDropdown('social-dropdown')" style="width: 100%; border: none; padding: 0;">
                        <span class="tool-icon"></span>
                        Social 
                    </button>
                    <div id="social-dropdown" class="dropdown-content" style="top: 100%; left: 0; min-width: 100%;">
                        <a href="https://www.instagram.com/grelle_forelle/" class="dropdown-item" target="_blank"><span class="icon"></span> Instagram</a>
                        <a href="https://www.facebook.com/GrelleForelle/" class="dropdown-item" target="_blank"><span class="icon"></span> Facebook</a>
                        <a href="https://wa.me/" class="dropdown-item" target="_blank"><span class="icon"></span> WhatsApp</a>
                        <a href="https://club.bookmetender.com/dashboards" class="dropdown-item" target="_blank"><span class="icon"></span> BMT Dashboard</a>
                    </div>
                </div>
                <div class="tool-btn border-blue dropdown-container" style="position: relative;">
                    <button class="tool-btn border-blue" onclick="toggleDropdown('sales-dropdown')" style="width: 100%; border: none; padding: 0;">
                        <span class="tool-icon"></span>
                        Sales 
                    </button>
                    <div id="sales-dropdown" class="dropdown-content" style="top: 100%; left: 0; min-width: 100%;">
                        <a href="https://wbv.azurewebsites.net/default.aspx" class="dropdown-item" target="_blank"><span class="icon"></span> WBV (POS)</a>
                        <a href="https://linktr.ee/grelletickets" class="dropdown-item" target="_blank"><span class="icon"></span> Linktree</a>
                        <a href="https://ntry.at/my/events?l=de" class="dropdown-item" target="_blank"><span class="icon"></span> ntry (Pre-Sale)</a>
                        <a href="https://oeticket.light.oet.eu/dashboard" class="dropdown-item" target="_blank"><span class="icon"></span> OE TICKET</a>
                    </div>
                </div>
                <div class="tool-btn border-blue dropdown-container" style="position: relative;">
                    <button class="tool-btn border-blue" onclick="toggleDropdown('storage-dropdown')" style="width: 100%; border: none; padding: 0;">
                        <span class="tool-icon"></span>
                        Storage 
                    </button>
                    <div id="storage-dropdown" class="dropdown-content" style="top: 100%; left: 0; min-width: 100%;">
                        <a href="https://drive.google.com/drive/my-drive" class="dropdown-item" target="_blank"><span class="icon"></span> Google Drive</a>
                        <a href="https://onedrive.live.com" class="dropdown-item" target="_blank"><span class="icon"></span> OneDrive</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Tools Expander -->
    <div class="tools-expander">
        <button class="tools-toggle" id="tools-toggle" onclick="toggleTools()">
             Club Tools <span class="arrow"></span>
        </button>
        <div class="tools-content" id="tools-content">
            <div class="tools-grid">
                <button class="tool-btn border-white" onclick="openCleaningModal()">
                    <span class="tool-icon"></span>
                    Reinigung
                </button>
                <button class="tool-btn border-white" onclick="openModal('presale-modal')">
                    <span class="tool-icon"></span>
                    PreSale Calc
                </button>
                <button class="tool-btn border-white" onclick="openModal('cost-modal')">
                    <span class="tool-icon"></span>
                    Cost Calc
                </button>
                <button class="tool-btn border-white" onclick="openModal('projector-modal')">
                    <span class="tool-icon"></span>
                    Projector
                </button>
                <button class="tool-btn border-white" onclick="openDeepAnalysis()">
                    <span class="tool-icon"></span>
                    Deep Analysis
                </button>
                <button class="tool-btn border-white" onclick="openModal('guestlist-modal')">
                    <span class="tool-icon"></span>
                    Guest List
                </button>
                <button class="tool-btn border-white" onclick="openModal('bar-staffing-modal')">
                    <span class="tool-icon"></span>
                    Bar Staffing
                </button>
                <div class="tool-btn border-white dropdown-container" style="position: relative;">
                    <button class="tool-btn border-white" onclick="toggleDropdown('special-dropdown')" style="width: 100%; border: none; padding: 0;">
                        <span class="tool-icon"></span>
                        Special 
                    </button>
                    <div id="special-dropdown" class="dropdown-content" style="top: 100%; left: 0; min-width: 100%;">
                        <a href="#" class="dropdown-item" onclick="event.preventDefault(); openModal('peak-grid-modal');"><span class="icon"></span> Peak Grid</a>
                        <a href="#" class="dropdown-item" onclick="event.preventDefault(); openModal('nye-projector-modal');"><span class="icon"></span> NYE Projector</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Finance/Controlling/Operations Expander -->
    <div class="tools-expander">
        <button class="tools-toggle" id="finance-toggle" onclick="toggleFinanceTools()" style="background: linear-gradient(135deg, #059669 0%, #047857 100%);">
             Finance / Controlling / Operations <span class="arrow"></span>
        </button>
        <div class="tools-content" id="finance-content">
            <div class="tools-grid">
                <button class="tool-btn border-green" onclick="showToast(' Inventory Tool - Coming Soon!');">
                    <span class="tool-icon"></span>
                    Inventory & Restock
                </button>
                <button class="tool-btn border-green" onclick="showToast(' Financials - Coming Soon!');">
                    <span class="tool-icon"></span>
                    Financials
                </button>
            </div>
        </div>
    </div>
    
    <!--  -->
    <!-- OUTLOOK SECTION -->
    <!--  -->
    
    
    <!--  -->
    <!-- UPCOMING EVENTS (with integrated VVK Tracker per event) -->
    <!--  -->
    
    <div class="upcoming-events-section">
        <div class="upcoming-section-header" onclick="toggleUpcomingSection()">
            <div class="upcoming-title-row">
                <span class="upcoming-title">UPCOMING EVENTS</span>
                <span class="upcoming-count" id="upcoming-count">0</span>
            </div>
            <span class="upcoming-toggle" id="upcoming-toggle">v</span>
        </div>
        <div id="upcoming-events-container" class="upcoming-collapsed">
            <div class="upcoming-placeholder" id="upcoming-placeholder">
                <p>Upload BMT .ics Datei um Events zu sehen</p>
                <small>Events werden automatisch aus BookMeTender geladen</small>
            </div>
        </div>
    </div>
    
    <!-- CALENDAR SECTION -->
    <div class="calendar-section">
        <div class="calendar-section-header collapsed" onclick="toggleCalendarSection()">
            <div class="calendar-title-row">
                <span class="calendar-title"> Kalender</span>
            </div>
            <span class="calendar-toggle" id="calendar-toggle"></span>
        </div>
        <div id="calendar-container" class="calendar-collapsed">
            <div class="calendar-filters">
                <label class="calendar-filter-item">
                    <input type="checkbox" id="filter-eigen" checked onchange="renderCalendar()">
                    <span class="filter-dot eigen"></span>
                    Eigen
                </label>
                <label class="calendar-filter-item">
                    <input type="checkbox" id="filter-fremd" checked onchange="renderCalendar()">
                    <span class="filter-dot fremd"></span>
                    Fremd
                </label>
                <label class="calendar-filter-item">
                    <input type="checkbox" id="filter-konzert" checked onchange="renderCalendar()">
                    <span class="filter-dot konzert"></span>
                    Konzert
                </label>
                <label class="calendar-filter-item">
                    <input type="checkbox" id="filter-bmt" checked onchange="renderCalendar()">
                    <span class="filter-dot bmt"></span>
                    Specials
                </label>
                <label class="calendar-filter-item">
                    <input type="checkbox" id="filter-technik" checked onchange="renderCalendar()">
                    <span class="filter-dot technik"></span>
                    Technik
                </label>
                <label class="calendar-filter-item">
                    <input type="checkbox" id="filter-outlook" checked onchange="renderCalendar()">
                    <span class="filter-dot outlook"></span>
                    Outlook
                </label>
                <label class="calendar-filter-item">
                    <input type="checkbox" id="filter-feiertag" checked onchange="renderCalendar()">
                    <span class="filter-dot feiertag"></span>
                    Feiertag
                </label>
            </div>
            <div class="calendar-nav">
                <button class="calendar-nav-btn" onclick="changeCalendarMonth(-1)"> Zurck</button>
                <span class="calendar-month-title" id="calendar-month-title">Januar 2026</span>
                <button class="calendar-nav-btn" onclick="changeCalendarMonth(1)">Weiter </button>
            </div>
            <div class="calendar-grid" id="calendar-grid">
                <!-- Calendar days rendered by JS -->
            </div>
        </div>
    </div>
    
    <!-- DEPARTMENTS -->
    <!--  -->
    
    <div class="departments">
        <!-- OFFICE -->
        <div class="dept office">
            <div class="dept-header">
                <div class="dept-header-left"> OFFICE</div>
                <span class="task-count" id="office-task-count"></span>
            </div>
            <div class="dept-content">
                <div class="tasks-inline" id="office-tasks">
                    <div class="tasks-header" onclick="toggleTasksSection('office')">
                        <span> Tasks <span class="toggle-icon"></span></span>
                        <button class="refresh-btn" onclick="event.stopPropagation(); refreshTasks('office')"></button>
                    </div>
                    <div class="tasks-list" id="office-tasks-list">
                        <div class="tasks-login-prompt">
                            <p>Sign in to see your tasks</p>
                            <button onclick="handleAuth()"> Connect</button>
                        </div>
                    </div>
                </div>
                <div class="tasks-inline" id="office-notes">
                    <div class="tasks-header" onclick="toggleNotesSection()">
                        <span> Notes <span class="task-count" id="notes-count"></span> <span class="toggle-icon"></span></span>
                        <button class="refresh-btn" onclick="event.stopPropagation(); loadNotesList()"></button>
                    </div>
                    <div class="tasks-list" id="office-notes-list">
                        <div class="tasks-login-prompt">
                            <p>Sign in to see your notes</p>
                            <button onclick="handleAuth()"> Connect</button>
                        </div>
                    </div>
                </div>
                <button class="tasks-btn" onclick="openToDoList('office')"> Open in To Do</button>
            </div>
        </div>
        
        <!-- BAR -->
        <div class="dept bar">
            <div class="dept-header">
                <div class="dept-header-left"> BAR</div>
                <span class="task-count" id="bar-task-count"></span>
            </div>
            <div class="dept-content">
                <div class="collapsible-section">
                    <div class="section-label" onclick="toggleSection(this)">
                        <span> Shiftplan</span>
                        <span class="toggle-icon"></span>
                    </div>
                    <div class="section-content">
                        <div class="iframe-wrapper"><iframe src="https://docs.google.com/document/d/e/2PACX-1vQLF5-vQFf1CZ2tEyVyVdD7uO088yl8CWDlQdWa61m0uhEbOB9FWuDU2wVBkJH_XxJMW_B01QOKFyAr/pub?embedded=true"></iframe></div>
                    </div>
                </div>
                <div class="tasks-inline" id="bar-tasks">
                    <div class="tasks-header" onclick="toggleTasksSection('bar')">
                        <span> Tasks <span class="toggle-icon"></span></span>
                        <button class="refresh-btn" onclick="event.stopPropagation(); refreshTasks('bar')"></button>
                    </div>
                    <div class="tasks-list" id="bar-tasks-list">
                        <div class="tasks-login-prompt"><p>Sign in to see tasks</p><button onclick="handleAuth()"> Connect</button></div>
                    </div>
                </div>
                <button class="tasks-btn" onclick="openToDoList('bar')"> Open in To Do</button>
            </div>
        </div>
        
        <!-- RUNNER -->
        <div class="dept runner">
            <div class="dept-header">
                <div class="dept-header-left"> RUNNER</div>
                <span class="task-count" id="runner-task-count"></span>
            </div>
            <div class="dept-content">
                <div class="collapsible-section">
                    <div class="section-label" onclick="toggleSection(this)">
                        <span> Shiftplan</span>
                        <span class="toggle-icon"></span>
                    </div>
                    <div class="section-content">
                        <div class="shiftplan-table-container" id="runner-shiftplan-table"></div>
                    </div>
                </div>
                <div class="tasks-inline" id="runner-tasks">
                    <div class="tasks-header" onclick="toggleTasksSection('runner')">
                        <span> Tasks <span class="toggle-icon"></span></span>
                        <button class="refresh-btn" onclick="event.stopPropagation(); refreshTasks('runner')"></button>
                    </div>
                    <div class="tasks-list" id="runner-tasks-list">
                        <div class="tasks-login-prompt"><p>Sign in to see tasks</p><button onclick="handleAuth()"> Connect</button></div>
                    </div>
                </div>
                <button class="tasks-btn" onclick="openToDoList('runner')"> Open in To Do</button>
            </div>
        </div>
        
        <!-- TECHNIK -->
        <div class="dept technik">
            <div class="dept-header">
                <div class="dept-header-left"> TECHNIK</div>
                <span class="task-count" id="technik-task-count"></span>
            </div>
            <div class="dept-content">
                <div class="collapsible-section">
                    <div class="section-label" onclick="toggleSection(this)">
                        <span> Technikerkalender</span>
                        <span class="toggle-icon"></span>
                    </div>
                    <div class="section-content">
                        <div class="shiftplan-table-container" id="technik-calendar-list">
                            <!-- Dynamic content loaded by renderTechnikCalendar() -->
                        </div>
                    </div>
                </div>
                <div class="tasks-inline" id="technik-tasks">
                    <div class="tasks-header" onclick="toggleTasksSection('technik')">
                        <span> Tasks <span class="toggle-icon"></span></span>
                        <button class="refresh-btn" onclick="event.stopPropagation(); refreshTasks('technik')"></button>
                    </div>
                    <div class="tasks-list" id="technik-tasks-list">
                        <div class="tasks-login-prompt"><p>Sign in to see tasks</p><button onclick="handleAuth()"> Connect</button></div>
                    </div>
                </div>
                <button class="tasks-btn" onclick="openToDoList('technik')"> Open in To Do</button>
            </div>
        </div>
        
        <!-- SPUTNIK -->
        <div class="dept sputnik">
            <div class="dept-header">
                <div class="dept-header-left"> SPUTNIK BAR</div>
                <span class="task-count" id="sputnik-task-count"></span>
            </div>
            <div class="dept-content">
                <div class="collapsible-section">
                    <div class="section-label" onclick="toggleSection(this)">
                        <span> Reservierungen</span>
                        <span class="toggle-icon"></span>
                    </div>
                    <div class="section-content">
                        <div id="sputnik-reservations-container" style="padding: 10px;">
                            <div style="text-align: center; color: #888; font-size: 13px;">
                                <p> Reservierungen aus Google Calendar</p>
                                <button onclick="loadSputnikReservations()" style="margin-top: 10px; background: #8E24AA; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;"> Laden</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="collapsible-section">
                    <div class="section-label" onclick="toggleSection(this)">
                        <span> Shiftplan</span>
                        <span class="toggle-icon"></span>
                    </div>
                    <div class="section-content">
                        <div class="iframe-wrapper"><iframe src="https://docs.google.com/document/d/e/2PACX-1vTayJTFCmEUh8Nh3QWQS6EfC15Q0dHBpc8GH_iC8A-yOlqIn6ARYW5XF0TmGQnWWgKqqfDMQp19i7iw/pub?embedded=true"></iframe></div>
                    </div>
                </div>
                <div class="tasks-inline" id="sputnik-tasks">
                    <div class="tasks-header" onclick="toggleTasksSection('sputnik')">
                        <span> Tasks <span class="toggle-icon"></span></span>
                        <button class="refresh-btn" onclick="event.stopPropagation(); refreshTasks('sputnik')"></button>
                    </div>
                    <div class="tasks-list" id="sputnik-tasks-list">
                        <div class="tasks-login-prompt"><p>Sign in to see tasks</p><button onclick="handleAuth()"> Connect</button></div>
                    </div>
                </div>
                <button class="tasks-btn" onclick="openToDoList('sputnik')"> Open in To Do</button>
            </div>
        </div>
    </div>
    
    <div class="footer">
        <a href="https://to-do.live.com" target="_blank"> Open Microsoft To Do</a>
    </div>
    
    <div class="version">Work Hub v15.2.3 - 07.01.2026 - Calendar Filters + Compact Technik</div>

    <script>
        // 
        // MSAL CONFIG
        // 
        
        const msalConfig = {
            auth: {
                clientId: "0fc00e3e-4ff3-4806-ae4a-222d1abee84b",
                authority: "https://login.microsoftonline.com/common",
                redirectUri: window.location.origin + window.location.pathname
            },
            cache: { cacheLocation: "localStorage", storeAuthStateInCookie: false }
        };
        
        const loginRequest = { scopes: ["Tasks.ReadWrite", "User.Read", "Mail.Send", "Mail.ReadWrite"] };
        
        const TODO_LISTS = {
            office: "AQMkADAwATM0MDAAMS0yZjI4LTJjYTktMDACLTAwCgAuAAADxd_TrPbkZEisrfPVcCAWnQEArwnaZSdg_UuQLE65Sg5hCAAEqn88jwAAAA==",
            bar: "AQMkADAwATM0MDAAMS0yZjI4LTJjYTktMDACLTAwCgAuAAADxd_TrPbkZEisrfPVcCAWnQEArwnaZSdg_UuQLE65Sg5hCAAEqb6E7QAAAA==",
            runner: "AQMkADAwATM0MDAAMS0yZjI4LTJjYTktMDACLTAwCgAuAAADxd_TrPbkZEisrfPVcCAWnQEArwnaZSdg_UuQLE65Sg5hCAAEqb6E7gAAAA==",
            technik: "AQMkADAwATM0MDAAMS0yZjI4LTJjYTktMDACLTAwCgAuAAADxd_TrPbkZEisrfPVcCAWnQEArwnaZSdg_UuQLE65Sg5hCAAEqb6E7wAAAA==",
            sputnik: "AQMkADAwATM0MDAAMS0yZjI4LTJjYTktMDACLTAwCgAuAAADxd_TrPbkZEisrfPVcCAWnQEArwnaZSdg_UuQLE65Sg5hCAAEqb6E8AAAAA=="
        };
        
        let msalInstance = null;
        let accessToken = null;
        
        // 
        // DATA
        // 
        
        const SERIE_STATS = {
            turbo: { avgVVK: 436, avgFOH: 336, avgTotal: 772, barPP: 15.3, events: 25 },
            selected: { avgVVK: 416, avgFOH: 336, avgTotal: 752, barPP: 16.9, events: 9 },
            halloween: { avgVVK: 527, avgFOH: 489, avgTotal: 1016, barPP: 16.4, events: 4 },
            birthday: { avgVVK: 499, avgFOH: 427, avgTotal: 926, barPP: 17.2, events: 7 },
            nye: { avgVVK: 562, avgFOH: 649, avgTotal: 1211, barPP: 19.5, events: 1 },
            special: { avgVVK: 457, avgFOH: 373, avgTotal: 830, barPP: 17.5, events: 11 }
        };
        
        const KW_STATS = {
            49: { barPP: 16.9 }, 50: { barPP: 17.0 }, 51: { barPP: 17.3 },
            52: { barPP: 16.3 }, 1: { barPP: 17.7 }, 2: { barPP: 16.5 }
        };
        
        const VVK_BENCHMARKS = { 14: 0.35, 10: 0.42, 7: 0.50, 5: 0.55, 3: 0.65, 2: 0.72, 1: 0.80, 0: 0.85 };
        
        // Capacity Caps (basierend auf historischen Daten - 76 Events)
        const CAPACITY_CAPS = {
            MAX_VVK: 600,      // Historisch max: 573
            MAX_FOH: 700,      // Historisch max: 649
            MAX_TOTAL: 1250    // Historisch max: 1211
        };
        
        const EVENT_CONFIG = {
            turbo: { date: new Date('2025-12-27'), serie: 'turbo', kw: 52 },
            nye: { date: new Date('2025-12-31'), serie: 'nye', kw: 52 }
        };
        
        const TEMPLATES = {
            MAIN_00: {
                doors1: "23:00", terrasse: "22:00", doors2_early: "23:00", kitchen: "22:00",
                doors2_late: "00:00", main1: "22:30", main2: "22:30", main3: "23:00", main4: "23:45",
                runner1: "21:00", runner2: "21:00", runner3: "21:00", runner4: "22:00", runner5: "00:00", runner6: "00:00",
                gard1: "22:45", gard2: "23:00", gard3: "00:15", technik: "21:00",
                security: [{ time: "22:45", pax: "1 PAX" }, { time: "23:00", pax: "1 PAX" }, { time: "23:30", pax: "1 PAX" }, { time: "00:00", pax: "3 PAX" }, { time: "01:00", pax: "1 PAX (Abruf)" }]
            },
            MAIN_30: {
                doors1: "23:00", terrasse: "22:00", doors2_early: "23:00", kitchen: "22:00",
                doors2_late: "00:30", main1: "23:00", main2: "23:00", main3: "23:30", main4: "00:15",
                runner1: "21:00", runner2: "21:00", runner3: "21:00", runner4: "22:00", runner5: "00:00", runner6: "00:00",
                gard1: "22:45", gard2: "23:00", gard3: "00:15", technik: "21:00",
                security: [{ time: "22:45", pax: "1 PAX" }, { time: "23:00", pax: "1 PAX" }, { time: "23:30", pax: "1 PAX" }, { time: "00:30", pax: "3 PAX" }, { time: "01:00", pax: "1 PAX (Abruf)" }]
            },
            CONCERT: {
                doors1: "19:00", terrasse: "18:30", doors2_early: "19:00", kitchen: "18:30",
                doors2_late: "19:00", main1: "19:00", main2: "19:00", main3: "19:00", main4: "19:00",
                runner1: "17:00", runner2: "17:00", runner3: "17:00", runner4: "18:00", runner5: "20:00", runner6: "20:00",
                gard1: "18:45", gard2: "19:00", gard3: "20:15", technik: "16:00",
                security: [{ time: "18:45", pax: "1 PAX" }, { time: "19:00", pax: "2 PAX" }, { time: "19:30", pax: "1 PAX" }, { time: "19:45", pax: "1 PAX" }, { time: "20:30", pax: "1 PAX (Abruf)" }]
            }
        };
        
        const EIGENVERANSTALTUNGEN = ['turbo', 'selected', 'halloween', 'nye', 'silvester', 'birthday', 'x-mas', 'sommerfest'];
        
        // 
        // MSAL AUTH
        // 
        
        async function initMsal() {
            // Check if MSAL library loaded
            if (typeof msal === 'undefined') {
                console.error('MSAL library not loaded!');
                document.getElementById('auth-status-text').textContent = ' Auth Library fehlt';
                return;
            }
            
            try {
                console.log('Initializing MSAL...');
                msalInstance = new msal.PublicClientApplication(msalConfig);
                await msalInstance.initialize();
                console.log('MSAL initialized successfully');
                
                // Check for existing session
                const accounts = msalInstance.getAllAccounts();
                if (accounts.length > 0) {
                    try {
                        const silentResponse = await msalInstance.acquireTokenSilent({ ...loginRequest, account: accounts[0] });
                        accessToken = silentResponse.accessToken;
                        console.log('Silent token scopes:', silentResponse.scopes);
                        updateAuthUI(accounts[0]);
                        loadAllData();
                    } catch (e) { 
                        console.log("Silent token failed, need re-login:", e.message);
                        updateAuthUI(null);
                    }
                }
            } catch (error) { console.error("MSAL init error:", error); }
        }
        
        async function handleAuth() {
            // Check if MSAL is ready
            if (!msalInstance) {
                console.error('MSAL not initialized yet');
                showToast("Bitte warten, Auth laedt...", true);
                // Try to initialize again
                await initMsal();
                if (!msalInstance) {
                    showToast("Auth Library nicht geladen. Seite neu laden.", true);
                    return;
                }
            }
            
            if (accessToken) {
                // Logout
                try {
                    await msalInstance.logoutPopup();
                } catch(e) { console.log('Logout error:', e); }
                accessToken = null;
                updateAuthUI(null);
                resetAllUI();
            } else {
                try {
                    // Use popup (works in iframes)
                    const response = await msalInstance.loginPopup({ ...loginRequest, prompt: 'consent' });
                    accessToken = response.accessToken;
                    console.log('=== LOGIN SUCCESS (POPUP) ===');
                    console.log('Scopes granted:', response.scopes);
                    console.log('Account:', response.account?.username);
                    updateAuthUI(response.account);
                    loadAllData();
                    showToast(" Verbunden!");
                } catch (error) { 
                    console.error("Login error:", error); 
                    showToast(" Login fehlgeschlagen", true); 
                }
            }
        }
        
        
        // Force sign out and re-authenticate (for permission updates)
        async function handleSignOut() {
            showToast(" Melde ab und aktualisiere Berechtigungen...");
            try {
                if (msalInstance) {
                    await msalInstance.logoutPopup();
                }
            } catch(e) { console.log('Logout error:', e); }
            
            accessToken = null;
            updateAuthUI(null);
            resetAllUI();
            
            // Small delay then prompt re-login
            setTimeout(async () => {
                try {
                    const response = await msalInstance.loginPopup({ ...loginRequest, prompt: 'consent' });
                    accessToken = response.accessToken;
                    console.log('=== RE-LOGIN SUCCESS ===');
                    console.log('New scopes granted:', response.scopes);
                    updateAuthUI(response.account);
                    loadAllData();
                    showToast(" Neu verbunden mit aktualisierten Berechtigungen!");
                } catch (error) {
                    console.error("Re-login error:", error);
                    showToast(" Re-Login fehlgeschlagen", true);
                }
            }, 500);
        }
        
        async function forceResetAuth() {
            // Clear everything and start fresh
            showToast(" Cache wird gelscht...");
            
            // Clear MSAL cache
            if (msalInstance) {
                const accounts = msalInstance.getAllAccounts();
                for (const account of accounts) {
                    try {
                        await msalInstance.clearCache();
                    } catch(e) { console.log('Cache clear error:', e); }
                }
            }
            
            // Clear localStorage
            localStorage.clear();
            sessionStorage.clear();
            
            // Reset state
            accessToken = null;
            updateAuthUI(null);
            resetAllUI();
            
            showToast(" Cache gelscht! Seite wird neu geladen...");
            
            // Reload page to ensure clean state
            setTimeout(() => location.reload(), 1000);
        }
        
        function updateAuthUI(account) {
            const dot = document.getElementById('auth-dot');
            const statusText = document.getElementById('auth-status-text');
            const userText = document.getElementById('auth-user');
            const authBtn = document.getElementById('auth-btn');
            if (account) {
                dot.classList.add('connected');
                statusText.textContent = 'Connected';
                userText.textContent = account.username || '';
                authBtn.innerHTML = ' Sign out';
                authBtn.classList.add('logout');
            } else {
                dot.classList.remove('connected');
                statusText.textContent = 'Not connected';
                userText.textContent = '';
                authBtn.innerHTML = ' Sign in';
                authBtn.classList.remove('logout');
            }
        }
        
        function loadAllData() { 
            console.log('loadAllData: Starting with token:', accessToken ? 'YES' : 'NO');
            if (!accessToken) {
                console.log('loadAllData: No token, skipping');
                return;
            }
            console.log('loadAllData: Calling loadAllTasks...');
            loadAllTasks();
            // Load Notes list
            loadNotesList();
            // Sync Quick Notes from To Do
            loadQuickNotesFromToDo();
        }
        
        function resetAllUI() {
            ['office', 'bar', 'runner', 'technik', 'sputnik'].forEach(d => {
                document.getElementById(`${d}-task-count`).textContent = '';
                document.getElementById(`${d}-tasks-list`).innerHTML = '<div class="tasks-login-prompt"><p>Sign in</p><button onclick="handleAuth()"></button></div>';
            });
            // Reset Notes section
            document.getElementById('notes-count').textContent = '';
            document.getElementById('office-notes-list').innerHTML = '<div class="tasks-login-prompt"><p>Sign in</p><button onclick="handleAuth()"></button></div>';
        }
        
        // 
        // TASKS
        // 
        
        async function loadAllTasks() {
            if (!accessToken) return;
            for (const d of ['office', 'bar', 'runner', 'technik', 'sputnik']) await loadTasks(d);
        }
        
        async function loadTasks(dept) {
            if (!accessToken) return;
            const listId = TODO_LISTS[dept];
            const countEl = document.getElementById(`${dept}-task-count`);
            const listEl = document.getElementById(`${dept}-tasks-list`);
            countEl.textContent = '...';
            try {
                const r = await fetch(`https://graph.microsoft.com/v1.0/me/todo/lists/${listId}/tasks?$filter=status ne 'completed'&$orderby=importance desc&$top=10`, {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });
                const data = await r.json();
                const tasks = data.value || [];
                countEl.textContent = tasks.length || '';
                listEl.innerHTML = tasks.length ? tasks.map(t => {
                    let dueClass = '', dueText = '';
                    if (t.dueDateTime) {
                        const due = new Date(t.dueDateTime.dateTime + 'Z');
                        const today = new Date(); today.setHours(0,0,0,0);
                        if (due < today) { dueClass = 'overdue'; dueText = 'berfllig'; }
                        else if (due.toDateString() === today.toDateString()) { dueClass = 'today'; dueText = 'Heute'; }
                        else dueText = due.toLocaleDateString('de-DE');
                    }
                    return `<div class="task-item" data-id="${t.id}" data-dept="${dept}">
                        <div class="task-checkbox" onclick="completeTask('${t.id}','${dept}')"></div>
                        <div class="task-info"><div class="task-title">${esc(t.title)}</div>${dueText ? `<div class="task-due ${dueClass}">${dueText}</div>` : ''}</div>
                        ${t.importance === 'high' ? '<div class="task-importance high"></div>' : ''}
                    </div>`;
                }).join('') : '<div class="tasks-empty"> Alles erledigt!</div>';
            } catch (e) { countEl.textContent = '!'; listEl.innerHTML = '<div class="tasks-empty"></div>'; }
        }
        
        async function completeTask(taskId, dept) {
            const el = document.querySelector(`[data-id="${taskId}"]`);
            el.querySelector('.task-checkbox').classList.add('checked');
            try {
                await fetch(`https://graph.microsoft.com/v1.0/me/todo/lists/${TODO_LISTS[dept]}/tasks/${taskId}`, {
                    method: 'PATCH',
                    headers: { 'Authorization': `Bearer ${accessToken}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: 'completed' })
                });
                showToast(" Erledigt!");
                setTimeout(() => loadTasks(dept), 500);
            } catch (e) { el.querySelector('.task-checkbox').classList.remove('checked'); }
        }
        
        function refreshTasks(d) { const b = document.querySelector(`#${d}-tasks .refresh-btn`); b.classList.add('spinning'); loadTasks(d).then(() => b.classList.remove('spinning')); }
        function openToDoList(d) { window.open(`https://to-do.live.com/tasks/${TODO_LISTS[d]}`, '_blank'); }
        
        // 
        // NOTES LIST (Office)
        // 
        
        async function loadNotesList() {
            if (!accessToken) return;
            
            const countEl = document.getElementById('notes-count');
            const listEl = document.getElementById('office-notes-list');
            
            try {
                const listId = await getOrCreateNotesList();
                if (!listId) {
                    listEl.innerHTML = '<div class="task-item" style="color: #888;">Notes list not found</div>';
                    return;
                }
                
                const response = await fetch(
                    `https://graph.microsoft.com/v1.0/me/todo/lists/${listId}/tasks?$filter=status ne 'completed'&$orderby=createdDateTime desc&$top=20`,
                    { headers: { 'Authorization': 'Bearer ' + accessToken } }
                );
                const data = await response.json();
                const notes = data.value || [];
                
                countEl.textContent = notes.length;
                
                if (notes.length === 0) {
                    listEl.innerHTML = '<div class="task-item" style="color: #888;">Keine Notes vorhanden</div>';
                    return;
                }
                
                // Fetch checklist items for each note
                const notesWithChecklists = await Promise.all(notes.map(async (note) => {
                    try {
                        const checklistResponse = await fetch(
                            `https://graph.microsoft.com/v1.0/me/todo/lists/${listId}/tasks/${note.id}/checklistItems`,
                            { headers: { 'Authorization': 'Bearer ' + accessToken } }
                        );
                        const checklistData = await checklistResponse.json();
                        note.checklistItems = checklistData.value || [];
                        console.log('Note:', note.title, 'Checklist items:', note.checklistItems.length);
                    } catch (e) {
                        console.error('Checklist fetch error:', e);
                        note.checklistItems = [];
                    }
                    return note;
                }));
                
                listEl.innerHTML = notesWithChecklists.map(note => {
                    const title = note.title || 'Untitled';
                    const body = note.body?.content ? note.body.content.replace(/<[^>]*>/g, '') : '';
                    const created = note.createdDateTime ? new Date(note.createdDateTime).toLocaleDateString('de-AT') : '';
                    const hasChecklist = note.checklistItems && note.checklistItems.length > 0;
                    const hasDetails = body.length > 0 || hasChecklist;
                    
                    console.log('Note render:', title, 'hasChecklist:', hasChecklist, 'hasDetails:', hasDetails, 'body:', body.substring(0, 50));
                    
                    let checklistHtml = '';
                    if (hasChecklist) {
                        checklistHtml = '<div class="note-checklist">' +
                            note.checklistItems.map(item => 
                                '<div class="checklist-item ' + (item.isChecked ? 'checked' : '') + '">' +
                                '<span class="checklist-bullet">' + (item.isChecked ? '' : '') + '</span>' +
                                '<span>' + item.displayName + '</span>' +
                                '</div>'
                            ).join('') +
                        '</div>';
                    }
                    
                    const noteId = note.id;
                    
                    let html = '<div class="note-item-container" data-noteid="' + noteId + '">';
                    html += '<div class="task-item note-item" style="cursor:pointer;" onclick="noteToggle(this)">';
                    html += '<div class="task-checkbox" onclick="event.stopPropagation(); noteComplete(\'' + noteId + '\', this)"></div>';
                    html += '<div class="task-info">';
                    if (hasDetails) {
                        html += '<div class="task-title"><span class="note-toggle-icon"></span> ' + title + '</div>';
                    } else {
                        html += '<div class="task-title">' + title + '</div>';
                    }
                    html += '<div class="task-due" style="color: #667eea;">' + created + '</div>';
                    html += '</div></div>';
                    
                    if (hasDetails) {
                        html += '<div class="note-details-box" style="display:none; background:#1a1a2e; border-left:3px solid #8b5cf6; margin-left:30px; padding:10px 12px; border-radius:0 8px 8px 0; margin-bottom:5px;">';
                        if (body) {
                            html += '<div style="color:#9ca3af; font-size:12px; line-height:1.5; margin-bottom:8px; white-space:pre-wrap;">' + body + '</div>';
                        }
                        html += checklistHtml;
                        html += '</div>';
                    }
                    
                    html += '</div>';
                    return html;
                }).join('');
                
            } catch (err) {
                console.error('Failed to load notes:', err);
                listEl.innerHTML = '<div class="task-item" style="color: #ef4444;">Error loading notes</div>';
            }
        }
        
        function noteToggle(el) {
            console.log('noteToggle called', el);
            // el is the clicked task-item div
            var container = el.closest('.note-item-container');
            console.log('container:', container);
            if (!container) return;
            
            var details = container.querySelector('.note-details-box');
            var icon = container.querySelector('.note-toggle-icon');
            console.log('details element:', details);
            
            if (!details) {
                console.log('No details box found');
                return; // No details to show
            }
            
            var isOpen = details.classList.contains('open');
            console.log('isOpen:', isOpen);
            
            if (isOpen) {
                details.classList.remove('open');
                details.style.display = 'none';
                if (icon) icon.textContent = '';
            } else {
                details.classList.add('open');
                details.style.display = 'block';
                if (icon) icon.textContent = '';
            }
        }
        
        async function noteComplete(noteId, checkboxEl) {
            if (!accessToken) return;
            checkboxEl.classList.add('checked');
            try {
                const listId = await getOrCreateNotesList();
                await fetch('https://graph.microsoft.com/v1.0/me/todo/lists/' + listId + '/tasks/' + noteId, {
                    method: 'PATCH',
                    headers: { 'Authorization': 'Bearer ' + accessToken, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: 'completed' })
                });
                showToast(" Note erledigt!");
                setTimeout(function() { loadNotesList(); }, 500);
            } catch (e) { 
                checkboxEl.classList.remove('checked'); 
            }
        }
        
        function toggleNotesSection() {
            const header = document.querySelector('#office-notes .tasks-header');
            const list = document.getElementById('office-notes-list');
            header.classList.toggle('open');
            list.classList.toggle('open');
        }
        
        // 
        // PRESALE CALCULATOR
        // 
        
        function calculatePreSale() {
            const fohTickets = parseInt(document.getElementById('ps-foh-tickets').value) || 350;
            const doorPrice = parseInt(document.getElementById('ps-door-price').value) || 22;
            
            // Sum all VVK phases
            const rows = document.querySelectorAll('#ps-phases-body tr');
            let totalVVK = 0, totalVVKRev = 0;
            rows.forEach(row => {
                const tickets = parseInt(row.querySelector('.ps-tickets').value) || 0;
                const price = parseInt(row.querySelector('.ps-price').value) || 0;
                const rev = tickets * price;
                row.querySelector('.phase-revenue').textContent = '' + rev.toLocaleString();
                totalVVK += tickets;
                totalVVKRev += rev;
            });
            
            const fohRev = fohTickets * doorPrice;
            const avgVvk = totalVVK > 0 ? (totalVVKRev / totalVVK).toFixed(2) : 0;
            const totalTickets = totalVVK + fohTickets;
            const totalRev = totalVVKRev + fohRev;
            
            document.getElementById('ps-result-vvk').textContent = totalVVK;
            document.getElementById('ps-result-vvk-rev').textContent = '' + totalVVKRev.toLocaleString();
            document.getElementById('ps-result-avg').textContent = '' + avgVvk;
            document.getElementById('ps-result-foh').textContent = fohTickets;
            document.getElementById('ps-result-foh-rev').textContent = '' + fohRev.toLocaleString();
            document.getElementById('ps-result-total').textContent = '' + totalRev.toLocaleString();
        }
        
        // 
        // COST CALCULATOR
        // 
        
        function calculateCosts() {
            const ticketRev = parseInt(document.getElementById('cc-ticket-rev').value) || 0;
            const barRev = parseInt(document.getElementById('cc-bar-rev').value) || 0;
            const totalRev = ticketRev + barRev;
            
            // Staff costs (rough estimates)
            const barStaff = (parseInt(document.getElementById('cc-bar-staff').value) || 0) * 150;
            const runnerStaff = (parseInt(document.getElementById('cc-runner-staff').value) || 0) * 120;
            const gardStaff = (parseInt(document.getElementById('cc-garderobe-staff').value) || 0) * 100;
            const secStaff = (parseInt(document.getElementById('cc-security-staff').value) || 0) * 180;
            const techStaff = (parseInt(document.getElementById('cc-tech-staff').value) || 0) * 200;
            const cvdStaff = (parseInt(document.getElementById('cc-cvd-staff').value) || 0) * 150;
            const staffCosts = barStaff + runnerStaff + gardStaff + secStaff + techStaff + cvdStaff;
            
            // Fixed costs
            const artist = parseInt(document.getElementById('cc-artist').value) || 0;
            const gema = parseInt(document.getElementById('cc-gema').value) || 0;
            const marketing = parseInt(document.getElementById('cc-marketing').value) || 0;
            const other = parseInt(document.getElementById('cc-other').value) || 0;
            const fixedCosts = artist + gema + marketing + other;
            
            const totalCosts = staffCosts + fixedCosts;
            const profit = totalRev - totalCosts;
            const margin = totalRev > 0 ? ((profit / totalRev) * 100).toFixed(1) : 0;
            
            document.getElementById('cc-result-revenue').textContent = `${totalRev.toLocaleString()}`;
            document.getElementById('cc-result-staff').textContent = `${staffCosts.toLocaleString()}`;
            document.getElementById('cc-result-fixed').textContent = `${fixedCosts.toLocaleString()}`;
            document.getElementById('cc-result-costs').textContent = `${totalCosts.toLocaleString()}`;
            document.getElementById('cc-result-profit').textContent = `${profit.toLocaleString()}`;
            document.getElementById('cc-result-profit').className = `value ${profit >= 0 ? '' : 'red'}`;
            document.getElementById('cc-result-margin').textContent = `${margin}%`;
        }
        
        // 
        // EVENT PROJECTOR
        // 
        
        function updateProjectorData() {
            const serie = document.getElementById('ep-serie').value;
            const kw = document.getElementById('ep-kw').value;
            const s = SERIE_STATS[serie];
            const k = KW_STATS[kw] || { barPP: 16.5 };
            
            document.getElementById('ep-avg-vvk').textContent = s.avgVVK;
            document.getElementById('ep-avg-foh').textContent = s.avgFOH;
            document.getElementById('ep-avg-total').textContent = s.avgTotal;
            document.getElementById('ep-events').textContent = s.events;
            document.getElementById('ep-bar-pp').textContent = `${k.barPP}`;
            document.getElementById('ep-bar-rev').textContent = `${Math.round(s.avgTotal * k.barPP).toLocaleString()}`;
            document.getElementById('ep-bar-guests').textContent = s.avgTotal;
            
            updateProjectorProjection();
        }
        
        function updateProjectorProjection() {
            const serie = document.getElementById('ep-serie').value;
            const kw = document.getElementById('ep-kw').value;
            const currentVVK = parseInt(document.getElementById('ep-current-vvk').value) || 0;
            const days = parseInt(document.getElementById('ep-days').value) || 7;
            
            const s = SERIE_STATS[serie];
            const k = KW_STATS[kw] || { barPP: 16.5 };
            const fohRatio = s.avgFOH / s.avgVVK;
            
            let pct = 0.5;
            for (const d of [14, 10, 7, 5, 3, 2, 1, 0]) { if (days >= d) { pct = VVK_BENCHMARKS[d]; break; } }
            
            const projVVK = currentVVK > 0 ? Math.round(currentVVK / pct) : s.avgVVK;
            const projFOH = Math.round(projVVK * fohRatio);
            const projBar = (projVVK + projFOH) * k.barPP;
            const projTotal = projBar + (projVVK * 18) + (projFOH * 22);
            
            document.getElementById('ep-proj-vvk').textContent = `~${projVVK}`;
            document.getElementById('ep-proj-foh').textContent = `~${projFOH}`;
            document.getElementById('ep-proj-bar').textContent = `~${(projBar/1000).toFixed(1)}k`;
            document.getElementById('ep-proj-total').textContent = `~${(projTotal/1000).toFixed(0)}k`;
        }
        
        // 
        // FACTSHEET GENERATOR
        // 
        
        // === DYNAMIC FACTSHEET DROPDOWN v14.9.11 ===
        function populateFactsheetDropdown() {
            const select = document.getElementById('fs-event-select');
            if (!select) { 
                console.log('Factsheet select element not found'); 
                return; 
            }
            
            select.innerHTML = '<option value="">-- Event waehlen --</option>';
            
            // Use global bmtEvents (already has Date objects) instead of re-parsing from localStorage
            if (!bmtEvents || bmtEvents.length === 0) { 
                console.log('No bmtEvents loaded - load BMT first');
                select.innerHTML += '<option disabled>Bitte BMT Events laden</option>';
                return; 
            }
            
            console.log('Using ' + bmtEvents.length + ' events from global bmtEvents');
            
            const now = new Date();
            
            // Filter: FUTURE events only, no holiday/closed
            const futureEvents = bmtEvents.filter(e => {
                const eventDate = e.dtstart instanceof Date ? e.dtstart : new Date(e.dtstart);
                if (isNaN(eventDate.getTime())) return false;
                
                const summaryLower = (e.summary || e.name || '').toLowerCase();
                const cat = e.category || '';
                
                // Only show EIGEN, FREMD, KONZERT
                const isEvent = cat === 'eigen' || cat === 'fremd' || cat === 'konzert';
                const isNotHoliday = cat !== 'holiday' && !summaryLower.includes('holiday');
                const isNotClosed = !summaryLower.includes('geschlossen') && !summaryLower.includes('closed');
                const isNotAppointment = !summaryLower.includes('termin') && !summaryLower.includes('meeting');
                
                // CRITICAL: Only future events (eventDate >= now)
                const isFuture = eventDate >= now;
                
                return isFuture && isEvent && isNotHoliday && isNotClosed && isNotAppointment;
            }).sort((a, b) => {
                const dateA = a.dtstart instanceof Date ? a.dtstart : new Date(a.dtstart);
                const dateB = b.dtstart instanceof Date ? b.dtstart : new Date(b.dtstart);
                return dateA - dateB;
            }).slice(0, 4); // Only next 4 events
            
            console.log('Filtered to ' + futureEvents.length + ' future events for dropdown');
            
            if (futureEvents.length === 0) { 
                select.innerHTML += '<option disabled>Keine kommenden Events</option>'; 
                return; 
            }
            
            futureEvents.forEach((e, i) => {
                const d = e.dtstart instanceof Date ? e.dtstart : new Date(e.dtstart);
                const days = ['So', 'Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa'];
                const eventKey = d.toISOString().slice(0, 10).replace(/-/g, '');
                const id = 'bmt_' + i + '_' + eventKey;
                const name = e.summary || e.name || 'Event';
                const cat = e.category || 'fremd';
                
                const opt = document.createElement('option');
                opt.value = id;
                opt.textContent = name + ' - ' + days[d.getDay()] + ' ' + d.toLocaleDateString('de-DE');
                select.appendChild(opt);
                
                // Determine event type for factsheet template
                const isKonzert = cat === 'konzert' || name.toLowerCase().includes('concert');
                
                // Store event data for factsheet autofill - with Shiftplan lookup!
                const dateKey = d.toLocaleDateString('de-DE', {day: '2-digit', month: '2-digit', year: 'numeric'});
                const shiftData = getShiftplanByDate(dateKey);
                
                EVENT_STAFF_DATA[id] = {
                    name: name, 
                    datum: d.toLocaleDateString('de-DE', {weekday: 'long', day: '2-digit', month: '2-digit', year: 'numeric'}),
                    technik: shiftData?.technik || '', 
                    cvd: shiftData?.cvd || '', 
                    eventType: isKonzert ? 'CONCERT' : 'CLUB', 
                    mainFloorTime: '00:00', 
                    terrasse: shiftData?.terrasse || '', 
                    kitchen: shiftData?.kitchen || '',
                    main1: shiftData?.main1 || '', 
                    main2: shiftData?.main2 || '', 
                    main3: shiftData?.main3 || '', 
                    main4: shiftData?.main4 || '', 
                    runner1: shiftData?.runner1 || '', 
                    runner2: shiftData?.runner2 || '', 
                    runner3: shiftData?.runner3 || '', 
                    runner4: shiftData?.runner4 || '', 
                    runner5: shiftData?.runner5 || '', 
                    runner6: shiftData?.runner6 || '',
                    gard1: shiftData?.gard1 || '', 
                    gard2: shiftData?.gard2 || '', 
                    gard3: shiftData?.gard3 || ''
                };
                
                if (shiftData) {
                    console.log('Shiftplan data found for ' + dateKey + ': CVD=' + shiftData.cvd);
                }
            });
            
            console.log('Factsheet dropdown populated with ' + futureEvents.length + ' events');
        }
        
        function isEigenveranstaltung(name) { return EIGENVERANSTALTUNGEN.some(e => name.toLowerCase().includes(e)); }
        function getKassa(name) { 
            if (!isEigenveranstaltung(name)) return "FREMD";
            
            const selected = [];
            if (document.getElementById('kassa-matthaeus')?.checked) selected.push('Matthus');
            if (document.getElementById('kassa-schadi')?.checked) selected.push('Schadi');
            if (document.getElementById('kassa-isa')?.checked) selected.push('Isa');
            
            return selected.length > 0 ? selected.join(' / ') : "";
        }
        
        function updateFactsheetPreview() {
            const eventName = document.getElementById('fs-event-name').value || 'EVENT';
            const datum = document.getElementById('fs-datum').value || 'Datum';
            const eventType = document.getElementById('fs-template').value;
            
            // Determine template based on event type and main floor time
            let template;
            if (eventType === 'CONCERT') {
                template = 'CONCERT';
                document.getElementById('main-floor-row').style.display = 'none';
            } else {
                document.getElementById('main-floor-row').style.display = 'block';
                const mainFloorTime = document.querySelector('input[name="main-floor-time"]:checked')?.value || '00:00';
                template = mainFloorTime === '00:30' ? 'MAIN_30' : 'MAIN_00';
            }
            
            const t = TEMPLATES[template];
            
            // Auto-update bar times based on template when switching
            const main1Input = document.getElementById('fs-main1-time');
            const main2Input = document.getElementById('fs-main2-time');
            const main3Input = document.getElementById('fs-main3-time');
            const main4Input = document.getElementById('fs-main4-time');
            
            // Only auto-update if current value matches a template default
            const templateMain1Values = ['22:30', '23:00', '19:00'];
            const templateMain2Values = ['22:30', '23:00', '19:00'];
            const templateMain3Values = ['23:00', '23:30', '19:00'];
            const templateMain4Values = ['23:45', '00:15', '19:00'];
            
            if (main1Input && templateMain1Values.includes(main1Input.value)) {
                main1Input.value = t.main1;
            }
            if (main2Input && templateMain2Values.includes(main2Input.value)) {
                main2Input.value = t.main2;
            }
            if (main3Input && templateMain3Values.includes(main3Input.value)) {
                main3Input.value = t.main3;
            }
            if (main4Input && templateMain4Values.includes(main4Input.value)) {
                main4Input.value = t.main4;
            }
            
            // Show/hide KASSA checkboxes based on event type
            const kassaRow = document.getElementById('kassa-row');
            if (kassaRow) {
                kassaRow.style.display = isEigenveranstaltung(eventName) ? 'block' : 'none';
            }
            
            const kassa = getKassa(eventName);
            
            // Staff names
            const cvd = document.getElementById('fs-cvd').value || '';
            const technik = document.getElementById('fs-technik').value || '';
            const terrasse = document.getElementById('fs-terrasse').value || '';
            const kitchen = document.getElementById('fs-kitchen').value || '';
            const main1 = document.getElementById('fs-main1').value || '';
            const main2 = document.getElementById('fs-main2').value || '';
            const main3 = document.getElementById('fs-main3').value || '';
            const main4 = document.getElementById('fs-main4').value || '';
            const runner1 = document.getElementById('fs-runner1').value || '';
            const runner2 = document.getElementById('fs-runner2').value || '';
            const runner3 = document.getElementById('fs-runner3').value || '';
            const runner4 = document.getElementById('fs-runner4').value || '';
            const runner5 = document.getElementById('fs-runner5').value || '';
            const runner6 = document.getElementById('fs-runner6').value || '';
            const gard1 = document.getElementById('fs-gard1').value || '';
            const gard2 = document.getElementById('fs-gard2').value || '';
            const gard3 = document.getElementById('fs-gard3').value || '';
            
            // Individual times (read from inputs, fallback to template)
            const cvdTime = document.getElementById('fs-cvd-time')?.value || '20:30';
            const technikTime = document.getElementById('fs-technik-time')?.value || t.technik;
            const terrasseTime = document.getElementById('fs-terrasse-time')?.value || t.terrasse;
            const kitchenTime = document.getElementById('fs-kitchen-time')?.value || t.kitchen;
            const main1Time = document.getElementById('fs-main1-time')?.value || t.main1;
            const main2Time = document.getElementById('fs-main2-time')?.value || t.main2;
            const main3Time = document.getElementById('fs-main3-time')?.value || t.main3;
            const main4Time = document.getElementById('fs-main4-time')?.value || t.main4;
            const runner1Time = document.getElementById('fs-runner1-time')?.value || t.runner1;
            const runner2Time = document.getElementById('fs-runner2-time')?.value || t.runner2;
            const runner3Time = document.getElementById('fs-runner3-time')?.value || t.runner3;
            const runner4Time = document.getElementById('fs-runner4-time')?.value || t.runner4;
            const runner5Time = document.getElementById('fs-runner5-time')?.value || t.runner5;
            const runner6Time = document.getElementById('fs-runner6-time')?.value || t.runner5;
            const gard1Time = document.getElementById('fs-gard1-time')?.value || t.gard1;
            const gard2Time = document.getElementById('fs-gard2-time')?.value || t.gard2;
            const gard3Time = document.getElementById('fs-gard3-time')?.value || t.gard3;
            
            const secRows = t.security.map((s, i) => `<tr><td>${i === 0 ? 'SECURITY:' : ''}</td><td>${s.time}</td><td>${s.pax}</td></tr>`).join('');
            
            document.getElementById('fs-preview').innerHTML = `
                <h2>EVENT: <span class="event-name">${eventName.toUpperCase()}</span></h2>
                <p>Datum: ${datum}</p>
                <p><strong>AUFSTELLUNG:</strong></p>
                <table>
                    <tr><td><strong>PAX:</strong></td><td></td><td></td></tr>
                    <tr><td><strong>CVD:</strong></td><td>${cvdTime}</td><td>${cvd}</td></tr>
                    <tr><td><strong>KASSA:</strong></td><td>22:30</td><td>${kassa}</td></tr>
                    <tr><td colspan="3"></td></tr>
                    <tr><td><strong>DOORS 1:</strong></td><td>${t.doors1}</td><td></td></tr>
                    <tr><td>TERRASSE 1</td><td>${terrasseTime}</td><td>${terrasse}</td></tr>
                    <tr><td><strong>DOORS 2:</strong></td><td>${t.doors2_early}</td><td></td></tr>
                    <tr><td>KITCHEN:</td><td>${kitchenTime}</td><td>${kitchen}</td></tr>
                    <tr><td colspan="3"></td></tr>
                    <tr><td><strong>DOORS 2:</strong></td><td>${t.doors2_late}</td><td></td></tr>
                    <tr><td>MAIN 1:</td><td>${main1Time}</td><td>${main1}</td></tr>
                    <tr><td>MAIN 2:</td><td>${main2Time}</td><td>${main2}</td></tr>
                    <tr><td>MAIN 3:</td><td>${main3Time}</td><td>${main3}</td></tr>
                    <tr><td>MAIN 4:</td><td>${main4Time}</td><td>${main4}</td></tr>
                    <tr><td colspan="3"></td></tr>
                    <tr><td>RUNNER 1:</td><td>${runner1Time}</td><td>${runner1}</td></tr>
                    <tr><td>RUNNER 2:</td><td>${runner2Time}</td><td>${runner2}</td></tr>
                    <tr><td>RUNNER 3:</td><td>${runner3Time}</td><td>${runner3}</td></tr>
                    <tr><td>RUNNER 4:</td><td>${runner4Time}</td><td>${runner4}</td></tr>
                    <tr><td>RUNNER 5:</td><td>${runner5Time}</td><td>${runner5}</td></tr>
                    ${runner6 ? `<tr><td>RUNNER 6:</td><td>${runner6Time}</td><td>${runner6}</td></tr>` : ''}
                    <tr><td colspan="3"></td></tr>
                    <tr><td>GARDEROBE 1</td><td>${gard1Time}</td><td>${gard1}</td></tr>
                    <tr><td>GARDEROBE 2</td><td>${gard2Time}</td><td>${gard2}</td></tr>
                    <tr><td>GARDEROBE 3</td><td>${gard3Time}</td><td>${gard3}</td></tr>
                    <tr><td colspan="3"></td></tr>
                    <tr><td><strong>TECHNIK:</strong></td><td>${technikTime}</td><td>${technik}</td></tr>
                    <tr><td colspan="3"></td></tr>
                    ${secRows}
                </table>
            `;
        }
        
        // 
        // SHIFTPLAN DATABASE - From Master Shiftplans (Google Docs) + Technikerkalender
        // Key: DD.MM.YYYY format for date matching
        // 
        const SHIFTPLAN_DATABASE = {
            // DECEMBER 2025
            '27.12.2025': {
                technik: 'Simon',
                terrasse: '-', kitchen: 'Dhanna', main1: 'Ada', main2: 'Lino', main3: 'Milos', main4: 'Dora',
                cvd: 'Alain', runner1: 'Jakob', runner2: 'Kaan', runner3: '', runner4: 'Peter', runner5: 'Aziz', runner6: '',
                gard1: 'Sofia', gard2: 'Fayez', gard3: 'Nico'
            },
            '31.12.2025': {
                technik: 'Jan',
                terrasse: 'Milos', kitchen: 'Kamil', main1: 'Dora', main2: 'Lino', main3: 'Ada', main4: 'Camillo',
                cvd: 'Alain / Niat', runner1: 'Patrick', runner2: 'Gordan', runner3: 'Peter', runner4: 'Zuzu', runner5: 'Kaan', runner6: 'Aziz',
                gard1: 'Sofia', gard2: 'Fayez', gard3: 'Nico'
            },
            // JANUARY 2026
            '05.01.2026': {
                technik: 'Elias',
                terrasse: 'Kamil', kitchen: 'Martina', main1: 'Ada', main2: 'Yohanna', main3: 'Lino', main4: 'Milos',
                cvd: 'Niat', runner1: 'Jakob', runner2: 'Patrick', runner3: 'Gordan', runner4: 'Peter', runner5: 'Zuzu', runner6: '',
                gard1: 'Sofia', gard2: 'Fayez', gard3: 'Nico'
            },
            '09.01.2026': {
                technik: 'Simon',
                terrasse: 'Milos', kitchen: 'Dora', main1: 'Lino', main2: 'Martina', main3: 'Yohanna', main4: 'Kamil',
                cvd: 'Alain', runner1: 'Jakob', runner2: 'Gordan', runner3: 'Peter', runner4: 'Kaan', runner5: 'Aziz', runner6: '',
                gard1: 'Sofia', gard2: 'Fayez', gard3: 'Nico'
            },
            '10.01.2026': {
                technik: 'Elias',
                terrasse: 'Camillo', kitchen: 'Milos', main1: 'Kamil', main2: 'Lino', main3: 'Martina', main4: 'TBA',
                cvd: 'Niat', runner1: 'Jakob', runner2: 'Patrick', runner3: 'Gordan', runner4: 'Patrick', runner5: 'Zuzu', runner6: '',
                gard1: 'Sofia', gard2: 'Fayez', gard3: 'Nico'
            },
            '16.01.2026': {
                technik: 'Elias',
                terrasse: 'Lino', kitchen: 'Milos', main1: 'Kamil', main2: 'Dora', main3: 'Camillo', main4: 'Martina',
                cvd: 'Niat', runner1: 'Jakob', runner2: 'Zuzu', runner3: 'Gordan', runner4: '', runner5: '', runner6: '',
                gard1: 'Sofia', gard2: 'Fayez', gard3: 'Nico'
            },
            '17.01.2026': {
                technik: 'Jan',
                terrasse: 'TBA', kitchen: 'Kamil', main1: 'Milos', main2: 'Lino', main3: 'Yohanna', main4: 'Dora',
                cvd: 'Alain', runner1: 'Jakob', runner2: 'Patrick', runner3: 'Peter', runner4: 'Hasib', runner5: 'Aziz', runner6: '',
                gard1: 'Sofia', gard2: 'Fayez', gard3: 'Nico'
            },
            '23.01.2026': {
                technik: 'Jan',
                terrasse: 'Dora', kitchen: 'Yohanna', main1: 'Camillo', main2: 'Dora', main3: 'Kamil', main4: 'Milos',
                cvd: 'Niat', runner1: 'Zuzu', runner2: 'Gordan', runner3: 'Peter', runner4: 'Hasib', runner5: 'Aziz', runner6: '',
                gard1: 'Sofia', gard2: 'Fayez', gard3: 'Nico'
            },
            '24.01.2026': {
                technik: 'Simon',
                terrasse: 'TBA', kitchen: 'Dora', main1: 'Kamil', main2: 'Milos', main3: 'Camillo', main4: 'Martina',
                cvd: 'Niat', runner1: 'Kaan', runner2: 'Patrick', runner3: 'Zuzu', runner4: 'Hasib', runner5: '', runner6: '',
                gard1: 'Sofia', gard2: 'Fayez', gard3: 'Nico'
            },
            '30.01.2026': {
                technik: 'Elias',
                terrasse: 'Martina', kitchen: 'Lino', main1: 'Ada', main2: 'Yohanna', main3: 'Milos', main4: 'Kamil',
                cvd: 'Alain', runner1: 'Jakob', runner2: 'Zuzu', runner3: 'Gordan', runner4: 'Kaan', runner5: '', runner6: '',
                gard1: 'Sofia', gard2: 'Fayez', gard3: 'Nico'
            },
            '31.01.2026': {
                technik: 'Simon',
                terrasse: 'Kamil', kitchen: 'Dora', main1: 'Milos', main2: 'Martina', main3: 'Camillo', main4: 'Ada',
                cvd: 'Niat', runner1: 'Jakob', runner2: 'Patrick', runner3: 'Peter', runner4: 'Gordan', runner5: 'Aziz', runner6: '',
                gard1: 'Sofia', gard2: 'Fayez', gard3: 'Nico'
            }
        };
        
        // Render Runner Shiftplan as native HTML table
        function renderRunnerShiftplan() {
            const container = document.getElementById('runner-shiftplan-table');
            if (!container) return;
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const dayNames = ['So', 'Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa'];
            
            // Get future events sorted by date
            const futureEvents = [];
            for (const dateStr in SHIFTPLAN_DATABASE) {
                const parts = dateStr.split('.');
                const eventDate = new Date(parts[2], parts[1] - 1, parts[0]);
                
                if (eventDate >= today) {
                    const data = SHIFTPLAN_DATABASE[dateStr];
                    
                    // Try to find event name from BMT
                    let eventName = '-';
                    if (typeof bmtEvents !== 'undefined' && bmtEvents.length > 0) {
                        const match = bmtEvents.find(e => {
                            const eDate = e.dtstart instanceof Date ? e.dtstart : new Date(e.dtstart);
                            return eDate.toDateString() === eventDate.toDateString();
                        });
                        if (match) eventName = match.summary || '-';
                    }
                    
                    futureEvents.push({
                        date: eventDate,
                        dateStr: dateStr,
                        day: dayNames[eventDate.getDay()],
                        eventName: eventName,
                        cvd: data.cvd || '-',
                        runner1: data.runner1 || '-',
                        runner2: data.runner2 || '-',
                        runner3: data.runner3 || '-',
                        runner4: data.runner4 || '-',
                        runner5: data.runner5 || '-',
                        runner6: data.runner6 || '-'
                    });
                }
            }
            
            futureEvents.sort((a, b) => a.date - b.date);
            
            if (futureEvents.length === 0) {
                container.innerHTML = '<p style="color: #888; padding: 15px;">Keine Shiftplan-Daten</p>';
                return;
            }
            
            let html = `<table class="shiftplan-table">
                <thead>
                    <tr>
                        <th>Tag</th>
                        <th>Event</th>
                        <th>CVD</th>
                        <th>R1</th>
                        <th>R2</th>
                        <th>R3</th>
                        <th>R4</th>
                        <th>R5</th>
                        <th>R6</th>
                    </tr>
                </thead>
                <tbody>`;
            
            futureEvents.forEach(e => {
                const shortDate = e.dateStr.substring(0, 5); // DD.MM
                html += `<tr>
                    <td class="date-col">${e.day} ${shortDate}</td>
                    <td class="event-col" title="${e.eventName}">${e.eventName.substring(0, 15)}${e.eventName.length > 15 ? '...' : ''}</td>
                    <td class="cvd-col">${e.cvd}</td>
                    <td class="runner-col">${e.runner1}</td>
                    <td class="runner-col">${e.runner2}</td>
                    <td class="runner-col">${e.runner3}</td>
                    <td class="runner-col">${e.runner4}</td>
                    <td class="runner-col">${e.runner5}</td>
                    <td class="runner-col">${e.runner6}</td>
                </tr>`;
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }
        
        // Get shiftplan data by date (DD.MM.YYYY format)
        function getShiftplanByDate(dateStr) {
            return SHIFTPLAN_DATABASE[dateStr] || null;
        }
        
        // Render Technikerkalender - compact table format (like Runner)
        function renderTechnikCalendar() {
            const container = document.getElementById('technik-calendar-list');
            if (!container) return;
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const dayNames = ['So', 'Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa'];
            
            // Get all future events from SHIFTPLAN_DATABASE
            const futureEvents = [];
            
            for (const dateStr in SHIFTPLAN_DATABASE) {
                const parts = dateStr.split('.');
                const eventDate = new Date(parts[2], parts[1] - 1, parts[0]);
                
                if (eventDate >= today) {
                    const data = SHIFTPLAN_DATABASE[dateStr];
                    
                    // Try to find event name from BMT events
                    let eventName = '-';
                    if (typeof bmtEvents !== 'undefined' && bmtEvents.length > 0) {
                        const matchingEvent = bmtEvents.find(e => {
                            const eDate = e.dtstart instanceof Date ? e.dtstart : new Date(e.dtstart);
                            return eDate.toDateString() === eventDate.toDateString();
                        });
                        if (matchingEvent) {
                            eventName = matchingEvent.summary || '-';
                        }
                    }
                    
                    futureEvents.push({
                        date: eventDate,
                        dateStr: dateStr,
                        day: dayNames[eventDate.getDay()],
                        eventName: eventName,
                        technik: data.technik || '-'
                    });
                }
            }
            
            // Sort by date
            futureEvents.sort((a, b) => a.date - b.date);
            
            if (futureEvents.length === 0) {
                container.innerHTML = '<p style="color: #888; padding: 15px;">Keine Shiftplan-Daten</p>';
                return;
            }
            
            let html = `<table class="shiftplan-table">
                <thead>
                    <tr>
                        <th>Tag</th>
                        <th>Event</th>
                        <th>Techniker</th>
                    </tr>
                </thead>
                <tbody>`;
            
            futureEvents.forEach(e => {
                const shortDate = e.dateStr.substring(0, 5); // DD.MM
                html += `<tr>
                    <td class="date-col">${e.day} ${shortDate}</td>
                    <td class="event-col" title="${e.eventName}">${e.eventName.substring(0, 15)}${e.eventName.length > 15 ? '...' : ''}</td>
                    <td class="technik-col">${e.technik}</td>
                </tr>`;
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }
        
        // Event data storage (legacy + dynamic from BMT)
        const EVENT_STAFF_DATA = {
            'turbo': { 
                name: 'TURBO', 
                datum: 'Samstag, 27.12.2025', 
                technik: 'Simon', 
                cvd: 'Alain',
                eventType: 'CLUB',
                mainFloorTime: '00:30',
                terrasse: '-',
                kitchen: 'Dhanna',
                main1: 'Ada',
                main2: 'Lino',
                main3: 'Milos',
                main4: 'Dora',
                runner1: 'Jakob',
                runner2: 'Kaan',
                runner3: '',
                runner4: 'Peter',
                runner5: 'Aziz',
                runner6: '',
                gard1: 'Sofia',
                gard2: 'Fayez',
                gard3: 'Nico'
            },
            'nye': { 
                name: 'NYE SILVESTER', 
                datum: 'Dienstag, 31.12.2025', 
                technik: 'Jan', 
                cvd: 'Alain / Niat',
                eventType: 'CLUB',
                mainFloorTime: '00:00',
                terrasse: 'Milos',
                kitchen: 'Kamil',
                main1: 'Dora',
                main2: 'Lino',
                main3: 'Ada',
                main4: 'Camillo',
                runner1: 'Patrick',
                runner2: 'Gordan',
                runner3: 'Peter',
                runner4: 'Zuzu',
                runner5: 'Kaan',
                runner6: 'Aziz',
                gard1: 'Sofia',
                gard2: 'Fayez',
                gard3: 'Nico'
            }
        };
        
        // Load event data when dropdown changes
        function loadEventData() {
            const eventId = document.getElementById('fs-event-select').value;
            if (!eventId) return;
            
            const e = EVENT_STAFF_DATA[eventId];
            if (e) {
                fillFactsheetForm(e);
            }
        }
        
        // Fill all factsheet form fields
        function fillFactsheetForm(e) {
            document.getElementById('fs-event-name').value = e.name || '';
            document.getElementById('fs-datum').value = e.datum || '';
            document.getElementById('fs-template').value = e.eventType || 'CLUB';
            
            // Show/hide main floor row based on template
            const template = e.eventType || 'CLUB';
            const mainFloorRow = document.getElementById('main-floor-row');
            if (mainFloorRow) {
                mainFloorRow.style.display = template === 'CLUB' ? 'flex' : 'none';
            }
            
            // Set main floor time radio
            const mainFloorRadio = document.querySelector(`input[name="main-floor-time"][value="${e.mainFloorTime || '00:00'}"]`);
            if (mainFloorRadio) mainFloorRadio.checked = true;
            
            document.getElementById('fs-technik').value = e.technik || '';
            document.getElementById('fs-cvd').value = e.cvd || '';
            
            const terrasseEl = document.getElementById('fs-terrasse');
            if (terrasseEl) terrasseEl.value = e.terrasse || '';
            
            const kitchenEl = document.getElementById('fs-kitchen');
            if (kitchenEl) kitchenEl.value = e.kitchen || '';
            
            document.getElementById('fs-main1').value = e.main1 || '';
            document.getElementById('fs-main2').value = e.main2 || '';
            document.getElementById('fs-main3').value = e.main3 || '';
            document.getElementById('fs-main4').value = e.main4 || '';
            document.getElementById('fs-runner1').value = e.runner1 || '';
            document.getElementById('fs-runner2').value = e.runner2 || '';
            document.getElementById('fs-runner3').value = e.runner3 || '';
            document.getElementById('fs-runner4').value = e.runner4 || '';
            document.getElementById('fs-runner5').value = e.runner5 || '';
            document.getElementById('fs-runner6').value = e.runner6 || '';
            document.getElementById('fs-gard1').value = e.gard1 || '';
            document.getElementById('fs-gard2').value = e.gard2 || '';
            document.getElementById('fs-gard3').value = e.gard3 || '';
            
            updateFactsheetPreview();
        }
        
        // Quick factsheet for specific event from dashboard
        function autoFactsheetForEvent(eventId) {
            const e = EVENT_STAFF_DATA[eventId];
            if (e) {
                // Set dropdown
                document.getElementById('fs-event-select').value = eventId;
                fillFactsheetForm(e);
                openModal('factsheet-modal');
                showToast(` ${e.name} Factsheet geladen!`);
            }
        }
        
        function copyFactsheet() {
            const preview = document.getElementById('fs-preview');
            const range = document.createRange();
            range.selectNode(preview);
            window.getSelection().removeAllRanges();
            window.getSelection().addRange(range);
            document.execCommand('copy');
            window.getSelection().removeAllRanges();
            showToast(" Factsheet kopiert!");
        }
        
        function printFactsheet() {
            const preview = document.getElementById('fs-preview').innerHTML;
            const w = window.open('', '_blank');
            w.document.write(`<html><head><title>Factsheet</title><style>body{font-family:Arial;padding:20px;}table{width:100%;border-collapse:collapse;}th,td{border:1px solid #333;padding:8px;text-align:left;}.event-name{color:red;}</style></head><body>${preview}</body></html>`);
            w.document.close();
            w.print();
        }
        
        // 
        // VVK TRACKER (Events Dashboard)
        // 
        
        function getDaysUntil(id) {
            const d = EVENT_CONFIG[id].date;
            const today = new Date(); today.setHours(0,0,0,0);
            return Math.max(0, Math.ceil((d - today) / 86400000));
        }
        
        function updateProjection(id) {
            const cfg = EVENT_CONFIG[id];
            const s = SERIE_STATS[cfg.serie];
            const k = KW_STATS[cfg.kw] || { barPP: 16.5 };
            const days = getDaysUntil(id);
            
            const currentVVK = parseInt(document.getElementById(`${id}-vvk-input`).value) || 0;
            const vvkZiel = parseInt(document.getElementById(`${id}-ziel-input`).value) || 450;
            const maxVVKInput = parseInt(document.getElementById(`${id}-max-input`).value) || 600;
            const vvkPrice = parseFloat(document.getElementById(`${id}-vvk-price`).value) || 18;
            const fohPrice = parseFloat(document.getElementById(`${id}-foh-price`).value) || 22;
            
            // Apply historical capacity caps
            const maxVVK = Math.min(maxVVKInput, CAPACITY_CAPS.MAX_VVK);
            
            let pct = 0.5;
            for (const d of [14,10,7,5,3,2,1,0]) { if (days >= d) { pct = VVK_BENCHMARKS[d]; break; } }
            
            const fohRatio = s.avgFOH / s.avgVVK;
            let projVVK = currentVVK > 0 ? Math.min(Math.round(currentVVK / pct), maxVVK) : Math.min(vvkZiel, maxVVK);
            let projFOH = Math.round(projVVK * fohRatio);
            
            // Apply FOH and Total caps
            projFOH = Math.min(projFOH, CAPACITY_CAPS.MAX_FOH);
            const projTotalGuests = projVVK + projFOH;
            if (projTotalGuests > CAPACITY_CAPS.MAX_TOTAL) {
                const scale = CAPACITY_CAPS.MAX_TOTAL / projTotalGuests;
                projVVK = Math.round(projVVK * scale);
                projFOH = Math.round(projFOH * scale);
            }
            
            const projBar = (projVVK + projFOH) * k.barPP;
            const projTotal = projBar + (projVVK * vvkPrice) + (projFOH * fohPrice);
            
            document.getElementById(`${id}-days`).textContent = `${days} Tage`;
            document.getElementById(`${id}-vvk-proj`).textContent = `~${projVVK}`;
            document.getElementById(`${id}-foh-proj`).textContent = `~${projFOH}`;
            document.getElementById(`${id}-bar-proj`).textContent = `~${(projBar/1000).toFixed(1)}k`;
            document.getElementById(`${id}-total-proj`).textContent = `~${(projTotal/1000).toFixed(1)}k`;
            document.getElementById(`${id}-tickets-quick`).textContent = ` ~${projVVK + projFOH}`;
            document.getElementById(`${id}-bar-quick`).textContent = ` ~${(projBar/1000).toFixed(1)}k`;
            
            const progress = Math.min(100, (currentVVK / vvkZiel) * 100);
            document.getElementById(`${id}-progress`).style.width = `${progress}%`;
            
            const expected = Math.round(vvkZiel * pct);
            document.getElementById(`${id}-benchmark`).textContent = `Ziel: ${vvkZiel} | ${Math.round(pct*100)}% bei ${days}d  Soll ~${expected}`;
        }
        
        // 
        // UI HELPERS
        // 
        
        function openModal(id) { document.getElementById(id).classList.add('show'); }
        function closeModal(id) { document.getElementById(id).classList.remove('show'); }
        
        function toggleSection(label) { label.classList.toggle('open'); label.nextElementSibling.classList.toggle('open'); }
        
        function toggleTasksSection(dept) {
            const header = document.querySelector(`#${dept}-tasks .tasks-header`);
            const list = document.getElementById(`${dept}-tasks-list`);
            header.classList.toggle('open');
            list.classList.toggle('open');
        }
        
        function toggleDropdown(id) {
            document.querySelectorAll('.dropdown-content').forEach(d => { if (d.id !== id) d.classList.remove('show'); });
            document.getElementById(id).classList.toggle('show');
        }
        document.addEventListener('click', e => { if (!e.target.closest('.dropdown-container')) document.querySelectorAll('.dropdown-content').forEach(d => d.classList.remove('show')); });
        function toggleEventCard(id) { document.getElementById(id).classList.toggle('open'); }
        
        function toggleApps() {
            const toggle = document.getElementById('apps-toggle');
            const content = document.getElementById('apps-content');
            toggle.classList.toggle('open');
            content.classList.toggle('show');
        }
        
        function toggleTools() {
            const toggle = document.getElementById('tools-toggle');
            const content = document.getElementById('tools-content');
            toggle.classList.toggle('open');
            content.classList.toggle('show');
        }
        
        function toggleFinanceTools() {
            const toggle = document.getElementById('finance-toggle');
            const content = document.getElementById('finance-content');
            toggle.classList.toggle('open');
            content.classList.toggle('show');
        }
        
        function showToast(msg, isError) {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.className = 'toast show' + (isError ? ' error' : '');
            setTimeout(() => t.classList.remove('show'), 3000);
        }
        
        // Speech-to-Text for Quick Notes
        let speechRecognition = null;
        let isListening = false;
        
        function toggleSpeechToText() {
            const btn = document.getElementById('speech-btn');
            const textarea = document.getElementById('quick-notes-text');
            
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                showToast(' Speech-to-Text nicht untersttzt in diesem Browser', true);
                return;
            }
            
            if (isListening) {
                // Stop listening
                if (speechRecognition) {
                    speechRecognition.stop();
                }
                isListening = false;
                btn.style.background = '';
                btn.textContent = '';
                showToast(' Spracheingabe beendet');
                return;
            }
            
            // Start listening
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            speechRecognition = new SpeechRecognition();
            speechRecognition.continuous = true;
            speechRecognition.interimResults = true;
            speechRecognition.lang = 'de-DE';
            
            speechRecognition.onstart = function() {
                isListening = true;
                btn.style.background = '#ef4444';
                btn.textContent = '';
                showToast(' Spracheingabe aktiv...');
            };
            
            speechRecognition.onresult = function(event) {
                let finalTranscript = '';
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    if (event.results[i].isFinal) {
                        finalTranscript += event.results[i][0].transcript;
                    }
                }
                if (finalTranscript) {
                    textarea.value += (textarea.value ? ' ' : '') + finalTranscript;
                    saveQuickNotes();
                }
            };
            
            speechRecognition.onerror = function(event) {
                console.error('Speech error:', event.error);
                isListening = false;
                btn.style.background = '';
                btn.textContent = '';
                showToast(' Spracheingabe Fehler: ' + event.error, true);
            };
            
            speechRecognition.onend = function() {
                isListening = false;
                btn.style.background = '';
                btn.textContent = '';
            };
            
            speechRecognition.start();
        }
        
        // Quick Notes Functions
        let notesTimeout = null;
        let notesListId = null; // Will store the "Notes" list ID
        
        function saveQuickNotes() {
            clearTimeout(notesTimeout);
            notesTimeout = setTimeout(() => {
                const text = document.getElementById('quick-notes-text').value;
                localStorage.setItem('workhub-quick-notes', text);
                const indicator = document.getElementById('notes-saved');
                indicator.classList.add('show');
                setTimeout(() => indicator.classList.remove('show'), 2000);
                
                // Sync to MS To Do if logged in
                if (accessToken && text.trim()) {
                    syncNotesToToDo(text);
                }
            }, 1000);
        }
        
        async function getOrCreateNotesList() {
            if (notesListId) return notesListId;
            
            try {
                // Search for existing "Notes" list
                const response = await fetch('https://graph.microsoft.com/v1.0/me/todo/lists', {
                    headers: { 'Authorization': 'Bearer ' + accessToken }
                });
                const data = await response.json();
                
                const notesList = data.value?.find(list => list.displayName === 'Notes');
                if (notesList) {
                    notesListId = notesList.id;
                    return notesListId;
                }
                
                // Create "Notes" list if not exists
                const createResponse = await fetch('https://graph.microsoft.com/v1.0/me/todo/lists', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + accessToken,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ displayName: 'Notes' })
                });
                const newList = await createResponse.json();
                notesListId = newList.id;
                return notesListId;
            } catch (err) {
                console.error('Failed to get/create Notes list:', err);
                return null;
            }
        }
        
        async function syncNotesToToDo(text) {
            if (!accessToken) return;
            
            try {
                const listId = await getOrCreateNotesList();
                if (!listId) return;
                
                // Search for existing "Work Hub Quick Notes" task
                const searchResponse = await fetch(
                    `https://graph.microsoft.com/v1.0/me/todo/lists/${listId}/tasks?$filter=title eq 'Work Hub Quick Notes'`,
                    { headers: { 'Authorization': 'Bearer ' + accessToken } }
                );
                const searchData = await searchResponse.json();
                
                const noteBody = {
                    title: 'Work Hub Quick Notes',
                    body: {
                        content: text,
                        contentType: 'text'
                    }
                };
                
                if (searchData.value && searchData.value.length > 0) {
                    // Update existing task
                    const taskId = searchData.value[0].id;
                    await fetch(`https://graph.microsoft.com/v1.0/me/todo/lists/${listId}/tasks/${taskId}`, {
                        method: 'PATCH',
                        headers: {
                            'Authorization': 'Bearer ' + accessToken,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(noteBody)
                    });
                } else {
                    // Create new task
                    await fetch(`https://graph.microsoft.com/v1.0/me/todo/lists/${listId}/tasks`, {
                        method: 'POST',
                        headers: {
                            'Authorization': 'Bearer ' + accessToken,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(noteBody)
                    });
                }
                
                const indicator = document.getElementById('notes-saved');
                indicator.textContent = ' Synced';
                indicator.classList.add('show');
                setTimeout(() => {
                    indicator.textContent = ' Gespeichert';
                    indicator.classList.remove('show');
                }, 2000);
            } catch (err) {
                console.log('Note sync to To Do failed:', err);
            }
        }
        
        async function loadQuickNotesFromToDo() {
            // Don't reload if notes were just saved as task
            if (localStorage.getItem('workhub-notes-task-created') === 'true') {
                localStorage.removeItem('workhub-notes-task-created');
                document.getElementById('quick-notes-text').value = '';
                return;
            }
            
            if (!accessToken) {
                loadQuickNotes();
                return;
            }
            
            try {
                const listId = await getOrCreateNotesList();
                if (!listId) {
                    loadQuickNotes();
                    return;
                }
                
                const response = await fetch(
                    `https://graph.microsoft.com/v1.0/me/todo/lists/${listId}/tasks?$filter=title eq 'Work Hub Quick Notes'`,
                    { headers: { 'Authorization': 'Bearer ' + accessToken } }
                );
                const data = await response.json();
                
                if (data.value && data.value.length > 0 && data.value[0].body?.content) {
                    const notes = data.value[0].body.content;
                    document.getElementById('quick-notes-text').value = notes;
                    localStorage.setItem('workhub-quick-notes', notes);
                    console.log(' Notes loaded from To Do');
                } else {
                    loadQuickNotes();
                }
            } catch (err) {
                console.log('Failed to load from To Do, using local:', err);
                loadQuickNotes();
            }
        }
        
        function loadQuickNotes() {
            // Don't reload if notes were just saved as task
            if (localStorage.getItem('workhub-notes-task-created') === 'true') {
                localStorage.removeItem('workhub-notes-task-created');
                document.getElementById('quick-notes-text').value = '';
                return;
            }
            const saved = localStorage.getItem('workhub-quick-notes');
            if (saved) {
                document.getElementById('quick-notes-text').value = saved;
            }
        }
        
        async function clearQuickNotes() {
            document.getElementById('quick-notes-text').value = '';
            localStorage.removeItem('workhub-quick-notes');
            clearTimeout(notesTimeout);
            
            // Also clear sync task in To Do if logged in
            if (accessToken) {
                try {
                    const listId = await getOrCreateNotesList();
                    if (listId) {
                        const response = await fetch(
                            `https://graph.microsoft.com/v1.0/me/todo/lists/${listId}/tasks?$filter=title eq 'Work Hub Quick Notes'`,
                            { headers: { 'Authorization': 'Bearer ' + accessToken } }
                        );
                        const data = await response.json();
                        if (data.value && data.value.length > 0) {
                            await fetch(
                                `https://graph.microsoft.com/v1.0/me/todo/lists/${listId}/tasks/${data.value[0].id}`,
                                {
                                    method: 'PATCH',
                                    headers: { 'Authorization': 'Bearer ' + accessToken, 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ body: { content: '', contentType: 'text' } })
                                }
                            );
                        }
                    }
                } catch (err) { console.log('Could not clear sync task:', err); }
            }
            showToast(' Notizen gelscht');
        }
        
        // Deep Analysis Function
        function openDeepAnalysis() {
            // Opens the Grelle Forelle Analysis Project in Claude
            window.open('https://claude.ai/project/0199e959-4ffb-70e3-8b70-5a7c8594bce7', '_blank');
        }
        
        // 
        // NYE PROJECTOR (3-Jahre Benchmark)
        // 
        
        const NYE_SCENARIOS = {
            base: {
                name: 'Base',
                presale: 480,
                foh: 480,
                fohRevenue: 12120,
                barRevenue: 23000,
                arrivals: [
                    { time: '22-23', presale: 30, foh: 30, inClub: 300 },
                    { time: '23-00', presale: 90, foh: 60, inClub: 520 },
                    { time: '00-01', presale: 55, foh: 105, inClub: 800 },
                    { time: '01-02', presale: 150, foh: 135, inClub: 1250 },
                    { time: '02-03', presale: 100, foh: 85, inClub: 1200 },
                    { time: '03-04', presale: 35, foh: 40, inClub: 1000 },
                    { time: 'After 04', presale: 20, foh: 25, inClub: 850 }
                ]
            },
            expected: {
                name: 'Expected',
                presale: 560,
                foh: 536,
                fohRevenue: 13392,
                barRevenue: 24000,
                arrivals: [
                    { time: '22-23', presale: 37, foh: 34, inClub: 350 },
                    { time: '23-00', presale: 105, foh: 68, inClub: 610 },
                    { time: '00-01', presale: 64, foh: 117, inClub: 950 },
                    { time: '01-02', presale: 174, foh: 154, inClub: 1450 },
                    { time: '02-03', presale: 121, foh: 94, inClub: 1350 },
                    { time: '03-04', presale: 40, foh: 44, inClub: 1150 },
                    { time: 'After 04', presale: 19, foh: 25, inClub: 950 }
                ]
            },
            strong: {
                name: 'Strong',
                presale: 600,
                foh: 600,
                fohRevenue: 15120,
                barRevenue: 25000,
                arrivals: [
                    { time: '22-23', presale: 45, foh: 40, inClub: 400 },
                    { time: '23-00', presale: 120, foh: 80, inClub: 700 },
                    { time: '00-01', presale: 75, foh: 130, inClub: 1100 },
                    { time: '01-02', presale: 190, foh: 170, inClub: 1550 },
                    { time: '02-03', presale: 130, foh: 105, inClub: 1450 },
                    { time: '03-04', presale: 25, foh: 50, inClub: 1200 },
                    { time: 'After 04', presale: 15, foh: 25, inClub: 1000 }
                ]
            }
        };
        
        const NYE_BAR_REVENUE = [
            { time: '22-23', revenue: 700, pct: 3 },
            { time: '23-00', revenue: 1500, pct: 6 },
            { time: '00-01', revenue: 2600, pct: 11 },
            { time: '01-02', revenue: 3600, pct: 15 },
            { time: '02-03', revenue: 4000, pct: 17 },
            { time: '03-04', revenue: 3100, pct: 13 },
            { time: '04-05', revenue: 2400, pct: 10 },
            { time: '05-06', revenue: 1600, pct: 7 },
            { time: '06-07', revenue: 900, pct: 4 }
        ];
        
        function calculateNYE() {
            const scenarioKey = document.getElementById('nye-scenario').value;
            const currentVVK = parseInt(document.getElementById('nye-current-vvk').value) || 0;
            const scenario = NYE_SCENARIOS[scenarioKey];
            
            // Update main metrics
            document.getElementById('nye-presale').textContent = scenario.presale.toLocaleString('de-DE');
            document.getElementById('nye-foh').textContent = scenario.foh.toLocaleString('de-DE');
            document.getElementById('nye-total').textContent = (scenario.presale + scenario.foh).toLocaleString('de-DE');
            
            document.getElementById('nye-foh-revenue').textContent = '' + scenario.fohRevenue.toLocaleString('de-DE');
            document.getElementById('nye-bar-revenue').textContent = '' + scenario.barRevenue.toLocaleString('de-DE');
            document.getElementById('nye-total-revenue').textContent = '' + (scenario.fohRevenue + scenario.barRevenue).toLocaleString('de-DE');
            
            // Update arrival table
            const arrivalBody = document.getElementById('nye-arrival-body');
            arrivalBody.innerHTML = scenario.arrivals.map(row => {
                const total = row.presale + row.foh;
                const isPeak = row.time === '01-02';
                return `
                    <tr style="${isPeak ? 'background: rgba(239, 68, 68, 0.2);' : ''}">
                        <td style="${isPeak ? 'font-weight: 700; color: #ef4444;' : ''}">${row.time}</td>
                        <td>${row.presale}</td>
                        <td>${row.foh}</td>
                        <td style="font-weight: 600;">${total}</td>
                        <td style="${row.inClub >= 1400 ? 'color: #ef4444; font-weight: 700;' : ''}">${row.inClub >= 1000 ? '~' : ''}${row.inClub.toLocaleString('de-DE')}</td>
                    </tr>
                `;
            }).join('') + `
                <tr style="background: #252542; font-weight: 700;">
                    <td>TOTAL</td>
                    <td>${scenario.presale}</td>
                    <td>${scenario.foh}</td>
                    <td>${scenario.presale + scenario.foh}</td>
                    <td>-</td>
                </tr>
            `;
            
            // Update bar revenue table
            const barBody = document.getElementById('nye-bar-body');
            barBody.innerHTML = NYE_BAR_REVENUE.map(row => {
                const isPeak = row.time === '02-03';
                const barWidth = (row.pct / 17) * 100;
                return `
                    <tr style="${isPeak ? 'background: rgba(34, 197, 94, 0.2);' : ''}">
                        <td style="${isPeak ? 'font-weight: 700; color: #22c55e;' : ''}">${row.time}</td>
                        <td style="${isPeak ? 'font-weight: 700;' : ''}">${row.revenue.toLocaleString('de-DE')}</td>
                        <td>${row.pct}%</td>
                        <td><div style="background: ${isPeak ? '#22c55e' : '#3b82f6'}; height: 12px; width: ${barWidth}%; border-radius: 4px;"></div></td>
                    </tr>
                `;
            }).join('');
            
            // Show VVK status if entered
            if (currentVVK > 0) {
                const pctSold = Math.round((currentVVK / scenario.presale) * 100);
                // Could add a progress indicator here
            }
        }
        
        // Initialize NYE calculator when modal opens
        document.getElementById('nye-projector-modal')?.addEventListener('click', function(e) {
            if (e.target === this) calculateNYE();
        });
        
        // 
        // PEAK GRID DASHBOARD
        // 
        
        const PEAK_GRID_DATA = [
            { time: '22:00-22:30', door: 'low', coat: 'low', bar: 'low', action: 'Start. Systems check. Staff settle.' },
            { time: '22:30-23:00', door: 'low', coat: 'low', bar: 'low', action: 'Prepare wardrobe rhythm. Keep lanes clean.' },
            { time: '23:00-23:30', door: 'med', coat: 'med', bar: 'low', action: 'Early wave. Terrace helps absorb.' },
            { time: '23:30-00:00', door: 'high', coat: 'high', bar: 'med', action: ' Hanger check must be done!' },
            { time: '00:00-00:15', door: 'high', coat: 'high', bar: 'high', action: ' Midnight push. Door speed only.' },
            { time: '00:15-00:30', door: 'high', coat: 'high', bar: 'high', action: 'Queue mgmt. Keep corridor clear.' },
            { time: '00:30-00:45', door: 'max', coat: 'high', bar: 'max', action: ' BOTH LANES DO EVERYTHING!' },
            { time: '00:45-01:00', door: 'max', coat: 'high', bar: 'max', action: ' Bar speed menu. Stop slow drinks.' },
            { time: '01:00-01:15', door: 'max', coat: 'high', bar: 'max', action: 'Arrival overlap continues.' },
            { time: '01:15-01:30', door: 'max', coat: 'high', bar: 'max', action: ' MANDATORY TUB REFILL!' },
            { time: '01:30-01:45', door: 'max', coat: 'high', bar: 'max', action: 'Wardrobe overflow if needed.' },
            { time: '01:45-02:00', door: 'max', coat: 'high', bar: 'max', action: ' Security clears choke points.' },
            { time: '02:00-02:15', door: 'high', coat: 'high', bar: 'max', action: ' MAX density inside (~1,450)' },
            { time: '02:15-02:30', door: 'high', coat: 'high', bar: 'high', action: 'Keep both lanes flexible.' },
            { time: '02:30-02:45', door: 'high', coat: 'high', bar: 'high', action: 'Queues dropping? Decide lane merge.' },
            { time: '02:45-03:00', door: 'high', coat: 'med', bar: 'high', action: ' Optional final tub refill window.' },
            { time: '03:00-03:30', door: 'med', coat: 'med', bar: 'high', action: 'Pressure easing. Stop tubs after 03:30.' },
            { time: '03:30-04:00', door: 'low', coat: 'low', bar: 'med', action: 'Reset & deep restock. Stabilize.' }
        ];
        
        function getLevelBadge(level) {
            const colors = {
                'low': 'background: #3d3d54;',
                'med': 'background: #22c55e; color: white;',
                'high': 'background: #f59e0b; color: white;',
                'max': 'background: #ef4444; color: white; font-weight: 700;'
            };
            const labels = { 'low': 'LOW', 'med': 'MED', 'high': 'HIGH', 'max': 'MAX' };
            return `<span style="${colors[level]} padding: 3px 8px; border-radius: 4px; font-size: 10px;">${labels[level]}</span>`;
        }
        
        function renderPeakGrid() {
            const body = document.getElementById('peak-grid-body');
            if (!body) return;
            
            body.innerHTML = PEAK_GRID_DATA.map((row, idx) => {
                const isMax = row.door === 'max' || row.bar === 'max';
                const isCritical = row.action.includes('MANDATORY') || row.action.includes('BOTH LANES');
                return `
                    <tr style="${isMax ? 'background: rgba(239, 68, 68, 0.1);' : ''}">
                        <td style="font-weight: 600; ${isMax ? 'color: #ef4444;' : ''}">${row.time}</td>
                        <td>${getLevelBadge(row.door)}</td>
                        <td>${getLevelBadge(row.coat)}</td>
                        <td>${getLevelBadge(row.bar)}</td>
                        <td style="${isCritical ? 'color: #ef4444; font-weight: 600;' : ''}">${row.action}</td>
                        <td><input type="checkbox" style="width: 18px; height: 18px; cursor: pointer;"></td>
                    </tr>
                `;
            }).join('');
        }
        
        function printPeakGrid() {
            const content = document.getElementById('peak-grid-modal').querySelector('.modal-body').innerHTML;
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head>
                    <title>NYE Peak Grid - Grelle Forelle</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 20px; background: #1a1a2e; color: white; }
                        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                        th, td { padding: 8px; border: 1px solid #3d3d54; text-align: left; }
                        th { background: #252542; }
                        @media print { body { background: white; color: black; } }
                    </style>
                </head>
                <body>${content}</body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }
        
        // Initialize Peak Grid when modal opens
        function initPeakGridModal() {
            renderPeakGrid();
        }
        
        // 
        // GUEST LIST PARSER
        // 
        
        let parsedGuestList = [];
        
        async function handleGuestListFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const fileName = file.name.toLowerCase();
            
            if (fileName.endsWith('.zip') || file.type === 'application/zip') {
                try {
                    showToast(' ZIP wird entpackt...');
                    const zip = await JSZip.loadAsync(file);
                    
                    let txtFile = null;
                    for (const [name, zipEntry] of Object.entries(zip.files)) {
                        if (name.endsWith('.txt') && !zipEntry.dir) {
                            txtFile = zipEntry;
                            break;
                        }
                    }
                    
                    if (txtFile) {
                        const content = await txtFile.async('string');
                        document.getElementById('gl-chat-input').value = content;
                        showToast(' WhatsApp Export aus ZIP geladen!');
                    } else {
                        showToast(' Keine .txt Datei im ZIP gefunden', true);
                    }
                } catch (e) {
                    console.error('ZIP error:', e);
                    showToast(' ZIP konnte nicht gelesen werden', true);
                }
            } else {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('gl-chat-input').value = e.target.result;
                    showToast(' WhatsApp Export geladen!');
                };
                reader.readAsText(file);
            }
        }
        
        function clearGuestListInput() {
            document.getElementById('gl-chat-input').value = '';
            document.getElementById('gl-results').style.display = 'none';
            parsedGuestList = [];
        }
        
        function parseGuestList() {
            const dateInput = document.getElementById('gl-date').value.trim();
            const eventName = document.getElementById('gl-event-name').value.trim() || 'EVENT';
            const chatText = document.getElementById('gl-chat-input').value;
            
            if (!dateInput) {
                showToast(' Bitte Datum eingeben (z.B. 27.12.25)', true);
                return;
            }
            
            if (!chatText) {
                showToast(' Bitte WhatsApp Chat einfgen', true);
                return;
            }
            
            const dateVariants = generateDateVariants(dateInput);
            const lines = chatText.split('\n');
            const guests = [];
            let currentSender = '';
            let currentTimestamp = '';
            let collectingNames = false;
            let currentMessage = '';
            
            const headerPatterns = [
                /^(\d{1,2}\/\d{1,2}\/\d{2,4}),?\s*(\d{1,2}:\d{2}(?::\d{2})?)\s*[-]\s*([^:]+):\s*(.*)$/,
                /^\[?(\d{1,2}[\./]\d{1,2}[\./]\d{2,4}),?\s*(\d{1,2}:\d{2}(?::\d{2})?)\]?\s*[-]?\s*([^:]+):\s*(.*)$/
            ];
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                let headerMatch = null;
                
                for (const pattern of headerPatterns) {
                    headerMatch = line.match(pattern);
                    if (headerMatch) break;
                }
                
                if (headerMatch) {
                    if (collectingNames && currentMessage) {
                        const names = extractNamesFromMessage(currentMessage, dateVariants);
                        names.forEach(name => {
                            guests.push({ name, submittedBy: currentSender, timestamp: currentTimestamp });
                        });
                    }
                    
                    currentTimestamp = headerMatch[1] + ' ' + headerMatch[2];
                    currentSender = headerMatch[3].trim();
                    currentMessage = headerMatch[4];
                    collectingNames = dateVariants.some(d => currentMessage.toLowerCase().includes(d.toLowerCase()));
                } else if (line.trim() && collectingNames) {
                    currentMessage += '\n' + line;
                } else if (line.trim()) {
                    if (dateVariants.some(d => line.toLowerCase().includes(d.toLowerCase()))) {
                        const names = extractNamesFromMessage(line, dateVariants);
                        names.forEach(name => {
                            guests.push({ name, submittedBy: 'Unknown', timestamp: '' });
                        });
                    }
                }
            }
            
            if (collectingNames && currentMessage) {
                const names = extractNamesFromMessage(currentMessage, dateVariants);
                names.forEach(name => {
                    guests.push({ name, submittedBy: currentSender, timestamp: currentTimestamp });
                });
            }
            
            const uniqueGuests = [];
            const seen = new Set();
            guests.forEach(g => {
                const key = g.name.toLowerCase();
                if (!seen.has(key) && g.name.length > 1) {
                    seen.add(key);
                    uniqueGuests.push(g);
                }
            });
            
            parsedGuestList = uniqueGuests;
            displayGuestList(uniqueGuests, eventName, dateInput);
        }
        
        function generateDateVariants(dateInput) {
            const variants = [dateInput];
            const parts = dateInput.split(/[\./]/);
            if (parts.length >= 2) {
                const day = parts[0].padStart(2, '0');
                const month = parts[1].padStart(2, '0');
                let year = parts[2] || new Date().getFullYear().toString().slice(-2);
                const year2 = year.length === 4 ? year.slice(-2) : year;
                const year4 = year.length === 2 ? '20' + year : year;
                
                variants.push(`${day}.${month}.${year2}`, `${day}.${month}.${year4}`);
                variants.push(`${day}/${month}/${year2}`, `${day}/${month}/${year4}`);
                variants.push(`${parseInt(day)}.${parseInt(month)}.${year2}`);
                variants.push(`${parseInt(day)}/${parseInt(month)}/${year4}`);
            }
            return [...new Set(variants)];
        }
        
        function extractNamesFromMessage(message, dateVariants) {
            const names = [];
            let cleanMessage = message;
            
            dateVariants.forEach(d => {
                cleanMessage = cleanMessage.replace(new RegExp(d.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi'), '');
            });
            
            const keywords = ['GL', 'GUESTLIST', 'GUEST LIST', 'GSTE', 'TURBO', 'SELECTED', 'NYE', 
                'SILVESTER', 'HALLOWEEN', 'GRELLE', 'FORELLE', 'VIP', 'FREE', 'ENTRY', 'EINTRITT', '+1', '+2', '+3'];
            keywords.forEach(kw => {
                cleanMessage = cleanMessage.replace(new RegExp('\\*?' + kw + '\\*?', 'gi'), '');
            });
            
            const lines = cleanMessage.split(/[\n,;\/\\|]+/);
            
            lines.forEach(line => {
                let name = line.trim();
                name = name.replace(/^[\s\-*#\d.\)]+/, '').trim();
                name = name.replace(/[.,;:!?]+$/, '').trim();
                
                const subNames = name.split(/,\s*/);
                subNames.forEach(subName => {
                    subName = subName.trim();
                    if (subName.length < 2) return;
                    if (/^\d+$/.test(subName)) return;
                    if (/^[^a-zA-Z]+$/.test(subName)) return;
                    if (/^(ja|nein|ok|yes|no|danke|bitte|hi|hey|hallo|hello|thx|thanks)$/i.test(subName)) return;
                    
                    if (/[a-zA-Z]/.test(subName)) {
                        subName = subName.split(' ').map(word => 
                            word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()
                        ).join(' ');
                        names.push(subName);
                    }
                });
            });
            
            return names;
        }
        
        function displayGuestList(guests, eventName, date) {
            const resultsDiv = document.getElementById('gl-results');
            const summaryDiv = document.getElementById('gl-summary');
            const outputDiv = document.getElementById('gl-output');
            
            resultsDiv.style.display = 'block';
            
            const submitters = [...new Set(guests.map(g => g.submittedBy))].filter(s => s !== 'Unknown');
            
            summaryDiv.innerHTML = `
                <div style="background: #252542; padding: 15px; border-radius: 10px; text-align: center;">
                    <div style="font-size: 28px; font-weight: 700; color: #22c55e;">${guests.length}</div>
                    <div style="font-size: 12px; color: #888;">Gste</div>
                </div>
                <div style="background: #252542; padding: 15px; border-radius: 10px; text-align: center;">
                    <div style="font-size: 28px; font-weight: 700; color: #3b82f6;">${submitters.length}</div>
                    <div style="font-size: 12px; color: #888;">Submitter</div>
                </div>
                <div style="background: #252542; padding: 15px; border-radius: 10px; text-align: center;">
                    <div style="font-size: 18px; font-weight: 700; color: #f59e0b;">${eventName}</div>
                    <div style="font-size: 12px; color: #888;">${date}</div>
                </div>
            `;
            
            let html = `<div style="font-weight: 700; font-size: 16px; margin-bottom: 15px; color: #fff;">
                GUEST LIST  ${eventName.toUpperCase()} ${date}
            </div>`;
            
            html += `<table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="border-bottom: 2px solid #3d3d54;">
                        <th style="text-align: left; padding: 8px; color: #888; font-size: 12px;">#</th>
                        <th style="text-align: left; padding: 8px; color: #888; font-size: 12px;">NAME</th>
                        <th style="text-align: left; padding: 8px; color: #888; font-size: 12px;">SUBMITTED BY</th>
                    </tr>
                </thead>
                <tbody>`;
            
            guests.forEach((g, i) => {
                html += `<tr style="border-bottom: 1px solid #3d3d54;">
                    <td style="padding: 8px; color: #666; font-size: 12px;">${i + 1}</td>
                    <td style="padding: 8px; font-weight: 600;">${escapeHtml(g.name)}</td>
                    <td style="padding: 8px; color: #888; font-size: 13px;">${escapeHtml(g.submittedBy)}</td>
                </tr>`;
            });
            
            html += `</tbody></table>`;
            outputDiv.innerHTML = html;
            
            showToast(` ${guests.length} Gste gefunden!`);
        }
        
        function copyGuestList() {
            if (parsedGuestList.length === 0) {
                showToast(' Keine Gste zum Kopieren', true);
                return;
            }
            
            const eventName = document.getElementById('gl-event-name').value.trim() || 'EVENT';
            const date = document.getElementById('gl-date').value.trim();
            
            let text = `GUEST LIST  ${eventName.toUpperCase()} ${date}\n`;
            text += ''.repeat(40) + '\n\n';
            
            parsedGuestList.forEach((g, i) => {
                text += `${i + 1}. ${g.name}`;
                if (g.submittedBy && g.submittedBy !== 'Unknown') {
                    text += ` (via ${g.submittedBy})`;
                }
                text += '\n';
            });
            
            text += '\n' + ''.repeat(40);
            text += `\nTotal: ${parsedGuestList.length} Gste`;
            
            navigator.clipboard.writeText(text).then(() => {
                showToast(' Guest List kopiert!');
            }).catch(() => {
                showToast(' Kopieren fehlgeschlagen', true);
            });
        }
        
        function downloadGuestListCSV() {
            if (parsedGuestList.length === 0) {
                showToast(' Keine Gste zum Exportieren', true);
                return;
            }
            
            const eventName = document.getElementById('gl-event-name').value.trim() || 'EVENT';
            const date = document.getElementById('gl-date').value.trim().replace(/[\./]/g, '-');
            
            let csv = 'Nr,Name,Submitted By\n';
            parsedGuestList.forEach((g, i) => {
                csv += `${i + 1},"${g.name}","${g.submittedBy}"\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `GuestList_${eventName}_${date}.csv`;
            link.click();
            
            showToast(' CSV heruntergeladen!');
        }
        
        function escapeHtml(str) {
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }
        
        // 
        // EMAIL COMPOSER
        // 
        
        async function sendEmail() {
            const to = document.getElementById('email-to').value;
            const subject = document.getElementById('email-subject').value;
            const body = document.getElementById('email-body').value;
            const status = document.getElementById('email-status');
            
            if (!to || !subject || !body) {
                status.textContent = 'Bitte alle Felder ausfuellen';
                status.style.color = '#f59e0b';
                return;
            }
            
            if (!accessToken) {
                status.textContent = ' Bitte zuerst mit Microsoft anmelden';
                status.style.color = '#ef4444';
                return;
            }
            
            status.textContent = ' Sende...';
            status.style.color = '#888';
            
            try {
                const response = await fetch('https://graph.microsoft.com/v1.0/me/sendMail', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + accessToken,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: {
                            subject: subject,
                            body: { contentType: 'Text', content: body },
                            toRecipients: [{ emailAddress: { address: to } }]
                        }
                    })
                });
                
                if (response.ok || response.status === 202) {
                    status.textContent = ' E-Mail gesendet!';
                    status.style.color = '#22c55e';
                    showToast(' E-Mail gesendet!');
                    // Clear form after 2 seconds
                    setTimeout(() => {
                        document.getElementById('email-to').value = '';
                        document.getElementById('email-subject').value = '';
                        document.getElementById('email-body').value = '';
                        status.textContent = '';
                        closeModal('email-modal');
                    }, 2000);
                } else {
                    const err = await response.json();
                    status.textContent = ' Fehler: ' + (err.error?.message || 'Unbekannt');
                    status.style.color = '#ef4444';
                }
            } catch (e) {
                status.textContent = ' Fehler: ' + e.message;
                status.style.color = '#ef4444';
            }
        }
        
        // Save email as draft in Outlook
        // Get fresh token with specific scopes
        async function getMailToken() {
            if (!msalInstance) return null;
            const accounts = msalInstance.getAllAccounts();
            if (accounts.length === 0) return null;
            
            try {
                const response = await msalInstance.acquireTokenSilent({
                    scopes: ["Mail.ReadWrite", "Mail.Send"],
                    account: accounts[0]
                });
                return response.accessToken;
            } catch (e) {
                console.log('Silent token failed, trying popup:', e);
                try {
                    const response = await msalInstance.acquireTokenPopup({
                        scopes: ["Mail.ReadWrite", "Mail.Send"],
                        account: accounts[0]
                    });
                    return response.accessToken;
                } catch (e2) {
                    console.error('Token popup failed:', e2);
                    return null;
                }
            }
        }
        
        async function saveEmailDraft() {
            const to = document.getElementById('email-to').value;
            const subject = document.getElementById('email-subject').value;
            const body = document.getElementById('email-body').value;
            const status = document.getElementById('email-status');
            
            if (!subject || !body) {
                status.textContent = 'Bitte mindestens Betreff und Nachricht ausfuellen';
                status.style.color = '#f59e0b';
                return;
            }
            
            if (!accessToken) {
                status.textContent = ' Bitte zuerst mit Microsoft anmelden';
                status.style.color = '#ef4444';
                return;
            }
            
            status.textContent = 'Speichere als Entwurf...';
            status.style.color = '#888';
            
            try {
                // Get fresh token with mail scopes
                const mailToken = await getMailToken();
                if (!mailToken) {
                    status.textContent = ' Keine Mail-Berechtigung. Bitte neu anmelden.';
                    status.style.color = '#ef4444';
                    return;
                }
                
                // Build message object
                const messageData = {
                    subject: subject,
                    body: { contentType: 'Text', content: body }
                };
                
                // Add recipient if provided
                if (to) {
                    messageData.toRecipients = [{ emailAddress: { address: to } }];
                }
                
                console.log('Saving draft with data:', messageData);
                
                // POST to /me/messages creates a draft (without sending)
                const response = await fetch('https://graph.microsoft.com/v1.0/me/messages', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + mailToken,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(messageData)
                });
                
                console.log('Draft response status:', response.status);
                
                if (response.ok || response.status === 201) {
                    status.textContent = ' Entwurf gespeichert!';
                    status.style.color = '#22c55e';
                    showToast(' Entwurf in Outlook gespeichert!');
                    // Clear form after 2 seconds
                    setTimeout(() => {
                        document.getElementById('email-to').value = '';
                        document.getElementById('email-subject').value = '';
                        document.getElementById('email-body').value = '';
                        status.textContent = '';
                        closeModal('email-modal');
                    }, 2000);
                } else {
                    const err = await response.json();
                    console.error('Draft error:', err);
                    status.textContent = ' Fehler: ' + (err.error?.message || 'Unbekannt');
                    status.style.color = '#ef4444';
                }
            } catch (e) {
                console.error('Draft exception:', e);
                status.textContent = ' Fehler: ' + e.message;
                status.style.color = '#ef4444';
            }
        }
        
        function esc(str) { const d = document.createElement('div'); d.textContent = str; return d.innerHTML; }
        
        // 

        // 
        // BMT CALENDAR INTEGRATION
        // 
        
        const BMT_FEED_URL = 'https://club.bookmetender.com/calendars/xyXNmcPyOjvcBuFs62MvnEq6uF07RAkkOb2oLXTPhDk%3D.ics';
        let bmtEvents = [];
        let bmtSectionOpen = false;
        
        // Auto-load BMT calendar via CORS proxy
        async function autoLoadBMT() {
            showToast(' Lade BMT Kalender...');
            
            // Try multiple CORS proxies
            const proxies = [
                'https://api.allorigins.win/raw?url=',
                'https://corsproxy.io/?'
            ];
            
            for (const proxy of proxies) {
                try {
                    const response = await fetch(proxy + encodeURIComponent(BMT_FEED_URL), {
                        method: 'GET',
                        headers: { 'Accept': 'text/calendar' }
                    });
                    
                    if (response.ok) {
                        const icsData = await response.text();
                        
                        // Verify it's valid ICS data
                        if (icsData.includes('BEGIN:VCALENDAR')) {
                            bmtEvents = parseICS(icsData);
                            
                            // Save to localStorage
                            localStorage.setItem('bmtEvents', JSON.stringify(bmtEvents));
                            localStorage.setItem('bmtLastUpdate', new Date().toISOString());
                            
                            renderBMTEvents();
                            renderUpcomingFromBMT();
                            populateFactsheetDropdown();
            
                            showToast(' ' + bmtEvents.length + ' BMT Events geladen!');
                            return;
                        }
                    }
                } catch (err) {
                    console.log('Proxy failed:', proxy, err);
                }
            }
            
            // All proxies failed - offer manual download
            showToast(' Auto-Load fehlgeschlagen. Bitte manuell herunterladen.', true);
            
            // Open direct download link
            if (confirm('Auto-Load nicht mglich (CORS).\n\nKlicke OK um die .ics Datei herunterzuladen, dann lade sie mit dem  Button hoch.')) {
                window.open(BMT_FEED_URL, '_blank');
            }
        }
        
        // Toggle BMT Section
        function toggleBMTSection() {
            const container = document.getElementById('bmt-events-container');
            const toggle = document.getElementById('bmt-toggle');
            bmtSectionOpen = !bmtSectionOpen;
            
            if (bmtSectionOpen) {
                container.classList.remove('bmt-collapsed');
                container.classList.add('bmt-expanded');
                toggle.classList.add('open');
            } else {
                container.classList.add('bmt-collapsed');
                container.classList.remove('bmt-expanded');
                toggle.classList.remove('open');
            }
        }
        
        // Toggle Upcoming Events Section (whole section)
        let upcomingSectionOpen = false;
        function toggleUpcomingSection() {
            const container = document.getElementById('upcoming-events-container');
            const toggle = document.getElementById('upcoming-toggle');
            const header = document.querySelector('.upcoming-section-header');
            upcomingSectionOpen = !upcomingSectionOpen;
            
            if (upcomingSectionOpen) {
                container.classList.remove('upcoming-collapsed');
                container.classList.add('upcoming-expanded');
                toggle.style.transform = 'rotate(180deg)';
                header.classList.remove('collapsed');
            } else {
                container.classList.add('upcoming-collapsed');
                container.classList.remove('upcoming-expanded');
                toggle.style.transform = 'rotate(0deg)';
                header.classList.add('collapsed');
            }
        }
        
        // Toggle individual upcoming event card
        function toggleUpcomingEvent(idx) {
            const card = document.getElementById('upcoming-event-' + idx);
            if (card) {
                card.classList.toggle('open');
                // Initialize projection when opening
                if (card.classList.contains('open')) {
                    calcEventProj(idx);
                }
            }
        }
        
        // Open event in BMT
        function openInBMT(eventUid) {
            window.open('https://club.bookmetender.com/events', '_blank');
        }
        
        // Open BMT Factsheet - pre-fills factsheet from BMT event
        function openBMTFactsheet(encodedData) {
            try {
                const eventData = JSON.parse(decodeURIComponent(encodedData));
                const eventDate = new Date(eventData.date);
                const dayNames = ['Sonntag', 'Montag', 'Dienstag', 'Mittwoch', 'Donnerstag', 'Freitag', 'Samstag'];
                
                // Determine template based on event time/category
                const eventHour = eventDate.getHours();
                let template = 'CLUB';
                if (eventData.category === 'konzert' || eventHour === 19) {
                    template = 'CONCERT';
                }
                
                // Format date as "Samstag, 27.12.2025"
                const dateStr = dayNames[eventDate.getDay()] + ', ' + 
                    eventDate.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit', year: 'numeric' });
                
                // Pre-fill ALL factsheet modal fields
                document.getElementById('fs-event-name').value = eventData.name || '';
                document.getElementById('fs-datum').value = dateStr;
                document.getElementById('fs-template').value = template;
                
                // Reset dropdown to no selection (manual entry)
                document.getElementById('fs-event-select').value = '';
                
                // Show/hide main floor row based on template
                const mainFloorRow = document.getElementById('main-floor-row');
                if (mainFloorRow) {
                    mainFloorRow.style.display = template === 'CLUB' ? 'flex' : 'none';
                }
                
                // Set default Main Floor time for club nights
                if (template === 'CLUB') {
                    const radio00 = document.querySelector('input[name="main-floor-time"][value="00:00"]');
                    if (radio00) radio00.checked = true;
                }
                
                // Update preview
                updateFactsheetPreview();
                
                // Open factsheet modal
                openModal('factsheet-modal');
                
                console.log('Factsheet loaded for:', eventData.name);
                showToast(eventData.name + ' geladen');
            } catch (e) {
                console.error('Error parsing BMT event data:', e);
                showToast('Fehler beim Laden', 'error');
            }
        }
        
        // Open Cleaning Modal
        function openCleaningModal() {
            populateMonthSelect();
            generateCleaningSchedule();
            openModal('cleaning-modal');
        }
        
        // Populate month selector
        function populateMonthSelect() {
            const select = document.getElementById('cleaning-month');
            const now = new Date();
            select.innerHTML = '';
            
            // Add current month + next 3 months
            for (let i = 0; i < 4; i++) {
                const d = new Date(now.getFullYear(), now.getMonth() + i, 1);
                const monthName = d.toLocaleDateString('de-DE', { month: 'long', year: 'numeric' });
                const value = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
                select.innerHTML += `<option value="${value}">${monthName}</option>`;
            }
        }
        
        // Parse iCal data
        function parseICS(icsData) {
            const events = [];
            const lines = icsData.split(/\r?\n/);
            let currentEvent = null;
            let currentField = null;
            
            for (let i = 0; i < lines.length; i++) {
                let line = lines[i];
                
                // Handle line continuations (lines starting with space)
                while (i + 1 < lines.length && (lines[i + 1].startsWith(' ') || lines[i + 1].startsWith('\t'))) {
                    i++;
                    line += lines[i].substring(1);
                }
                
                if (line === 'BEGIN:VEVENT') {
                    currentEvent = {};
                } else if (line === 'END:VEVENT' && currentEvent) {
                    // Parse the event
                    const event = {
                        uid: currentEvent.UID || '',
                        summary: currentEvent.SUMMARY || 'Unknown Event',
                        dtstart: parseICSDate(currentEvent.DTSTART || currentEvent['DTSTART;VALUE=DATE'] || ''),
                        dtend: parseICSDate(currentEvent.DTEND || currentEvent['DTEND;VALUE=DATE'] || ''),
                        description: decodeICSText(currentEvent.DESCRIPTION || ''),
                        location: decodeICSText(currentEvent.LOCATION || ''),
                        category: extractCategory(currentEvent.DESCRIPTION || ''),
                        lineup: extractLineup(currentEvent.DESCRIPTION || '')
                    };
                    
                    // Only include future events and recent past
                    const now = new Date();
                    now.setDate(now.getDate() - 7); // Include events from 7 days ago
                    if (event.dtstart && event.dtstart >= now) {
                        events.push(event);
                    }
                    currentEvent = null;
                } else if (currentEvent) {
                    const colonIndex = line.indexOf(':');
                    if (colonIndex > 0) {
                        let key = line.substring(0, colonIndex);
                        const value = line.substring(colonIndex + 1);
                        
                        // Handle properties with parameters like DTSTART;TZID=Europe/Berlin
                        if (key.includes(';')) {
                            const parts = key.split(';');
                            key = parts[0];
                        }
                        
                        currentEvent[key] = value;
                    }
                }
            }
            
            // Sort by date
            events.sort((a, b) => a.dtstart - b.dtstart);
            return events;
        }
        
        function parseICSDate(dateStr) {
            if (!dateStr) return null;
            
            // Remove timezone info for parsing
            const cleanDate = dateStr.replace(/;TZID=[^:]+/, '').replace(/^:/, '');
            
            // Format: YYYYMMDD or YYYYMMDDTHHmmss or YYYYMMDDTHHmmssZ
            const match = cleanDate.match(/(\d{4})(\d{2})(\d{2})(?:T(\d{2})(\d{2})(\d{2}))?/);
            if (match) {
                const [, year, month, day, hour = '00', min = '00', sec = '00'] = match;
                return new Date(year, parseInt(month) - 1, day, hour, min, sec);
            }
            return null;
        }
        
        function decodeICSText(text) {
            return text
                .replace(/\\n/g, '\n')
                .replace(/\\,/g, ',')
                .replace(/\\;/g, ';')
                .replace(/\\\\/g, '\\');
        }
        
        function extractCategory(description) {
            const match = description.match(/Event Category:\s*([^\n]+)/i);
            if (match) {
                const cat = match[1].trim().toLowerCase();
                if (cat.includes('eigen')) return 'eigen';
                if (cat.includes('fremd')) return 'fremd';
                if (cat.includes('konzert') || cat.includes('newdeal')) return 'konzert';
                if (cat.includes('feiertag') || cat.includes('holiday')) return 'holiday';
                if (cat.includes('special') || cat.includes('firmen')) return 'special';
            }
            return 'fremd';
        }
        
        function extractLineup(description) {
            const match = description.match(/Lineup:\s*([^\n]+)/i);
            return match ? match[1].trim() : '';
        }
        
        // Handle file upload
        function handleBMTUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const icsData = e.target.result;
                    bmtEvents = parseICS(icsData);
                    
                    // Save to localStorage
                    localStorage.setItem('bmtEvents', JSON.stringify(bmtEvents));
                    localStorage.setItem('bmtLastUpdate', new Date().toISOString());
                    
                    renderBMTEvents();
                    renderUpcomingFromBMT();
                    populateFactsheetDropdown();
            
                    showToast(' ' + bmtEvents.length + ' BMT Events geladen!');
                } catch (err) {
                    console.error('Error parsing ICS:', err);
                    showToast(' Fehler beim Parsen der ICS Datei', 'error');
                }
            };
            reader.readAsText(file);
        }
        
        // Load from localStorage
        function refreshBMTFromStorage() {
            const stored = localStorage.getItem('bmtEvents');
            const lastUpdate = localStorage.getItem('bmtLastUpdate');
            
            if (stored) {
                try {
                    bmtEvents = JSON.parse(stored);
                    // Convert date strings back to Date objects
                    bmtEvents = bmtEvents.map(e => ({
                        ...e,
                        dtstart: new Date(e.dtstart),
                        dtend: new Date(e.dtend)
                    }));
                    renderBMTEvents();
                    renderUpcomingFromBMT();
                    populateFactsheetDropdown();
            
                    
                    if (lastUpdate) {
                        const updateDate = new Date(lastUpdate);
                        showToast(' Events geladen (Update: ' + updateDate.toLocaleDateString('de-DE') + ')');
                    }
                } catch (err) {
                    console.error('Error loading stored events:', err);
                    document.getElementById('bmt-status').innerHTML = 
                        ' Fehler beim Laden. Bitte .ics Datei neu uploaden.';
                }
            } else {
                document.getElementById('bmt-status').innerHTML = 
                    ' Keine Events gespeichert.<br><small>Bitte .ics Datei von BookMeTender uploaden</small>';
            }
        }
        
        // Render BMT Events
        function renderBMTEvents() {
            const container = document.getElementById('bmt-events-container');
            const countBadge = document.getElementById('bmt-event-count');
            
            // Filter by selected months (or show all if no filter)
            const now = new Date();
            
            const upcomingEvents = bmtEvents.filter(e => {
                const eventMonth = e.dtstart.getMonth() + 1;
                const summaryLower = e.summary.toLowerCase();
                // Only show club nights and concerts (EIGEN, FREMD, KONZERT)
                const isEvent = e.category === 'eigen' || e.category === 'fremd' || e.category === 'konzert';
                const isNotHoliday = e.category !== 'holiday' && !summaryLower.includes('holiday');
                const isNotClosed = !summaryLower.includes('geschlossen') && !summaryLower.includes('closed');
                const isNotAppointment = !summaryLower.includes('termin') && !summaryLower.includes('meeting') && !summaryLower.includes('besprechung');
                const isFuture = e.dtstart >= now;
                const monthMatch = selectedMonths.size === 0 || selectedMonths.has(eventMonth);
                return isEvent && isNotHoliday && isNotClosed && isNotAppointment && isFuture && monthMatch;
            });
            
            countBadge.textContent = upcomingEvents.length;
            
            if (upcomingEvents.length === 0) {
                container.innerHTML = '<div class="bmt-status">Keine Events in den nchsten 30 Tagen</div>';
                return;
            }
            
            const dayNames = ['So', 'Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa'];
            
            container.innerHTML = '<div class="bmt-events-grid">' + 
                upcomingEvents.map(event => {
                    const dateStr = event.dtstart.toLocaleDateString('de-DE', { 
                        day: '2-digit', 
                        month: '2-digit',
                        year: 'numeric'
                    });
                    const dayName = dayNames[event.dtstart.getDay()];
                    const timeStr = event.dtstart.toLocaleTimeString('de-DE', { 
                        hour: '2-digit', 
                        minute: '2-digit' 
                    });
                    
                    const catClass = event.category;
                    const catLabel = {
                        'eigen': 'Eigen',
                        'fremd': 'Fremd',
                        'konzert': 'Konzert',
                        'special': 'Special',
                        'holiday': 'Feiertag'
                    }[catClass] || 'Event';
                    
                    // Encode event data for factsheet button
                    const eventData = encodeURIComponent(JSON.stringify({
                        name: event.summary,
                        date: event.dtstart.toISOString(),
                        category: event.category,
                        uid: event.uid
                    }));
                    
                    return `
                        <div class="bmt-event-card ${catClass}">
                            <div class="bmt-event-date">${dayName}, ${dateStr}  ${timeStr}</div>
                            <div class="bmt-event-name" title="${escapeHtml(event.summary)}">${escapeHtml(event.summary)}</div>
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 6px;">
                                <span class="bmt-event-category ${catClass}">${catLabel}</span>
                                <button onclick="event.stopPropagation(); openBMTFactsheet('${eventData}')" style="background: #3b82f6; border: none; color: white; padding: 4px 10px; border-radius: 4px; font-size: 11px; cursor: pointer; font-weight: 600;" title="Factsheet erstellen">FS</button>
                            </div>
                        </div>
                    `;
                }).join('') + '</div>';
            
            // Also update Technikerkalender when BMT events are loaded
            renderTechnikCalendar();
            renderRunnerShiftplan();
        }
        
        // Render Upcoming Events from BMT data (next 4 events)
        function renderUpcomingFromBMT() {
            const container = document.getElementById('upcoming-events-container');
            const countBadge = document.getElementById('upcoming-count');
            
            if (!container) return;
            
            if (!bmtEvents || bmtEvents.length === 0) {
                container.innerHTML = '<div class="upcoming-placeholder"><p>Upload BMT .ics Datei um Events zu sehen</p><small>Events werden automatisch aus BookMeTender geladen</small></div>';
                if (countBadge) countBadge.textContent = '0';
                return;
            }
            
            const now = new Date();
            const upcomingEvents = bmtEvents
                .filter(e => {
                    const summaryLower = (e.summary || '').toLowerCase();
                    const isEvent = e.category === 'eigen' || e.category === 'fremd' || e.category === 'konzert';
                    const isNotHoliday = e.category !== 'holiday' && !summaryLower.includes('holiday');
                    const isNotClosed = !summaryLower.includes('geschlossen') && !summaryLower.includes('closed');
                    const isNotAppointment = !summaryLower.includes('termin') && !summaryLower.includes('meeting');
                    const isFuture = e.dtstart >= now;
                    return isEvent && isNotHoliday && isNotClosed && isNotAppointment && isFuture;
                })
                .slice(0, 4);
            
            if (countBadge) countBadge.textContent = upcomingEvents.length;
            
            if (upcomingEvents.length === 0) {
                container.innerHTML = '<div class="upcoming-placeholder"><p>Keine kommenden Events</p></div>';
                return;
            }
            
            // Store events globally for factsheet access
            window.upcomingEventsData = upcomingEvents;
            
            const dayNames = ['So', 'Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa'];
            
            container.innerHTML = upcomingEvents.map((event, idx) => {
                const dayName = dayNames[event.dtstart.getDay()];
                const dateStr = event.dtstart.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit' });
                const isEigen = event.category === 'eigen';
                const isKonzert = event.category === 'konzert';
                const typeClass = isEigen ? 'eigen' : (isKonzert ? 'konzert' : 'fremd');
                const typeLabel = isEigen ? 'EIGEN' : (isKonzert ? 'KONZERT' : 'FREMD');
                
                // Calculate days until event
                const today = new Date(); today.setHours(0,0,0,0);
                const eventDate = new Date(event.dtstart); eventDate.setHours(0,0,0,0);
                const daysUntil = Math.ceil((eventDate - today) / (1000 * 60 * 60 * 24));
                const daysText = daysUntil === 0 ? 'HEUTE' : daysUntil === 1 ? '1 Tag' : daysUntil + ' Tage';
                const daysColor = daysUntil <= 3 ? '#ef4444' : daysUntil <= 7 ? '#f59e0b' : '#22c55e';
                
                // VVK Tracker only for CLUB NIGHTS (not concerts!)
                const showVVKTracker = !isKonzert;
                
                const vvkTrackerHTML = showVVKTracker ? `
                    <div class="vvk-event-tracker" style="padding-top: 12px;">
                        <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 8px;">
                            <div>
                                <label style="font-size: 9px; color: #888; display: block;">VVK aktuell</label>
                                <input type="number" id="vvk-current-${idx}" value="0" oninput="calcEventProj(${idx})" 
                                    style="width: 60px; background: #1a1a2e; border: 1px solid #f59e0b; color: #f59e0b; padding: 4px; border-radius: 4px; font-size: 12px; font-weight: 600;">
                            </div>
                            <div>
                                <label style="font-size: 9px; color: #888; display: block;">Ziel</label>
                                <input type="number" id="vvk-goal-${idx}" value="450" oninput="calcEventProj(${idx})" 
                                    style="width: 55px; background: #2d2d3d; border: 1px solid #3d3d4d; color: white; padding: 4px; border-radius: 4px; font-size: 12px;">
                            </div>
                            <div>
                                <label style="font-size: 9px; color: #888; display: block;">Max</label>
                                <input type="number" id="vvk-max-${idx}" value="550" oninput="calcEventProj(${idx})" 
                                    style="width: 55px; background: #2d2d3d; border: 1px solid #3d3d4d; color: white; padding: 4px; border-radius: 4px; font-size: 12px;">
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px;">
                            <div style="background: #1a1a2e; padding: 6px; border-radius: 4px; text-align: center;">
                                <div style="font-size: 8px; color: #888;">VVK</div>
                                <div id="proj-vvk-${idx}" style="font-size: 14px; font-weight: 700; color: #f59e0b;">~450</div>
                            </div>
                            <div style="background: #1a1a2e; padding: 6px; border-radius: 4px; text-align: center;">
                                <div style="font-size: 8px; color: #888;">FOH</div>
                                <div id="proj-foh-${idx}" style="font-size: 14px; font-weight: 700; color: #3b82f6;">~350</div>
                            </div>
                            <div style="background: #1a1a2e; padding: 6px; border-radius: 4px; text-align: center;">
                                <div style="font-size: 8px; color: #888;">Bar</div>
                                <div id="proj-bar-${idx}" style="font-size: 14px; font-weight: 700; color: #22c55e;">~13k</div>
                            </div>
                            <div style="background: #1a1a2e; padding: 6px; border-radius: 4px; text-align: center;">
                                <div style="font-size: 8px; color: #888;">Total</div>
                                <div id="proj-total-${idx}" style="font-size: 14px; font-weight: 700; color: #8b5cf6;">~28k</div>
                            </div>
                        </div>
                        <div id="vvk-benchmark-${idx}" style="font-size: 9px; color: #888; margin-top: 6px; text-align: center;">Benchmark wird berechnet...</div>
                    </div>
                ` : '<div style="padding-top: 12px; text-align: center; font-size: 11px; color: #8b5cf6;">Konzert - keine VVK Projektion</div>';
                
                return `
                    <div class="upcoming-event-card ${typeClass}" id="upcoming-event-${idx}">
                        <div class="upcoming-event-header" onclick="toggleUpcomingEvent(${idx})">
                            <div class="upcoming-event-left">
                                <span class="upcoming-event-date-badge">${dayName} ${dateStr}</span>
                                <span class="upcoming-event-name ${typeClass}">${event.summary || 'Event'}</span>
                            </div>
                            <div class="upcoming-event-right">
                                <span class="upcoming-event-days" style="color: ${daysColor};">${daysText}</span>
                                <span class="upcoming-event-type ${typeClass}">${typeLabel}</span>
                                <span class="upcoming-event-toggle">v</span>
                            </div>
                        </div>
                        <div class="upcoming-event-content">
                            ${vvkTrackerHTML}
                            <div style="margin-top: 12px; display: flex; gap: 8px;">
                                <button onclick="event.stopPropagation(); openFactsheetForEvent(${idx})" style="flex: 1; background: #3b82f6; border: none; color: white; padding: 8px; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer;">Factsheet</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Initialize projections for all club night events
            upcomingEvents.forEach((event, idx) => {
                if (event.category !== 'konzert') {
                    calcEventProj(idx);
                }
            });
        }
        
        // Open factsheet for a specific event by index
        function openFactsheetForEvent(idx) {
            const events = window.upcomingEventsData;
            if (!events || !events[idx]) {
                console.error('Event not found at index:', idx);
                showToast('Event nicht gefunden', 'error');
                return;
            }
            
            const event = events[idx];
            const dayNames = ['Sonntag', 'Montag', 'Dienstag', 'Mittwoch', 'Donnerstag', 'Freitag', 'Samstag'];
            
            // Determine template
            const isKonzert = event.category === 'konzert';
            const template = isKonzert ? 'CONCERT' : 'CLUB';
            
            // Format date
            const dateStr = dayNames[event.dtstart.getDay()] + ', ' + 
                event.dtstart.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit', year: 'numeric' });
            
            // Fill form fields
            document.getElementById('fs-event-name').value = event.summary || '';
            document.getElementById('fs-datum').value = dateStr;
            document.getElementById('fs-template').value = template;
            document.getElementById('fs-event-select').value = '';
            
            // Show/hide main floor row
            const mainFloorRow = document.getElementById('main-floor-row');
            if (mainFloorRow) {
                mainFloorRow.style.display = template === 'CLUB' ? 'flex' : 'none';
            }
            
            // Set default radio for club
            if (template === 'CLUB') {
                const radio = document.querySelector('input[name="main-floor-time"][value="00:00"]');
                if (radio) radio.checked = true;
            }
            
            // Update preview
            updateFactsheetPreview();
            
            // Open modal
            openModal('factsheet-modal');
            
            console.log('Factsheet opened for:', event.summary);
            showToast(event.summary + ' geladen');
        }
        
        // Calculate projection for a specific event
        function calcEventProj(idx) {
            const events = window.upcomingEventsData;
            if (!events || !events[idx]) return;
            
            const event = events[idx];
            const currentVVK = parseInt(document.getElementById('vvk-current-' + idx)?.value) || 0;
            const vvkGoal = parseInt(document.getElementById('vvk-goal-' + idx)?.value) || 450;
            const vvkMax = parseInt(document.getElementById('vvk-max-' + idx)?.value) || 550;
            
            const today = new Date(); today.setHours(0,0,0,0);
            const eventDate = new Date(event.dtstart); eventDate.setHours(0,0,0,0);
            const days = Math.ceil((eventDate - today) / (1000 * 60 * 60 * 24));
            
            // Benchmarks
            const benchmarks = { 14: 0.35, 10: 0.42, 7: 0.50, 5: 0.55, 3: 0.65, 2: 0.72, 1: 0.80, 0: 0.85 };
            let pct = 0.5;
            for (const d of [14, 10, 7, 5, 3, 2, 1, 0]) {
                if (days >= d) { pct = benchmarks[d]; break; }
            }
            
            // Projections
            let projVVK = currentVVK > 0 ? Math.min(Math.round(currentVVK / pct), vvkMax) : vvkGoal;
            let projFOH = Math.min(Math.round(projVVK * 0.77), 700);
            const projBar = (projVVK + projFOH) * 16.5;
            const projTotal = (projVVK * 18) + (projFOH * 22) + projBar;
            
            // Update UI
            const vvkEl = document.getElementById('proj-vvk-' + idx);
            const fohEl = document.getElementById('proj-foh-' + idx);
            const barEl = document.getElementById('proj-bar-' + idx);
            const totalEl = document.getElementById('proj-total-' + idx);
            const benchEl = document.getElementById('vvk-benchmark-' + idx);
            
            if (vvkEl) vvkEl.textContent = '~' + projVVK;
            if (fohEl) fohEl.textContent = '~' + projFOH;
            if (barEl) barEl.textContent = '~' + (projBar / 1000).toFixed(1) + 'k';
            if (totalEl) totalEl.textContent = '~' + (projTotal / 1000).toFixed(0) + 'k';
            
            const expected = Math.round(vvkGoal * pct);
            const status = currentVVK >= expected ? 'On Track' : 'Behind';
            if (benchEl) benchEl.textContent = Math.round(pct * 100) + '% Benchmark @ ' + days + 'd = ~' + expected + ' (' + status + ')';
        }
        
        
        // SPUTNIK RESERVATIONS (Google Calendar)
        
        const SPUTNIK_CALENDAR_ID = '355f939de7df075c2527053dadea64b9ba41a6916d7e1917043623230b6b7451@group.calendar.google.com';
        
        function loadSputnikReservations() {
            const container = document.getElementById('sputnik-reservations-container');
            if (!container) return;
            
            const encodedCalId = encodeURIComponent(SPUTNIK_CALENDAR_ID);
            const calendarUrl = `https://calendar.google.com/calendar/embed?src=${encodedCalId}&mode=AGENDA&showTitle=0&showNav=1&showPrint=0&showTabs=0&showCalendars=0&showTz=0&height=350&wkst=2&bgcolor=%23F3E5F5&ctz=Europe%2FVienna`;
            
            container.innerHTML = `
                <div style="background: white; border-radius: 8px; overflow: hidden;">
                    <iframe src="${calendarUrl}" 
                            style="border: 0; width: 100%; height: 350px;" 
                            frameborder="0" 
                            scrolling="no">
                    </iframe>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 10px; justify-content: center;">
                    <a href="https://calendar.google.com/calendar/u/0?cid=MzU1ZjkzOWRlN2RmMDc1YzI1MjcwNTNkYWRlYTY0YjliYTQxYTY5MTZkN2UxOTE3MDQzNjIzMjMwYjZiNzQ1MUBncm91cC5jYWxlbmRhci5nb29nbGUuY29t" 
                       target="_blank"
                       style="background: #8E24AA; color: white; padding: 8px 16px; border-radius: 6px; text-decoration: none; font-size: 13px; font-weight: 600;">
                         In Google Calendar ffnen
                    </a>
                    <button onclick="loadSputnikReservations()" 
                            style="background: #6b7280; color: white; padding: 8px 16px; border-radius: 6px; border: none; font-size: 13px; cursor: pointer; font-weight: 600;">
                         Aktualisieren
                    </button>
                </div>
            `;
        }
        
        // Auto-load reservations on page load
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(loadSputnikReservations, 1500);
        });
        
        // CLEANING SCHEDULE GENERATOR
        // 
        
        // Austrian public holidays 2025/2026
        const HOLIDAYS = [
            '2025-01-01', '2025-01-06', '2025-04-21', '2025-05-01', '2025-05-29',
            '2025-06-09', '2025-06-19', '2025-08-15', '2025-10-26', '2025-11-01',
            '2025-12-08', '2025-12-25', '2025-12-26',
            '2026-01-01', '2026-01-06', '2026-04-06', '2026-05-01', '2026-05-14',
            '2026-05-25', '2026-06-04', '2026-08-15', '2026-10-26', '2026-11-01',
            '2026-12-08', '2026-12-25', '2026-12-26'
        ];
        
        function isHoliday(date) {
            const dateStr = date.toISOString().split('T')[0];
            return HOLIDAYS.includes(dateStr);
        }
        
        function isWeekend(date) {
            return date.getDay() === 0 || date.getDay() === 6; // Sunday = 0, Saturday = 6
        }
        
        function getNextWorkday(fromDate) {
            const next = new Date(fromDate);
            next.setDate(next.getDate() + 1);
            
            // Skip Sundays and holidays (but NOT Saturdays for Friday events)
            while (next.getDay() === 0 || isHoliday(next)) {
                next.setDate(next.getDate() + 1);
            }
            return next;
        }
        
        function getCleaningDate(eventDate) {
            const dayOfWeek = eventDate.getDay(); // 0=Sun, 1=Mon, ..., 5=Fri, 6=Sat
            const cleaningDate = new Date(eventDate);
            
            if (dayOfWeek === 5) {
                // FRIDAY event  Cleaning on SATURDAY (next day, so club is ready for Sat event)
                cleaningDate.setDate(cleaningDate.getDate() + 1);
            } else if (dayOfWeek === 6) {
                // SATURDAY event  Cleaning on MONDAY (next workday, avoid Sunday double cost)
                cleaningDate.setDate(cleaningDate.getDate() + 2); // +2 = Monday
                // Check if Monday is a holiday
                while (isHoliday(cleaningDate)) {
                    cleaningDate.setDate(cleaningDate.getDate() + 1);
                }
            } else if (dayOfWeek === 0) {
                // SUNDAY event  Cleaning on Monday (next workday)
                cleaningDate.setDate(cleaningDate.getDate() + 1);
                while (isHoliday(cleaningDate)) {
                    cleaningDate.setDate(cleaningDate.getDate() + 1);
                }
            } else {
                // MON-THU event  Cleaning next day
                cleaningDate.setDate(cleaningDate.getDate() + 1);
                // Skip if next day is Sunday or holiday
                while (cleaningDate.getDay() === 0 || isHoliday(cleaningDate)) {
                    cleaningDate.setDate(cleaningDate.getDate() + 1);
                }
            }
            
            cleaningDate.setHours(8, 0, 0, 0);
            return cleaningDate;
        }
        
        function generateCleaningSchedule() {
            const container = document.getElementById('cleaning-container');
            const summaryContainer = document.getElementById('cleaning-summary');
            
            if (bmtEvents.length === 0) {
                container.innerHTML = '<div class="bmt-status">Keine BMT Events geladen. Bitte erst .ics Datei uploaden.</div>';
                summaryContainer.innerHTML = '';
                return;
            }
            
            // Get selected month
            const monthSelect = document.getElementById('cleaning-month');
            const [year, month] = monthSelect.value.split('-').map(Number);
            
            const monthStart = new Date(year, month - 1, 1);
            const monthEnd = new Date(year, month, 0); // Last day of month
            
            // Find events in selected month that need cleaning
            const eventsNeedingCleaning = bmtEvents.filter(e => {
                const isClubOrConcert = ['eigen', 'fremd', 'konzert'].includes(e.category);
                const eventMonth = e.dtstart.getMonth() + 1;
                const eventYear = e.dtstart.getFullYear();
                const isInMonth = eventYear === year && eventMonth === month;
                const isActualEvent = e.dtstart.getHours() >= 18 || e.dtstart.getHours() === 19; // Events 18:00+
                const isNotMeeting = !e.summary.toLowerCase().includes('meeting') && 
                                     !e.summary.toLowerCase().includes('treffen') &&
                                     !e.summary.toLowerCase().includes('holiday');
                return isClubOrConcert && isInMonth && isActualEvent && isNotMeeting;
            });
            
            // Generate cleaning entries
            const cleaningDates = [];
            const dayNames = ['Sonntag', 'Montag', 'Dienstag', 'Mittwoch', 'Donnerstag', 'Freitag', 'Samstag'];
            
            eventsNeedingCleaning.forEach(event => {
                const cleaningDate = getCleaningDate(event.dtstart);
                
                // Determine cleaning type: GROSS for club nights (23:00), MITTEL for concerts (19:00)
                let cleaningType = 'mittel'; // Default
                const eventHour = event.dtstart.getHours();
                if (eventHour >= 23 || eventHour <= 4) {
                    cleaningType = 'gross'; // Club night (23:00) = GROSS
                } else if (eventHour === 19 || event.category === 'konzert') {
                    cleaningType = 'mittel'; // Concert (19:00) = MITTEL
                }
                
                cleaningDates.push({
                    date: cleaningDate,
                    type: cleaningType,
                    eventName: event.summary,
                    eventDate: event.dtstart,
                    eventCategory: event.category
                });
            });
            
            // Sort by cleaning date
            cleaningDates.sort((a, b) => a.date - b.date);
            
            // Merge duplicates (same cleaning date) - keep GROSS if mixed
            const uniqueCleanings = cleaningDates.reduce((acc, curr) => {
                const dateKey = curr.date.toDateString();
                const existing = acc.find(c => c.date.toDateString() === dateKey);
                
                if (!existing) {
                    acc.push({...curr, events: [curr.eventName]});
                } else {
                    if (curr.type === 'gross') {
                        existing.type = 'gross';
                    }
                    existing.events.push(curr.eventName);
                }
                return acc;
            }, []);
            
            if (uniqueCleanings.length === 0) {
                container.innerHTML = '<div class="bmt-status">Keine Reinigungen in diesem Monat geplant</div>';
                summaryContainer.innerHTML = '';
                return;
            }
            
            // Count by type
            const grossCount = uniqueCleanings.filter(c => c.type === 'gross').length;
            const mittelCount = uniqueCleanings.filter(c => c.type === 'mittel').length;
            
            // Build table
            container.innerHTML = `
                <table class="cleaning-table" id="cleaning-table-data">
                    <thead>
                        <tr>
                            <th style="width: 40px;"><input type="checkbox" checked onclick="toggleAllCleanings(this)" title="Alle an/aus"></th>
                            <th>Datum</th>
                            <th>Tag</th>
                            <th>Art</th>
                            <th>Nach Event</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${uniqueCleanings.map((cleaning, idx) => {
                            const dateStr = cleaning.date.toLocaleDateString('de-DE', { 
                                day: '2-digit', 
                                month: '2-digit',
                                year: 'numeric'
                            });
                            const dayName = dayNames[cleaning.date.getDay()];
                            const typeLabel = cleaning.type === 'gross' ? 'GROSS' : 'MITTEL';
                            const eventDayName = dayNames[cleaning.eventDate.getDay()];
                            
                            return `
                                <tr data-type="${cleaning.type}" data-row-id="cleaning-${idx}">
                                    <td style="text-align: center;"><input type="checkbox" class="cleaning-checkbox" checked onchange="toggleCleaningRow(this)"></td>
                                    <td>${dateStr}</td>
                                    <td>${dayName}</td>
                                    <td><span class="cleaning-type ${cleaning.type}">${typeLabel}</span></td>
                                    <td>${eventDayName}: ${escapeHtml(cleaning.events.join(', '))}</td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
            
            // Summary
            summaryContainer.innerHTML = `
                <div style="display: flex; justify-content: space-around; text-align: center;">
                    <div>
                        <div style="font-size: 24px; font-weight: 700; color: #ef4444;">${grossCount}</div>
                        <div style="font-size: 12px; color: #888;">GROSS</div>
                    </div>
                    <div>
                        <div style="font-size: 24px; font-weight: 700; color: #f59e0b;">${mittelCount}</div>
                        <div style="font-size: 12px; color: #888;">MITTEL</div>
                    </div>
                    <div>
                        <div style="font-size: 24px; font-weight: 700; color: #22c55e;">${uniqueCleanings.length}</div>
                        <div style="font-size: 12px; color: #888;">TOTAL</div>
                    </div>
                </div>
            `;
        }
        
        function copyCleaningSchedule() {
            const monthSelect = document.getElementById('cleaning-month');
            const [year, month] = monthSelect.value.split('-').map(Number);
            const monthName = new Date(year, month - 1, 1).toLocaleDateString('de-DE', { month: 'long', year: 'numeric' });
            
            const table = document.getElementById('cleaning-table-data');
            if (!table) {
                showToast(' Keine Daten zum Kopieren', 'error');
                return;
            }
            
            // Only get rows with checked checkboxes
            const checkedRows = table.querySelectorAll('tbody tr:has(.cleaning-checkbox:checked)');
            if (checkedRows.length === 0) {
                showToast(' Keine Reinigungen ausgewhlt', 'error');
                return;
            }
            
            let text = `REINIGUNGSPLAN ${monthName.toUpperCase()}\n`;
            text += `${'='.repeat(50)}\n\n`;
            
            checkedRows.forEach(row => {
                const cells = row.querySelectorAll('td');
                // Index 0 = checkbox, 1 = date, 2 = day, 3 = type, 4 = event
                const date = cells[1].textContent;
                const day = cells[2].textContent;
                const type = cells[3].textContent;
                const event = cells[4].textContent;
                text += `${date} (${day}) - ${type}\n   ${event}\n\n`;
            });
            
            navigator.clipboard.writeText(text).then(() => {
                showToast(` ${checkedRows.length} Reinigungen kopiert!`);
            }).catch(() => {
                showToast(' Kopieren fehlgeschlagen', 'error');
            });
        }
        
        // 
        // CLEANING EMAIL FUNCTIONS
        // 
        
        // Fixed cleaning contacts - always send to all 3
        const CLEANING_CONTACTS = [
            { name: 'Alexander Pichler', email: 'ap@gfg-services.at' },
            { name: 'GFG Services', email: 'pf@gfg-services.at' },
            { name: 'Matthus Gabor', email: 'mg@grelleforelle.com' }
        ];
        
        const SCHADI_SIGNATURE = `
--
Schadi Tayyah
st@grelleforelle.com
Grelle Forelle CEO
Turbo Projects GmbH
Spittelauer Lnde 12/1
1090 Vienna, Austria`;
        
        function showCleaningEmail() {
            const section = document.getElementById('cleaning-email-section');
            section.style.display = 'block';
            
            // Show fixed recipients (no dropdown needed)
            const recipientsList = CLEANING_CONTACTS.map(c => c.email).join(', ');
            document.getElementById('cleaning-email-to').innerHTML = `<option value="all" selected>Alle: ${recipientsList}</option>`;
            document.getElementById('cleaning-email-custom-group').style.display = 'none';
            
            // Generate email content
            const monthSelect = document.getElementById('cleaning-month');
            const [year, month] = monthSelect.value.split('-').map(Number);
            const monthName = new Date(year, month - 1, 1).toLocaleDateString('de-DE', { month: 'long', year: 'numeric' });
            
            // Subject: "Reinigungsplan [Monat] Grelle Forelle"
            document.getElementById('cleaning-email-subject').value = `Reinigungsplan ${monthName} Grelle Forelle`;
            
            // Build email body from table with event-on-cleaning-day check
            const table = document.getElementById('cleaning-table-data');
            let body = `Hallo,\n\nanbei der Reinigungsplan fr ${monthName}:\n\n`;
            
            if (table) {
                // Only get checked rows
                const checkedRows = table.querySelectorAll('tbody tr:has(.cleaning-checkbox:checked)');
                checkedRows.forEach(row => {
                    const cells = row.querySelectorAll('td');
                    // Index 0 = checkbox, 1 = date, 2 = day, 3 = type, 4 = event
                    const dateStr = cells[1].textContent;
                    const day = cells[2].textContent;
                    const type = cells[3].textContent;
                    const event = cells[4].textContent;
                    
                    // Check if there's an event on this cleaning day
                    const hasEventOnCleaningDay = checkEventOnCleaningDay(dateStr);
                    
                    body += ` ${dateStr} (${day}) - ${type}\n`;
                    body += `  Nach: ${event}\n`;
                    if (hasEventOnCleaningDay) {
                        body += `   (Bitte bis 10:00 fertigstellen wegen Folgeveranstaltung)\n`;
                    }
                    body += `\n`;
                });
            }
            
            body += `Bitte um Besttigung.\n`;
            body += SCHADI_SIGNATURE;
            
            document.getElementById('cleaning-email-body').value = body;
            document.getElementById('cleaning-email-status').textContent = '';
        }
        
        // Check if there's an event on the cleaning day
        function checkEventOnCleaningDay(dateStr) {
            // Parse date string "DD.MM.YYYY"
            const parts = dateStr.split('.');
            if (parts.length !== 3) return false;
            
            const cleaningDate = new Date(parseInt(parts[2]), parseInt(parts[1]) - 1, parseInt(parts[0]));
            
            // Check bmtEvents for any event on this day
            return bmtEvents.some(event => {
                const eventDate = new Date(event.dtstart);
                return eventDate.getFullYear() === cleaningDate.getFullYear() &&
                       eventDate.getMonth() === cleaningDate.getMonth() &&
                       eventDate.getDate() === cleaningDate.getDate() &&
                       (event.category === 'eigen' || event.category === 'fremd' || event.category === 'konzert');
            });
        }
        
        
        // Quick save cleaning schedule as draft (without opening email section)
        async function quickSaveCleaningDraft() {
            if (!accessToken) {
                showToast(' Bitte zuerst mit Microsoft anmelden', true);
                return;
            }
            
            // Generate email content (same as showCleaningEmail)
            const monthSelect = document.getElementById('cleaning-month');
            const [year, month] = monthSelect.value.split('-').map(Number);
            const monthName = new Date(year, month - 1, 1).toLocaleDateString('de-DE', { month: 'long', year: 'numeric' });
            
            const subject = `Reinigungsplan ${monthName} Grelle Forelle`;
            
            // Build email body from table
            const table = document.getElementById('cleaning-table-data');
            let body = `Hallo,\n\nanbei der Reinigungsplan fr ${monthName}:\n\n`;
            
            if (table) {
                const checkedRows = table.querySelectorAll('tbody tr:has(.cleaning-checkbox:checked)');
                if (checkedRows.length === 0) {
                    showToast(' Keine Reinigungstermine ausgewhlt', true);
                    return;
                }
                checkedRows.forEach(row => {
                    const cells = row.querySelectorAll('td');
                    const dateStr = cells[1].textContent;
                    const day = cells[2].textContent;
                    const type = cells[3].textContent;
                    const event = cells[4].textContent;
                    const hasEventOnCleaningDay = checkEventOnCleaningDay(dateStr);
                    
                    body += ` ${dateStr} (${day}) - ${type}\n`;
                    body += `  Nach: ${event}\n`;
                    if (hasEventOnCleaningDay) {
                        body += `   (Bitte bis 10:00 fertigstellen wegen Folgeveranstaltung)\n`;
                    }
                    body += `\n`;
                });
            } else {
                showToast(' Kein Reinigungsplan generiert', true);
                return;
            }
            
            body += `Bitte um Besttigung.\n`;
            body += SCHADI_SIGNATURE;
            
            // Save as draft
            showToast('Speichere als Entwurf...');
            
            // Get fresh token with mail scopes
            const mailToken = await getMailToken();
            if (!mailToken) {
                showToast(' Keine Mail-Berechtigung. Bitte neu anmelden.', true);
                return;
            }
            
            const toRecipients = CLEANING_CONTACTS.map(contact => ({
                emailAddress: { address: contact.email }
            }));
            
            try {
                const response = await fetch('https://graph.microsoft.com/v1.0/me/messages', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + mailToken,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        subject: subject,
                        body: { contentType: 'Text', content: body },
                        toRecipients: toRecipients
                    })
                });
                
                if (response.ok || response.status === 201) {
                    showToast(' Entwurf in Outlook gespeichert!');
                } else {
                    const err = await response.json();
                    if (err.error?.code === 'ErrorAccessDenied' || response.status === 403) {
                        showToast(' Keine Berechtigung - bitte neu anmelden', true);
                        setTimeout(() => handleSignOut(), 1500);
                    } else {
                        showToast(' Fehler: ' + (err.error?.message || 'Unbekannt'), true);
                    }
                }
            } catch (e) {
                showToast(' Fehler: ' + e.message, true);
            }
        }
        
        function hideCleaningEmail() {
            document.getElementById('cleaning-email-section').style.display = 'none';
        }
        
        function updateCleaningEmailTo() {
            const select = document.getElementById('cleaning-email-to');
            const customGroup = document.getElementById('cleaning-email-custom-group');
            customGroup.style.display = select.value === 'custom' ? 'block' : 'none';
        }
        
        async function sendCleaningEmail() {
            const subject = document.getElementById('cleaning-email-subject').value;
            const body = document.getElementById('cleaning-email-body').value;
            const status = document.getElementById('cleaning-email-status');
            
            if (!subject || !body) {
                status.textContent = 'Bitte alle Felder ausfuellen';
                status.style.color = '#f59e0b';
                return;
            }
            
            if (!accessToken) {
                status.textContent = ' Bitte zuerst mit Microsoft anmelden';
                status.style.color = '#ef4444';
                return;
            }
            
            status.textContent = ' Sende an alle 3 Empfnger...';
            status.style.color = '#888';
            
            // Build recipients array for all 3 contacts
            const toRecipients = CLEANING_CONTACTS.map(contact => ({
                emailAddress: { address: contact.email }
            }));
            
            try {
                const response = await fetch('https://graph.microsoft.com/v1.0/me/sendMail', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + accessToken,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: {
                            subject: subject,
                            body: { contentType: 'Text', content: body },
                            toRecipients: toRecipients
                        }
                    })
                });
                
                if (response.ok || response.status === 202) {
                    status.textContent = ' E-Mail an alle 3 gesendet!';
                    status.style.color = '#22c55e';
                    showToast(' Reinigungsplan an alle 3 Empfnger gesendet!');
                    setTimeout(() => hideCleaningEmail(), 2000);
                } else {
                    const err = await response.json();
                    status.textContent = ' Fehler: ' + (err.error?.message || 'Unbekannt');
                    status.style.color = '#ef4444';
                }
            } catch (e) {
                status.textContent = ' Fehler: ' + e.message;
                status.style.color = '#ef4444';
            }
        }
        
        // Save cleaning email as draft in Outlook
        async function saveDraftCleaningEmail() {
            const subject = document.getElementById('cleaning-email-subject').value;
            const body = document.getElementById('cleaning-email-body').value;
            const status = document.getElementById('cleaning-email-status');
            
            if (!subject || !body) {
                status.textContent = 'Bitte alle Felder ausfuellen';
                status.style.color = '#f59e0b';
                return;
            }
            
            if (!accessToken) {
                status.textContent = ' Bitte zuerst mit Microsoft anmelden';
                status.style.color = '#ef4444';
                return;
            }
            
            status.textContent = 'Speichere als Entwurf...';
            status.style.color = '#888';
            
            // Get fresh token with mail scopes
            const mailToken = await getMailToken();
            if (!mailToken) {
                status.textContent = ' Keine Mail-Berechtigung. Bitte neu anmelden.';
                status.style.color = '#ef4444';
                return;
            }
            
            // Build recipients array for all 3 contacts
            const toRecipients = CLEANING_CONTACTS.map(contact => ({
                emailAddress: { address: contact.email }
            }));
            
            
            console.log('Saving cleaning draft with recipients:', toRecipients);
            try {
                // POST to /me/messages creates a draft (without sending)
                const response = await fetch('https://graph.microsoft.com/v1.0/me/messages', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + mailToken,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        subject: subject,
                        body: { contentType: 'Text', content: body },
                        toRecipients: toRecipients
                    })
                });
                
                console.log('Cleaning draft response status:', response.status);
                
                if (response.ok || response.status === 201) {
                    status.textContent = ' Entwurf gespeichert! Check deine Outlook Drafts.';
                    status.style.color = '#22c55e';
                    showToast(' Entwurf in Outlook gespeichert!');
                } else {
                    const err = await response.json();
                    console.error('Cleaning draft error:', err);
                    if (err.error?.code === 'ErrorAccessDenied' || response.status === 403) {
                        status.innerHTML = ' Keine Berechtigung. <a href="#" onclick="handleSignOut(); return false;" style="color: #3b82f6;">Bitte neu anmelden</a>';
                    } else {
                        status.textContent = ' Fehler: ' + (err.error?.message || 'Unbekannt');
                    }
                    status.style.color = '#ef4444';
                }
            } catch (e) {
                console.error('Cleaning draft exception:', e);
                status.textContent = ' Fehler: ' + e.message;
                status.style.color = '#ef4444';
            }
        }
        

        // 
        // MONTH FILTER FUNCTIONS
        // 
        
        let selectedMonths = new Set();
        
        function initMonthFilter() {
            // Default: current month selected
            const currentMonth = new Date().getMonth() + 1;
            selectedMonths.add(currentMonth);
            document.querySelectorAll('.month-cb').forEach(cb => {
                if (parseInt(cb.value) === currentMonth) {
                    cb.checked = true;
                }
            });
            updateMonthButtonLabel();
        }
        
        function toggleMonthFilter() {
            document.getElementById('month-dropdown').classList.toggle('show');
        }
        
        function selectAllMonths() {
            document.querySelectorAll('.month-cb').forEach(cb => {
                cb.checked = true;
                selectedMonths.add(parseInt(cb.value));
            });
            filterBMTByMonth();
        }
        
        function selectCurrentMonth() {
            const currentMonth = new Date().getMonth() + 1;
            document.querySelectorAll('.month-cb').forEach(cb => {
                cb.checked = parseInt(cb.value) === currentMonth;
            });
            selectedMonths.clear();
            selectedMonths.add(currentMonth);
            filterBMTByMonth();
        }
        
        function clearMonths() {
            document.querySelectorAll('.month-cb').forEach(cb => cb.checked = false);
            selectedMonths.clear();
            filterBMTByMonth();
        }
        
        function filterBMTByMonth() {
            selectedMonths.clear();
            document.querySelectorAll('.month-cb:checked').forEach(cb => {
                selectedMonths.add(parseInt(cb.value));
            });
            updateMonthButtonLabel();
            renderBMTEvents();
        }
        
        function updateMonthButtonLabel() {
            const btn = document.getElementById('month-filter-btn');
            const count = selectedMonths.size;
            if (count === 0) {
                btn.textContent = ' Keine ';
            } else if (count === 12) {
                btn.textContent = ' Alle ';
            } else if (count === 1) {
                const monthNames = ['', 'Jan', 'Feb', 'Mr', 'Apr', 'Mai', 'Jun', 'Jul', 'Aug', 'Sep', 'Okt', 'Nov', 'Dez'];
                btn.textContent = ' ' + monthNames[[...selectedMonths][0]] + ' ';
            } else {
                btn.textContent = ' ' + count + ' Monate ';
            }
        }
        
        // Close dropdown when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.bmt-month-filter')) {
                document.getElementById('month-dropdown')?.classList.remove('show');
            }
        });
        
        // 
        // CLEANING CHECKBOX FUNCTIONS
        // 
        
        function toggleCleaningRow(checkbox) {
            const row = checkbox.closest('tr');
            if (checkbox.checked) {
                row.classList.remove('cleaning-row-disabled');
            } else {
                row.classList.add('cleaning-row-disabled');
            }
            updateCleaningSummary();
        }
        
        function toggleAllCleanings(masterCheckbox) {
            const checkboxes = document.querySelectorAll('.cleaning-checkbox');
            checkboxes.forEach(cb => {
                cb.checked = masterCheckbox.checked;
                const row = cb.closest('tr');
                if (masterCheckbox.checked) {
                    row.classList.remove('cleaning-row-disabled');
                } else {
                    row.classList.add('cleaning-row-disabled');
                }
            });
            updateCleaningSummary();
        }
        
        function updateCleaningSummary() {
            const checkedRows = document.querySelectorAll('.cleaning-checkbox:checked');
            let grossCount = 0;
            let mittelCount = 0;
            
            checkedRows.forEach(cb => {
                const row = cb.closest('tr');
                if (row.dataset.type === 'gross') grossCount++;
                else mittelCount++;
            });
            
            const summaryContainer = document.getElementById('cleaning-summary');
            summaryContainer.innerHTML = `
                <div style="display: flex; justify-content: space-around; text-align: center;">
                    <div>
                        <div style="font-size: 24px; font-weight: 700; color: #ef4444;">${grossCount}</div>
                        <div style="font-size: 12px; color: #888;">GROSS</div>
                    </div>
                    <div>
                        <div style="font-size: 24px; font-weight: 700; color: #f59e0b;">${mittelCount}</div>
                        <div style="font-size: 12px; color: #888;">MITTEL</div>
                    </div>
                    <div>
                        <div style="font-size: 24px; font-weight: 700; color: #22c55e;">${grossCount + mittelCount}</div>
                        <div style="font-size: 12px; color: #888;">AUSGEWHLT</div>
                    </div>
                </div>
            `;
        }
        
        // 
        // QUICK NOTES - CREATE NEW TASK
        // 
        
        async function createNewTask() {
            clearTimeout(notesTimeout); // Prevent race condition with saveQuickNotes
            const text = document.getElementById('quick-notes-text').value.trim();
            if (!text) {
                showToast(' Bitte erst Text eingeben', true);
                return;
            }
            
            if (!accessToken) {
                showToast(' Bitte zuerst anmelden', true);
                return;
            }
            
            try {
                const listId = await getOrCreateNotesList();
                if (!listId) {
                    showToast(' Notes Liste nicht gefunden', true);
                    return;
                }
                
                // Create new task with timestamp
                const now = new Date();
                const timestamp = now.toLocaleString('de-DE', { 
                    day: '2-digit', month: '2-digit', year: 'numeric',
                    hour: '2-digit', minute: '2-digit'
                });
                
                const response = await fetch(`https://graph.microsoft.com/v1.0/me/todo/lists/${listId}/tasks`, {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + accessToken,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        title: text.substring(0, 100) + (text.length > 100 ? '...' : ''),
                        body: {
                            content: text + '\n\n---\nErstellt: ' + timestamp,
                            contentType: 'text'
                        }
                    })
                });
                
                if (response.ok) {
                    showToast(' Task erstellt!');
                    document.getElementById('quick-notes-text').value = '';
                    localStorage.removeItem('workhub-quick-notes');
                    localStorage.setItem('workhub-notes-task-created', 'true');
                    
                    // Also clear the sync task "Work Hub Quick Notes" in To Do
                    try {
                        const syncTaskResponse = await fetch(
                            `https://graph.microsoft.com/v1.0/me/todo/lists/${listId}/tasks?$filter=title eq 'Work Hub Quick Notes'`,
                            { headers: { 'Authorization': 'Bearer ' + accessToken } }
                        );
                        const syncTaskData = await syncTaskResponse.json();
                        if (syncTaskData.value && syncTaskData.value.length > 0) {
                            const syncTaskId = syncTaskData.value[0].id;
                            await fetch(
                                `https://graph.microsoft.com/v1.0/me/todo/lists/${listId}/tasks/${syncTaskId}`,
                                {
                                    method: 'PATCH',
                                    headers: {
                                        'Authorization': 'Bearer ' + accessToken,
                                        'Content-Type': 'application/json'
                                    },
                                    body: JSON.stringify({ body: { content: '', contentType: 'text' } })
                                }
                            );
                            console.log('Sync task cleared');
                        }
                    } catch (syncErr) { console.log('Could not clear sync task:', syncErr); }
                } else {
                    showToast(' Fehler beim Erstellen', true);
                }
            } catch (err) {
                console.error('Create task error:', err);
                showToast(' Fehler: ' + err.message, true);
            }
        }
        

        // 
        // UPCOMING EVENTS AUTO-UPDATE
        // 
        
        function getWeekNumber(date) {
            const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
            const dayNum = d.getUTCDay() || 7;
            d.setUTCDate(d.getUTCDate() + 4 - dayNum);
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
        }
        
        function updateUpcomingEvents() {
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const currentKW = getWeekNumber(now);
            
            // Update KW label
            const kwLabel = document.getElementById('upcoming-week-label');
            if (kwLabel) {
                kwLabel.innerHTML = ' DIESE WOCHE (KW ' + currentKW + ')';
            }
            
            // Get all event cards with data-date
            const eventCards = document.querySelectorAll('.event-card[data-date]');
            let visibleCount = 0;
            
            eventCards.forEach(card => {
                const eventDateStr = card.getAttribute('data-date');
                const eventDate = new Date(eventDateStr + 'T23:59:59');
                
                if (eventDate < today) {
                    card.style.display = 'none';
                    console.log('Hidden past event:', card.id, eventDateStr);
                } else {
                    card.style.display = 'block';
                    visibleCount++;
                    
                    const daysUntil = Math.ceil((new Date(eventDateStr) - today) / (1000 * 60 * 60 * 24));
                    const daysText = daysUntil === 0 ? 'HEUTE' : daysUntil === 1 ? '1 Tag' : daysUntil + ' Tage';
                    
                    const daysSpan = card.querySelector('.vvk-days');
                    if (daysSpan) {
                        daysSpan.textContent = daysText;
                        if (daysUntil <= 1) {
                            daysSpan.style.color = '#ef4444';
                            daysSpan.style.fontWeight = 'bold';
                        }
                    }
                }
            });
            
            const upcomingSection = document.querySelector('.upcoming-events');
            if (visibleCount === 0 && upcomingSection) {
                const existingMsg = document.getElementById('no-upcoming-msg');
                if (!existingMsg) {
                    const msg = document.createElement('div');
                    msg.id = 'no-upcoming-msg';
                    msg.style.cssText = 'text-align: center; padding: 20px; color: #888; font-size: 14px;';
                    msg.innerHTML = ' Keine anstehenden Events. Nchste Events in BMT Calendar.';
                    upcomingSection.appendChild(msg);
                }
            }
            
            console.log('Upcoming Events updated:', visibleCount, 'visible, KW', currentKW);
        }
        
        // ============================================
        // BAR STAFFING MODULE
        // ============================================
        
        // Default Roster (saved to localStorage)
        const DEFAULT_BAR_ROSTER = [
            { prio: 1, name: "Yohanna", due_shifts: "6-8", weekdays_x: false, no_ds: false },
            { prio: 1, name: "Ada", due_shifts: "6-8", weekdays_x: false, no_ds: false },
            { prio: 1, name: "Kamil", due_shifts: "6-8", weekdays_x: true, no_ds: false },
            { prio: 1, name: "Milos", due_shifts: "6", weekdays_x: false, no_ds: false },
            { prio: 1, name: "Dora", due_shifts: "4", weekdays_x: true, no_ds: true },
            { prio: 2, name: "Martina", due_shifts: "4-6", weekdays_x: false, no_ds: false },
            { prio: 2, name: "Ivo", due_shifts: "4-6", weekdays_x: false, no_ds: true },
            { prio: 2, name: "Jessi", due_shifts: "4", weekdays_x: false, no_ds: false },
            { prio: 2, name: "Camillo", due_shifts: "4", weekdays_x: true, no_ds: true },
            { prio: 2, name: "Lino", due_shifts: "4", weekdays_x: false, no_ds: false }
        ];

        // Load roster from localStorage or use default
        let barRoster = JSON.parse(localStorage.getItem('barRoster')) || JSON.parse(JSON.stringify(DEFAULT_BAR_ROSTER));

        // Position definitions
        const BAR_ALL_POSITIONS = ["TERRASSE", "KITCHEN", "MAIN 1", "MAIN 2", "MAIN 3", "MAIN 4"];
        const BAR_CONCERT_POSITIONS = ["MAIN 1", "MAIN 2", "MAIN 3", "MAIN 4"];

        // Uploaded availability data
        let uploadedAvailability = null;

        // Tab switching
        function switchBarTab(tab) {
            document.querySelectorAll('.bar-tab').forEach(t => t.classList.remove('active'));
            document.getElementById('tab-' + tab).classList.add('active');
            document.querySelectorAll('.bar-tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById('content-' + tab).classList.add('active');
            if (tab === 'roster') renderBarRoster();
        }

        // Update events preview based on selected months
        function updateBarEventsPreview() {
            const selectedMonths = Array.from(document.querySelectorAll('.bar-month-check:checked')).map(cb => parseInt(cb.value));
            const year = parseInt(document.getElementById('bar-year').value);
            const previewContainer = document.getElementById('bar-events-preview');
            
            if (selectedMonths.length === 0) {
                previewContainer.innerHTML = '<p style="color: #6b7280;">Whle Monat(e) um Events zu sehen...</p>';
                return;
            }
            
            if (!bmtEvents || bmtEvents.length === 0) {
                previewContainer.innerHTML = '<p style="color: #ef4444;"> Bitte zuerst BMT Events laden!</p>';
                return;
            }
            
            const events = getBarEventsForMonths(selectedMonths, year);
            
            if (events.length === 0) {
                previewContainer.innerHTML = '<p style="color: #f59e0b;">Keine Events fr ausgewhlte Monate gefunden.</p>';
                return;
            }
            
            let html = `<p style="margin-bottom: 10px; color: #22c55e;"> ${events.length} Events gefunden:</p>`;
            events.forEach(e => {
                const typeClass = e.type === 'Konzert' ? 'konzert' : (e.type === 'Eigen' ? 'eigen' : 'club');
                html += `<div class="bar-preview-event">
                    <span class="date">${e.date}</span>
                    <span class="day">${e.day}</span>
                    <span class="name">${e.event}</span>
                    <span class="type ${typeClass}">${e.type}</span>
                </div>`;
            });
            previewContainer.innerHTML = html;
        }

        // Get events for selected months from BMT
        function getBarEventsForMonths(months, year) {
            const dayNames = ['Sonntag', 'Montag', 'Dienstag', 'Mittwoch', 'Donnerstag', 'Freitag', 'Samstag'];
            const events = [];
            
            bmtEvents.forEach(e => {
                const eventDate = e.dtstart instanceof Date ? e.dtstart : new Date(e.dtstart);
                if (isNaN(eventDate.getTime())) return;
                
                const eventMonth = eventDate.getMonth() + 1;
                const eventYear = eventDate.getFullYear();
                
                if (!months.includes(eventMonth) || eventYear !== year) return;
                
                const summaryLower = (e.summary || '').toLowerCase();
                const category = (e.category || '').toLowerCase();
                
                // Filter out non-events
                if (category === 'feiertag' || category === 'holiday' || summaryLower.includes('holiday')) return;
                if (summaryLower.includes('geschlossen') || summaryLower.includes('closed')) return;
                if (category === 'specials' && !summaryLower.includes('turbo')) return;
                
                // Determine type
                let type = 'Club';
                if (category === 'newdealkonzert' || summaryLower.startsWith('c:') || summaryLower.startsWith('o:')) {
                    type = 'Konzert';
                } else if (category === 'eigenveranstaltung' || summaryLower.includes('turbo') || summaryLower.includes('halloween') || summaryLower.includes('nye') || summaryLower.includes('selected')) {
                    type = 'Eigen';
                } else if (category !== 'fremdveranstaltung' && category !== 'eigenveranstaltung' && !category.includes('fremd') && !category.includes('eigen')) {
                    return;
                }
                
                events.push({
                    date: eventDate.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit', year: 'numeric' }),
                    day: dayNames[eventDate.getDay()],
                    event: e.summary,
                    type: type,
                    dateObj: eventDate
                });
            });
            
            events.sort((a, b) => a.dateObj - b.dateObj);
            return events;
        }

        // Generate Availability Sheet Excel
        function generateAvailabilitySheet() {
            const selectedMonths = Array.from(document.querySelectorAll('.bar-month-check:checked')).map(cb => parseInt(cb.value));
            const year = parseInt(document.getElementById('bar-year').value);
            
            if (selectedMonths.length === 0) {
                showToast(' Bitte mindestens einen Monat auswhlen!', true);
                return;
            }
            
            const events = getBarEventsForMonths(selectedMonths, year);
            
            if (events.length === 0) {
                showToast(' Keine Events fr ausgewhlte Monate!', true);
                return;
            }
            
            const wb = XLSX.utils.book_new();
            const monthNames = ['', 'Jan', 'Feb', 'Mar', 'Apr', 'Mai', 'Jun', 'Jul', 'Aug', 'Sep', 'Okt', 'Nov', 'Dez'];
            const monthStr = selectedMonths.map(m => monthNames[m]).join('+');
            
            const wsData = [
                [`Availability ${monthStr}/${year}`],
                ['DATE', 'DAY', 'EVENT', 'TYPE', 'FREI 1', 'FREI 2', 'OPT 1 (NEED CONFIRM)', 'OPT 2 (NEED CONFIRM)']
            ];
            
            events.forEach(e => {
                wsData.push([e.date, e.day, e.event, e.type, '', '', '', '']);
            });
            
            const ws = XLSX.utils.aoa_to_sheet(wsData);
            ws['!cols'] = [{ wch: 12 }, { wch: 12 }, { wch: 25 }, { wch: 10 }, { wch: 12 }, { wch: 12 }, { wch: 22 }, { wch: 22 }];
            XLSX.utils.book_append_sheet(wb, ws, 'Availability');
            
            // Add Roster sheet
            const rosterData = [['ROSTER - DO NOT EDIT'], ['PRIO', 'NAME', 'DUE_SHIFTS', 'WEEKDAYS_X', 'NO_DS']];
            barRoster.forEach(r => {
                rosterData.push([r.prio, r.name, r.due_shifts, r.weekdays_x ? 'x' : '', r.no_ds ? 'x' : '']);
            });
            const wsRoster = XLSX.utils.aoa_to_sheet(rosterData);
            wsRoster['!cols'] = [{ wch: 6 }, { wch: 15 }, { wch: 12 }, { wch: 12 }, { wch: 8 }];
            XLSX.utils.book_append_sheet(wb, wsRoster, 'Roster');
            
            const fileName = `Bar_Availability_${monthStr}_${year}.xlsx`;
            XLSX.writeFile(wb, fileName);
            showToast(` ${fileName} downloaded!`);
        }

        // Handle availability upload
        function handleAvailabilityUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    const ws = workbook.Sheets['Availability'];
                    if (!ws) throw new Error('Availability sheet not found!');
                    
                    const jsonData = XLSX.utils.sheet_to_json(ws, { header: 1 });
                    uploadedAvailability = parseBarAvailabilityData(jsonData);
                    
                    const statusDiv = document.getElementById('bar-availability-status');
                    statusDiv.className = 'bar-status success';
                    statusDiv.style.display = 'block';
                    statusDiv.innerHTML = `<p> <strong>${file.name}</strong> erfolgreich geladen!</p>
                        <p>${uploadedAvailability.events.length} Events gefunden</p>
                        <p>${uploadedAvailability.unavailable.length} Abwesenheiten eingetragen</p>`;
                    
                    showBarShiftplanPreview();
                    document.getElementById('btn-generate-shiftplan').style.display = 'block';
                    
                } catch (err) {
                    console.error('Error parsing file:', err);
                    const statusDiv = document.getElementById('bar-availability-status');
                    statusDiv.className = 'bar-status error';
                    statusDiv.style.display = 'block';
                    statusDiv.innerHTML = `<p> Fehler: ${err.message}</p>`;
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // Parse availability data from Excel
        function parseBarAvailabilityData(jsonData) {
            const events = [];
            const unavailable = [];
            
            for (let i = 2; i < jsonData.length; i++) {
                const row = jsonData[i];
                if (!row || !row[0]) continue;
                
                events.push({ date: row[0], day: row[1], event: row[2], type: row[3] || 'Club' });
                
                const frei1 = row[4] ? row[4].toString().trim() : '';
                const frei2 = row[5] ? row[5].toString().trim() : '';
                const opt1 = row[6] ? row[6].toString().trim() : '';
                const opt2 = row[7] ? row[7].toString().trim() : '';
                
                if (frei1) unavailable.push({ date: row[0], name: frei1, type: 'FREI' });
                if (frei2) unavailable.push({ date: row[0], name: frei2, type: 'FREI' });
                if (opt1) unavailable.push({ date: row[0], name: opt1, type: 'OPT' });
                if (opt2) unavailable.push({ date: row[0], name: opt2, type: 'OPT' });
            }
            
            return { events, unavailable };
        }

        // Show shiftplan preview
        function showBarShiftplanPreview() {
            const previewDiv = document.getElementById('bar-shiftplan-preview');
            previewDiv.style.display = 'block';
            
            let html = '<h4 style="margin-bottom: 10px;">Preview:</h4><div style="max-height: 200px; overflow-y: auto;">';
            uploadedAvailability.events.forEach(e => {
                const typeClass = e.type === 'Konzert' ? 'konzert' : (e.type === 'Eigen' ? 'eigen' : 'club');
                html += `<div class="bar-preview-event">
                    <span class="date">${e.date}</span>
                    <span class="day">${e.day}</span>
                    <span class="name">${e.event}</span>
                    <span class="type ${typeClass}">${e.type}</span>
                </div>`;
            });
            html += '</div>';
            
            if (uploadedAvailability.unavailable.length > 0) {
                html += '<h4 style="margin: 15px 0 10px;">Abwesenheiten:</h4><div style="display: flex; flex-wrap: wrap; gap: 5px;">';
                uploadedAvailability.unavailable.forEach(u => {
                    const color = u.type === 'FREI' ? '#ef4444' : '#f59e0b';
                    html += `<span style="background: ${color}; padding: 2px 8px; border-radius: 4px; font-size: 11px;">${u.name} (${u.date})</span>`;
                });
                html += '</div>';
            }
            previewDiv.innerHTML = html;
        }

        // Generate Shiftplan
        function generateShiftplan() {
            if (!uploadedAvailability) {
                showToast(' Bitte zuerst Availability Sheet hochladen!', true);
                return;
            }
            
            const events = uploadedAvailability.events;
            const unavailable = uploadedAvailability.unavailable;
            
            // Tracking
            const shiftsTotal = {}, shiftsClub = {}, shiftsConcert = {}, positionsWorked = {}, lastWorked = {};
            barRoster.forEach(r => {
                shiftsTotal[r.name] = 0;
                shiftsClub[r.name] = 0;
                shiftsConcert[r.name] = 0;
                positionsWorked[r.name] = {};
                BAR_ALL_POSITIONS.forEach(p => positionsWorked[r.name][p] = 0);
                lastWorked[r.name] = null;
            });
            
            function isWeekend(day) { return day === 'Freitag' || day === 'Samstag'; }
            function isUnavailable(name, date) {
                return unavailable.some(u => u.name.toLowerCase() === name.toLowerCase() && u.date === date && u.type === 'FREI');
            }
            function canWorkHardRules(person, day, date) {
                if (isUnavailable(person.name, date)) return false;
                if (person.weekdays_x && !isWeekend(day)) return false;
                return true;
            }
            function sortCandidates(candidates, position) {
                return candidates.sort((a, b) => {
                    const rotA = positionsWorked[a.name][position] || 0;
                    const rotB = positionsWorked[b.name][position] || 0;
                    if (rotA !== rotB) return rotA - rotB;
                    const totalA = shiftsTotal[a.name], totalB = shiftsTotal[b.name];
                    if (totalA !== totalB) return totalA - totalB;
                    return a.prio - b.prio;
                });
            }
            
            const assignments = [];
            
            events.forEach((event, eventIdx) => {
                const isConcert = event.type === 'Konzert';
                const positions = isConcert ? BAR_CONCERT_POSITIONS : BAR_ALL_POSITIONS;
                const assignment = { date: event.date, day: event.day, event: event.event, type: event.type, positions: {} };
                
                BAR_ALL_POSITIONS.forEach(p => assignment.positions[p] = isConcert && !BAR_CONCERT_POSITIONS.includes(p) ? '-' : '');
                
                const assignedThisEvent = [];
                
                positions.forEach(position => {
                    let candidates = barRoster.filter(p => !assignedThisEvent.includes(p.name) && canWorkHardRules(p, event.day, event.date));
                    if (candidates.length === 0) {
                        candidates = barRoster.filter(p => !assignedThisEvent.includes(p.name) && !isUnavailable(p.name, event.date));
                    }
                    candidates = sortCandidates(candidates, position);
                    
                    if (candidates.length > 0) {
                        const person = candidates[0];
                        assignment.positions[position] = person.name;
                        shiftsTotal[person.name]++;
                        if (isConcert) shiftsConcert[person.name]++; else shiftsClub[person.name]++;
                        positionsWorked[person.name][position]++;
                        lastWorked[person.name] = eventIdx;
                        assignedThisEvent.push(person.name);
                    } else {
                        assignment.positions[position] = '???';
                    }
                });
                assignments.push(assignment);
            });
            
            // Create Excel
            const wb = XLSX.utils.book_new();
            
            const wsData = [['BAR SHIFTPLAN'], ['DATUM', 'TAG', 'EVENT', 'TERRASSE', 'KITCHEN', 'MAIN 1', 'MAIN 2', 'MAIN 3', 'MAIN 4']];
            assignments.forEach(a => {
                wsData.push([a.date, a.day, a.event, a.positions['TERRASSE'], a.positions['KITCHEN'], a.positions['MAIN 1'], a.positions['MAIN 2'], a.positions['MAIN 3'], a.positions['MAIN 4']]);
            });
            const ws = XLSX.utils.aoa_to_sheet(wsData);
            ws['!cols'] = [{ wch: 12 }, { wch: 12 }, { wch: 22 }, { wch: 12 }, { wch: 12 }, { wch: 12 }, { wch: 12 }, { wch: 12 }, { wch: 12 }];
            XLSX.utils.book_append_sheet(wb, ws, 'Shiftplan');
            
            const summaryData = [['SHIFT SUMMARY'], ['NAME', 'PRIO', 'DUE', 'CLUB', 'CONCERT', 'TOTAL', 'TERRASSE', 'KITCHEN', 'MAIN 1', 'MAIN 2', 'MAIN 3', 'MAIN 4']];
            barRoster.forEach(r => {
                summaryData.push([r.name, r.prio, r.due_shifts, shiftsClub[r.name], shiftsConcert[r.name], shiftsTotal[r.name],
                    positionsWorked[r.name]['TERRASSE'], positionsWorked[r.name]['KITCHEN'], positionsWorked[r.name]['MAIN 1'],
                    positionsWorked[r.name]['MAIN 2'], positionsWorked[r.name]['MAIN 3'], positionsWorked[r.name]['MAIN 4']]);
            });
            const wsSummary = XLSX.utils.aoa_to_sheet(summaryData);
            XLSX.utils.book_append_sheet(wb, wsSummary, 'Summary');
            
            const fileName = `Bar_Shiftplan_${events[0].date.split('.')[1]}_${events[0].date.split('.')[2]}.xlsx`;
            XLSX.writeFile(wb, fileName);
            showToast(` ${fileName} downloaded!`);
        }

        // Render roster table
        function renderBarRoster() {
            const tbody = document.getElementById('bar-roster-body');
            tbody.innerHTML = '';
            barRoster.forEach((r, idx) => {
                tbody.innerHTML += `<tr>
                    <td><select onchange="updateBarRoster(${idx}, 'prio', parseInt(this.value))">
                        <option value="1" ${r.prio === 1 ? 'selected' : ''}>1</option>
                        <option value="2" ${r.prio === 2 ? 'selected' : ''}>2</option>
                    </select></td>
                    <td><input type="text" value="${r.name}" onchange="updateBarRoster(${idx}, 'name', this.value)"></td>
                    <td><input type="text" value="${r.due_shifts}" onchange="updateBarRoster(${idx}, 'due_shifts', this.value)" style="width: 60px;"></td>
                    <td><input type="checkbox" ${r.weekdays_x ? 'checked' : ''} onchange="updateBarRoster(${idx}, 'weekdays_x', this.checked)"></td>
                    <td><input type="checkbox" ${r.no_ds ? 'checked' : ''} onchange="updateBarRoster(${idx}, 'no_ds', this.checked)"></td>
                    <td><button class="bar-roster-delete" onclick="deleteBarRosterMember(${idx})"></button></td>
                </tr>`;
            });
        }

        function updateBarRoster(idx, field, value) { barRoster[idx][field] = value; }
        function addRosterMember() { barRoster.push({ prio: 2, name: 'New', due_shifts: '4', weekdays_x: false, no_ds: false }); renderBarRoster(); }
        function deleteBarRosterMember(idx) { if (confirm(`${barRoster[idx].name} wirklich lschen?`)) { barRoster.splice(idx, 1); renderBarRoster(); } }
        function saveBarRoster() { localStorage.setItem('barRoster', JSON.stringify(barRoster)); showToast(' Roster gespeichert!'); }
        function resetBarRoster() { if (confirm('Roster auf Default zurcksetzen?')) { barRoster = JSON.parse(JSON.stringify(DEFAULT_BAR_ROSTER)); renderBarRoster(); saveBarRoster(); } }

        // Drag and drop for upload zone
        setTimeout(() => {
            const uploadZone = document.getElementById('bar-upload-zone');
            if (uploadZone) {
                uploadZone.addEventListener('dragover', (e) => { e.preventDefault(); uploadZone.classList.add('dragover'); });
                uploadZone.addEventListener('dragleave', () => { uploadZone.classList.remove('dragover'); });
                uploadZone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    uploadZone.classList.remove('dragover');
                    const file = e.dataTransfer.files[0];
                    if (file) handleAvailabilityUpload({ target: { files: [file] } });
                });
            }
        }, 1000);
        
        // CALENDAR SECTION
        let calendarMonth = new Date().getMonth();
        let calendarYear = new Date().getFullYear();
        let calendarEntries = { eigen: [], fremd: [], konzert: [], bmt: [], technik: [], outlook: [], feiertag: [] };
        
        function toggleCalendarSection() {
            const header = document.querySelector('.calendar-section-header');
            const container = document.getElementById('calendar-container');
            const toggle = document.getElementById('calendar-toggle');
            
            if (container.classList.contains('calendar-collapsed')) {
                container.classList.remove('calendar-collapsed');
                container.classList.add('calendar-expanded');
                header.classList.remove('collapsed');
                toggle.classList.add('open');
                renderCalendar();
                loadCalendarData();
            } else {
                container.classList.add('calendar-collapsed');
                container.classList.remove('calendar-expanded');
                header.classList.add('collapsed');
                toggle.classList.remove('open');
            }
        }
        
        function changeCalendarMonth(delta) {
            calendarMonth += delta;
            if (calendarMonth > 11) { calendarMonth = 0; calendarYear++; }
            if (calendarMonth < 0) { calendarMonth = 11; calendarYear--; }
            renderCalendar();
            loadCalendarData();
        }
        
        async function loadCalendarData() {
            // Load BMT from localStorage (same source as Upcoming Events)
            const bmtData = localStorage.getItem('bmtEvents');
            if (bmtData) {
                try {
                    const parsed = JSON.parse(bmtData);
                    
                    // Helper to map event data
                    const mapEvent = (e) => {
                        const dateObj = new Date(e.dtstart);
                        const dateStr = dateObj.toISOString().split('T')[0];
                        const timeStr = dateObj.toLocaleTimeString('de-AT', { hour: '2-digit', minute: '2-digit' });
                        return {
                            title: e.summary || e.title || e.name,
                            date: dateStr,
                            time: timeStr
                        };
                    };
                    
                    // Eigen events (green)
                    calendarEntries.eigen = parsed.filter(e => e.category === 'eigen').map(mapEvent);
                    console.log('Eigen loaded:', calendarEntries.eigen.length);
                    
                    // Fremd events (blue)
                    calendarEntries.fremd = parsed.filter(e => e.category === 'fremd').map(mapEvent);
                    console.log('Fremd loaded:', calendarEntries.fremd.length);
                    
                    // Konzert events (purple)
                    calendarEntries.konzert = parsed.filter(e => e.category === 'konzert').map(mapEvent);
                    console.log('Konzert loaded:', calendarEntries.konzert.length);
                    
                    // BMT Specials (orange)
                    calendarEntries.bmt = parsed.filter(e => e.category === 'special').map(mapEvent);
                    console.log('Specials loaded:', calendarEntries.bmt.length);
                    
                    // Feiertag / Holidays (red)
                    calendarEntries.feiertag = parsed.filter(e => e.category === 'holiday' || e.category === 'feiertag').map(mapEvent);
                    console.log('Feiertag loaded:', calendarEntries.feiertag.length);
                    
                } catch (err) { console.log('BMT parse error:', err); }
            }
            
            // Load Technikerkalender from SHIFTPLAN_DATABASE
            calendarEntries.technik = [];
            for (const dateStr in SHIFTPLAN_DATABASE) {
                const data = SHIFTPLAN_DATABASE[dateStr];
                if (data.technik) {
                    // Convert DD.MM.YYYY to YYYY-MM-DD
                    const parts = dateStr.split('.');
                    const isoDate = `${parts[2]}-${parts[1].padStart(2, '0')}-${parts[0].padStart(2, '0')}`;
                    calendarEntries.technik.push({
                        title: data.technik,
                        date: isoDate,
                        source: 'technik'
                    });
                }
            }
            console.log('Technik entries loaded:', calendarEntries.technik.length);
            
            // Load Sputnik Reservations from Google Calendar (public iCal)
            try {
                const sputnikCalId = '355f939de7df075c2527053dadea64b9ba41a6916d7e1917043623230b6b7451@group.calendar.google.com';
                const icsUrl = `https://calendar.google.com/calendar/ical/${encodeURIComponent(sputnikCalId)}/public/basic.ics`;
                
                const response = await fetch(icsUrl);
                if (response.ok) {
                    const icsData = await response.text();
                    const sputnikEvents = parseICS(icsData);
                    calendarEntries.sputnik = sputnikEvents.map(e => {
                        const dateObj = new Date(e.dtstart);
                        return {
                            title: e.summary || 'Reservation',
                            date: dateObj.toISOString().split('T')[0],
                            source: 'sputnik'
                        };
                    });
                    console.log('Sputnik entries loaded:', calendarEntries.sputnik.length);
                }
            } catch (err) {
                console.log('Sputnik calendar load failed (CORS?):', err);
            }
            
            // Load Outlook calendar if logged in (skip for now - needs Calendar.Read scope)
            // TODO: Enable when Calendar.Read permission added
            /*
            if (accessToken) {
                try {
                    const startDate = new Date(calendarYear, calendarMonth, 1).toISOString();
                    const endDate = new Date(calendarYear, calendarMonth + 1, 0, 23, 59, 59).toISOString();
                    
                    const response = await fetch(
                        `https://graph.microsoft.com/v1.0/me/calendar/events?$filter=start/dateTime ge '${startDate}' and start/dateTime le '${endDate}'&$select=subject,start,end&$top=50`,
                        { headers: { 'Authorization': 'Bearer ' + accessToken } }
                    );
                    
                    if (response.ok) {
                        const data = await response.json();
                        calendarEntries.outlook = (data.value || []).map(e => ({
                            title: e.subject,
                            date: e.start.dateTime.split('T')[0],
                            time: e.start.dateTime.split('T')[1].substring(0, 5),
                            source: 'outlook'
                        }));
                    }
                } catch (err) { console.log('Outlook calendar error:', err); }
            }
            */
            
            renderCalendar();
        }
        
        function renderCalendar() {
            const grid = document.getElementById('calendar-grid');
            const titleEl = document.getElementById('calendar-month-title');
            
            const monthNames = ['Januar', 'Februar', 'Mrz', 'April', 'Mai', 'Juni', 
                               'Juli', 'August', 'September', 'Oktober', 'November', 'Dezember'];
            const dayNames = ['Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa', 'So'];
            
            titleEl.textContent = `${monthNames[calendarMonth]} ${calendarYear}`;
            
            // Get filter states
            const showEigen = document.getElementById('filter-eigen').checked;
            const showFremd = document.getElementById('filter-fremd').checked;
            const showKonzert = document.getElementById('filter-konzert').checked;
            const showBmt = document.getElementById('filter-bmt').checked;
            const showTechnik = document.getElementById('filter-technik').checked;
            const showOutlook = document.getElementById('filter-outlook').checked;
            const showFeiertag = document.getElementById('filter-feiertag').checked;
            
            // Build calendar grid
            let html = dayNames.map(d => `<div class="calendar-day-header">${d}</div>`).join('');
            
            const firstDay = new Date(calendarYear, calendarMonth, 1);
            const lastDay = new Date(calendarYear, calendarMonth + 1, 0);
            const today = new Date();
            
            // Adjust for Monday start (0 = Monday, 6 = Sunday)
            let startOffset = firstDay.getDay() - 1;
            if (startOffset < 0) startOffset = 6;
            
            // Previous month days
            const prevMonthLast = new Date(calendarYear, calendarMonth, 0).getDate();
            for (let i = startOffset - 1; i >= 0; i--) {
                html += `<div class="calendar-day other-month"><span class="calendar-day-number">${prevMonthLast - i}</span></div>`;
            }
            
            // Current month days
            for (let day = 1; day <= lastDay.getDate(); day++) {
                const dateStr = `${calendarYear}-${String(calendarMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const isToday = today.getDate() === day && today.getMonth() === calendarMonth && today.getFullYear() === calendarYear;
                
                // Get entries for this day
                let entriesHtml = '';
                
                // Feiertag (red) - show first
                if (showFeiertag) {
                    calendarEntries.feiertag.filter(e => e.date === dateStr || matchDateFormat(e.date, day, calendarMonth, calendarYear))
                        .forEach(e => { entriesHtml += `<div class="calendar-entry feiertag" title="${e.title}">${e.title}</div>`; });
                }
                // Eigen (green)
                if (showEigen) {
                    calendarEntries.eigen.filter(e => e.date === dateStr || matchDateFormat(e.date, day, calendarMonth, calendarYear))
                        .forEach(e => { entriesHtml += `<div class="calendar-entry eigen" title="${e.title}">${e.time ? e.time + ' ' : ''}${e.title}</div>`; });
                }
                // Fremd (blue)
                if (showFremd) {
                    calendarEntries.fremd.filter(e => e.date === dateStr || matchDateFormat(e.date, day, calendarMonth, calendarYear))
                        .forEach(e => { entriesHtml += `<div class="calendar-entry fremd" title="${e.title}">${e.time ? e.time + ' ' : ''}${e.title}</div>`; });
                }
                // Konzert (purple)
                if (showKonzert) {
                    calendarEntries.konzert.filter(e => e.date === dateStr || matchDateFormat(e.date, day, calendarMonth, calendarYear))
                        .forEach(e => { entriesHtml += `<div class="calendar-entry konzert" title="${e.title}">${e.time ? e.time + ' ' : ''}${e.title}</div>`; });
                }
                // Specials (orange)
                if (showBmt) {
                    calendarEntries.bmt.filter(e => e.date === dateStr || matchDateFormat(e.date, day, calendarMonth, calendarYear))
                        .forEach(e => { entriesHtml += `<div class="calendar-entry bmt" title="${e.title}">${e.time ? e.time + ' ' : ''}${e.title}</div>`; });
                }
                // Technik (brown)
                if (showTechnik) {
                    calendarEntries.technik.filter(e => e.date === dateStr)
                        .forEach(e => { entriesHtml += `<div class="calendar-entry technik" title="${e.title}">${e.title}</div>`; });
                }
                // Outlook (gray)
                if (showOutlook) {
                    calendarEntries.outlook.filter(e => e.date === dateStr)
                        .forEach(e => { entriesHtml += `<div class="calendar-entry outlook" title="${e.title}">${e.time ? e.time + ' ' : ''}${e.title}</div>`; });
                }
                
                html += `<div class="calendar-day${isToday ? ' today' : ''}">
                    <span class="calendar-day-number">${day}</span>
                    ${entriesHtml}
                </div>`;
            }
            
            // Next month days to fill grid
            const totalCells = startOffset + lastDay.getDate();
            const remaining = totalCells % 7 === 0 ? 0 : 7 - (totalCells % 7);
            for (let i = 1; i <= remaining; i++) {
                html += `<div class="calendar-day other-month"><span class="calendar-day-number">${i}</span></div>`;
            }
            
            grid.innerHTML = html;
        }
        
        function matchDateFormat(dateStr, day, month, year) {
            if (!dateStr) return false;
            // Handle DD.MM.YYYY format
            const parts = dateStr.split('.');
            if (parts.length === 3) {
                return parseInt(parts[0]) === day && parseInt(parts[1]) === (month + 1) && parseInt(parts[2]) === year;
            }
            return false;
        }
        
        // INIT
        // 
        
        document.addEventListener('DOMContentLoaded', () => {
            console.log('Work Hub v15.2.3 - Calendar Improvements + Compact Technik');
            loadQuickNotes();
            initMsal();
            updateProjection('turbo');
            updateProjection('nye');
            calculatePreSale();
            calculateCosts();
            updateProjectorData();
            updateFactsheetPreview();
            refreshBMTFromStorage();
            populateFactsheetDropdown();
            
            initMonthFilter();
            updateUpcomingEvents();
            
            // Initialize NYE tools when modals open
            document.getElementById('nye-projector-modal').addEventListener('transitionend', calculateNYE);
            document.getElementById('peak-grid-modal').addEventListener('transitionend', renderPeakGrid);
            
            // Pre-calculate for immediate display
            setTimeout(() => {
                calculateNYE();
                renderPeakGrid();
                renderTechnikCalendar();
                renderRunnerShiftplan();
            }, 100);
        });
    </script>
</body>
</html>
